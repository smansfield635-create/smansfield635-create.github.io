<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
</head>
<body class="bg-gradient">
<main class="page">

  <section class="panel hero">
    <h1>Control</h1>
    <p class="subtitle">Live read-only gauges. Color = intensity. Badge = health.</p>
  </section>

  <section class="panel">
    <h2>Live gauge</h2>
    <p class="muted">
      Source is the Worker “Truth” endpoint. Page polls periodically and renders the latest payload.
    </p>

    <div id="liveSummary" class="panel inset">
      <div class="row"><strong>HEALTH:</strong> <span id="healthBadge" class="badge">—</span></div>
      <div class="row"><strong>Truth:</strong> <span id="truthUrl" class="mono">—</span></div>
      <div class="row"><strong>Polling:</strong> <span id="polling" class="mono">—</span></div>
      <div class="row"><strong>Last updated:</strong> <span id="lastUpdated" class="mono">—</span></div>
      <div class="row"><strong>Age (sec):</strong> <span id="ageSec" class="mono">—</span></div>
    </div>
  </section>

  <section class="panel">
    <h2>Gauges (to scale)</h2>
    <div id="gauges" class="stack"></div>
    <p class="muted small">
      Bars share one scale (max value across metrics + sources in this payload). Color is intensity: red → yellow → green.
    </p>
  </section>

  <section class="panel">
    <h2>Sources (to scale)</h2>
    <div id="sources" class="stack"></div>
  </section>

  <section class="panel">
    <details class="details">
      <summary>Raw payload (JSON)</summary>
      <pre id="raw" class="code">—</pre>
    </details>
  </section>

  <section class="panel nav">
    <div class="nav-grid">
      <a class="btn" href="/home/">Home</a>
      <a class="btn" href="/engine/">Engine</a>
      <a class="btn" href="/laws/">Laws</a>
      <a class="btn" href="/principles/">Principles</a>
      <a class="btn" href="/geodynamics/">Geodynamics</a>
      <a class="btn" href="/reference/">Reference</a>
      <a class="btn" href="/about/">About</a>
    </div>
  </section>

  <section class="panel footer">
    <div class="muted small" id="buildLine">Build: 2026-02-01a · Canonical</div>
  </section>

</main>

<script>
(function(){
  // === CONFIG (edit here only if your worker path changes) ===
  const TRUTH_BASE = "https://geodiametrics-aggregator.smansfield635.workers.dev/metrics";
  const POLL_MS = 10000;

  // === helpers ===
  const $ = (id)=>document.getElementById(id);
  const nowMs = ()=>Date.now();
  const fmtDT = (ms)=>{
    try { return new Date(ms).toLocaleString(); } catch(e){ return String(ms); }
  };
  const clamp01 = (x)=>Math.max(0, Math.min(1, x));
  const intensityColor = (ratio)=> {
    // ratio 0..1 mapped to red->yellow->green
    if (ratio <= 0.33) return "i-red";
    if (ratio <= 0.66) return "i-yellow";
    return "i-green";
  };
  const healthBadgeClass = (health)=> {
    const h = String(health||"").toUpperCase();
    if (h === "GREEN" || h === "OPERATIONAL") return "b-green";
    if (h === "YELLOW" || h === "DEGRADED") return "b-yellow";
    return "b-red";
  };

  function setText(id, v){ $(id).textContent = v==null ? "—" : String(v); }

  function barRow(label, value, max){
    const v = Number(value||0);
    const m = Number(max||1);
    const r = m>0 ? clamp01(v/m) : 0;
    const wrap = document.createElement("div");
    wrap.className = "barrow";
    wrap.innerHTML = `
      <div class="barhead">
        <span class="label">${label}</span>
        <span class="value mono">${v}</span>
      </div>
      <div class="bartrack">
        <div class="barfill ${intensityColor(r)}" style="width:${(r*100).toFixed(2)}%"></div>
      </div>
    `;
    return wrap;
  }

  async function fetchTruth(){
    const url = TRUTH_BASE + "?t=" + nowMs();
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("truth_http_"+res.status);
    return { url, json: await res.json() };
  }

  function computeHealth(payload){
    // Prefer explicit status; fall back to errors; default degraded if missing.
    const status = String(payload?.status || "").toUpperCase();
    const errs = Number(payload?.metrics?.errors || 0);
    if (status === "OPERATIONAL" && errs === 0) return "GREEN";
    if (status === "DEGRADED" || errs > 0) return "YELLOW";
    return "RED";
  }

  function render(payload, truthUrl){
    const health = computeHealth(payload);
    $("healthBadge").textContent = health;
    $("healthBadge").className = "badge " + healthBadgeClass(health);

    setText("truthUrl", truthUrl);
    setText("polling", (POLL_MS/1000) + "s");

    const last = payload?.metrics?.lastUpdated;
    const lastMs = typeof last === "number" ? last : Number(last);
    if (!Number.isFinite(lastMs)) {
      setText("lastUpdated", "—");
      setText("ageSec", "—");
    } else {
      setText("lastUpdated", fmtDT(lastMs));
      setText("ageSec", Math.max(0, Math.floor((nowMs() - lastMs)/1000)));
    }

    // Bars share one scale across metrics+sources
    const metrics = payload?.metrics || {};
    const sources = payload?.sources || {};
    const metricPairs = [
      ["Sessions", metrics.sessions],
      ["Pageviews", metrics.pageviews],
      ["Clicks", metrics.clicks],
      ["Writes", metrics.writes],
    ];
    const sourcePairs = [
      ["GitHub", sources.GitHub],
      ["OSF", sources.OSF],
      ["Direct", sources.Direct],
      ["Other", sources.Other],
    ];

    const values = [
      ...metricPairs.map(p=>Number(p[1]||0)),
      ...sourcePairs.map(p=>Number(p[1]||0)),
    ];
    const max = Math.max(1, ...values);

    const g = $("gauges");
    g.innerHTML = "";
    metricPairs.forEach(([k,v])=>g.appendChild(barRow(k, v, max)));

    const s = $("sources");
    s.innerHTML = "";
    sourcePairs.forEach(([k,v])=>s.appendChild(barRow(k, v, max)));

    $("raw").textContent = JSON.stringify(payload, null, 2);
  }

  async function tick(){
    try{
      const {url, json} = await fetchTruth();
      render(json, url);
    }catch(e){
      // Degraded display but keep UI stable
      $("healthBadge").textContent = "RED";
      $("healthBadge").className = "badge b-red";
      setText("truthUrl", TRUTH_BASE);
      setText("polling", (POLL_MS/1000) + "s");
      setText("lastUpdated", "—");
      setText("ageSec", "—");
      $("gauges").innerHTML = "";
      ["Sessions","Pageviews","Clicks","Writes"].forEach(k=>{
        $("gauges").appendChild(barRow(k, 0, 1));
      });
      $("sources").innerHTML = "";
      ["GitHub","OSF","Direct","Other"].forEach(k=>{
        $("sources").appendChild(barRow(k, 0, 1));
      });
      $("raw").textContent = "Unavailable";
    }
  }

  tick();
  setInterval(tick, POLL_MS);
})();
</script>
</body>
</html>
