<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Control Room · Geodiametrics</title>

<style>
:root{
  --fg:#e9eefc;--muted:rgba(233,238,252,.62);
  --stroke:rgba(233,238,252,.14);
  --panel:rgba(12,16,34,.62);
  --radius:22px;--shadow:0 18px 55px rgba(0,0,0,.55);
  --green:#4ade80;--yellow:#facc15;--red:#f87171;--blue:#60a5fa;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--fg);
  overflow-x:hidden;
  background:
    radial-gradient(1200px 900px at 18% 10%, rgba(122,162,255,.18), transparent 60%),
    radial-gradient(900px 700px at 85% 30%, rgba(180,140,255,.14), transparent 60%),
    radial-gradient(1100px 900px at 55% 85%, rgba(120,220,255,.10), transparent 60%),
    linear-gradient(180deg,#070b18,#050714 70%,#04040f);
}
.wrap{max-width:1200px;margin:0 auto;padding:22px 16px 80px}
.card{border-radius:var(--radius);border:1px solid var(--stroke);background:var(--panel);box-shadow:var(--shadow);padding:18px;margin-bottom:16px}
h1{margin:0 0 8px;font-size:42px}
h2{margin:0 0 10px;font-size:22px}
p{margin:0 0 10px;color:var(--muted);line-height:1.55}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.small{font-size:13px;color:var(--muted)}
.hr{height:1px;background:rgba(233,238,252,.10);margin:14px 0}

.gauges{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:10px}
.gauge{border-radius:18px;border:1px solid rgba(233,238,252,.14);background:rgba(0,0,0,.22);padding:14px}
.gauge h3{margin:0 0 8px;font-size:12px;letter-spacing:.7px;text-transform:uppercase;color:rgba(233,238,252,.85)}
.meter{height:14px;background:rgba(255,255,255,.12);border-radius:8px;overflow:hidden}
.fill{height:100%;width:0%;transition:width .35s ease}
.light{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px;background:var(--green)}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
.table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{padding:8px;border-bottom:1px solid rgba(233,238,252,.12);text-align:left;color:var(--muted)}
th{color:#fff;font-weight:950}
.zone{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(233,238,252,.14);background:rgba(255,255,255,.06);font-weight:900;font-size:12px;letter-spacing:.6px;text-transform:uppercase}
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>Control Room</h1>
    <p>No buttons. No modes. No manual state changes. This page is a read-only monitor. It only reports breakage.</p>
    <div class="row">
      <span class="zone"><span id="sysLight" class="light"></span><span id="sysZone">SAFE</span></span>
      <span class="mono small" id="lastScan">Last scan: —</span>
    </div>
  </div>

  <div class="card">
    <h2>System Gauges</h2>
    <div class="gauges">
      <div class="gauge">
        <h3>Fuel (Coherence)</h3>
        <div class="meter"><div id="fuel" class="fill" style="background:var(--green)"></div></div>
        <div class="small">100% unless burnout or fragmentation is detected.</div>
      </div>
      <div class="gauge">
        <h3>RPM (Activity)</h3>
        <div class="meter"><div id="rpm" class="fill" style="background:var(--blue)"></div></div>
        <div class="small">Recent write density (last 60s).</div>
      </div>
      <div class="gauge">
        <h3>Speed (Progress)</h3>
        <div class="meter"><div id="speed" class="fill" style="background:var(--green)"></div></div>
        <div class="small">Cycle position average.</div>
      </div>
      <div class="gauge">
        <h3>Risk (Instability)</h3>
        <div class="meter"><div id="risk" class="fill" style="background:var(--red)"></div></div>
        <div class="small">Derived from fragmentation + wall + fuel drop.</div>
      </div>
    </div>
  </div>

  <div class="grid">

    <div class="card">
      <h2>Core Status</h2>
      <table class="table">
        <thead>
          <tr><th>Core</th><th>Fuel</th><th>RPM</th><th>Speed</th><th>Risk</th><th>Cycle</th></tr>
        </thead>
        <tbody id="coreRows">
          <tr><td colspan="6" class="mono">No engines discovered.</td></tr>
        </tbody>
      </table>
      <div class="small mono" id="coreMeta">—</div>
    </div>

    <div class="card">
      <h2>Break Log (Only)</h2>
      <p>This log records only breakage events. Normal function produces silence.</p>
      <pre id="breakLog" class="mono small" style="white-space:pre-wrap;margin:0">—</pre>
    </div>

  </div>

  <div class="footer">© 2026 Geodiametrics · Control Room</div>

</div>

<script>
/* ===============================
   CONTROL ROOM (READ ONLY)
   - No buttons
   - No writes (except break log write)
   - Scans ENGINE:: keys
================================ */

const PREFIX = "ENGINE::";
const BREAK_KEY = "ENGINE::BREAK_LOG::v1";
const CORES = [
  "diamond_fusion_core_1",
  "diamond_fusion_core_2",
  "diamond_fusion_core_3",
  "diamond_fusion_core_4"
];

const nowISO = () => new Date().toISOString();
const nowMS  = () => Date.now();

function getJSON(k, fb=null){
  try { return JSON.parse(localStorage.getItem(k)) ?? fb; }
  catch { return fb; }
}

function setGauge(id, val){
  const pct = Math.max(0, Math.min(100, Math.round(val*100)));
  document.getElementById(id).style.width = pct + "%";
}

function cycleSpeed(c){
  return c==="RUNNING" ? 0.35 :
         c==="HURDLE"  ? 0.55 :
         c==="WALL"    ? 0.20 :
         c==="COMPLETE"? 1.00 : 0.00;
}

function fragScore(s){
  // Fragmentation = invalid ordering signals (observer-only)
  // resolution without selection, commitment without resolved, WALL cycle
  let v = 0;
  if(s.resolution && !s.selection) v++;
  if(s.commitment && s.resolution!=="RESOLVED") v++;
  if((s.continuation?.cycle||"") === "WALL") v++;
  return Math.min(1, v/3);
}

function rpmScore(updated_at){
  // RPM = 1 if updated within 5s, 0 if older than 60s
  const t = updated_at ? new Date(updated_at).getTime() : 0;
  const age = Math.max(0, nowMS() - t);
  if(age <= 5000) return 1;
  if(age >= 60000) return 0;
  return 1 - (age-5000)/(60000-5000);
}

function readCore(ns){
  const e = getJSON(PREFIX + ns, null);
  if(!e || !e.state) return null;
  return e;
}

function appendBreak(msg){
  const log = getJSON(BREAK_KEY, []);
  log.push({t: nowISO(), msg});
  while(log.length > 200) log.shift();
  localStorage.setItem(BREAK_KEY, JSON.stringify(log));
}

function render(){
  const coreRows = document.getElementById("coreRows");
  const breakLog = document.getElementById("breakLog");
  const coreMeta = document.getElementById("coreMeta");
  const lastScan = document.getElementById("lastScan");
  const sysLight = document.getElementById("sysLight");
  const sysZone  = document.getElementById("sysZone");

  lastScan.textContent = "Last scan: " + nowISO();

  const rows = [];
  let sysFrag = 0, sysBurn = 0, sysRisk = 0, sysSpeed = 0, sysRPM = 0;
  let n = 0;

  CORES.forEach(ns=>{
    const e = readCore(ns);
    if(!e) return;
    n++;

    const s = e.state || {};
    const cyc = s.continuation?.cycle || "IDLE";

    const f = fragScore(s);
    const r = rpmScore(e.updated_at);
    const sp = cycleSpeed(cyc);

    // Burnout proxy = high RPM sustained (observer-only)
    // (If rpm > .75 and cycle not progressing, treat as burn risk)
    const stagnation = (sp < 0.35 && (s.selection || s.resolution || s.commitment));
    const burn = (r > 0.75 && stagnation) ? 1 : 0;

    const risk = Math.min(1, (0.7*f + 0.3*(cyc==="WALL"?1:0)));

    // Fuel stays full unless burnout/fragmentation
    const fuel = Math.max(0, 1 - (0.55*burn + 0.45*f));

    sysFrag += f;
    sysBurn += burn;
    sysRisk += risk;
    sysSpeed += sp;
    sysRPM += r;

    rows.push({ns, fuel, rpm:r, speed:sp, risk, cyc});
  });

  if(!n){
    coreRows.innerHTML = `<tr><td colspan="6" class="mono">No engines discovered.</td></tr>`;
    setGauge("fuel",0); setGauge("rpm",0); setGauge("speed",0); setGauge("risk",0);
    sysLight.style.background = "var(--yellow)";
    sysZone.textContent = "NO DATA";
    coreMeta.textContent = "—";
  } else {
    const avgFuel = rows.reduce((a,x)=>a+x.fuel,0)/n;
    const avgRPM  = rows.reduce((a,x)=>a+x.rpm,0)/n;
    const avgSpd  = rows.reduce((a,x)=>a+x.speed,0)/n;
    const avgRisk = rows.reduce((a,x)=>a+x.risk,0)/n;

    setGauge("fuel", avgFuel);
    setGauge("rpm", avgRPM);
    setGauge("speed", avgSpd);
    setGauge("risk", avgRisk);

    // Zone thresholds
    const zone =
      (avgRisk >= 0.66 || avgFuel <= 0.40) ? "FAULT" :
      (avgRisk >= 0.33 || avgFuel <= 0.70) ? "WARNING" :
      "SAFE";

    sysZone.textContent = zone;
    sysLight.style.background =
      zone==="SAFE" ? "var(--green)" :
      zone==="WARNING" ? "var(--yellow)" :
      "var(--red)";

    // Log breakage only
    if(zone !== "SAFE"){
      appendBreak(`ZONE=${zone} fuel=${avgFuel.toFixed(2)} risk=${avgRisk.toFixed(2)} rpm=${avgRPM.toFixed(2)} speed=${avgSpd.toFixed(2)}`);
    }

    coreRows.innerHTML = rows.map(x=>`
      <tr>
        <td class="mono">${x.ns}</td>
        <td class="mono">${Math.round(x.fuel*100)}%</td>
        <td class="mono">${Math.round(x.rpm*100)}%</td>
        <td class="mono">${Math.round(x.speed*100)}%</td>
        <td class="mono">${Math.round(x.risk*100)}%</td>
        <td class="mono">${x.cyc}</td>
      </tr>
    `).join("");

    coreMeta.textContent = `cores=${n} avg_fuel=${Math.round(avgFuel*100)}% avg_risk=${Math.round(avgRisk*100)}%`;
  }

  const log = getJSON(BREAK_KEY, []);
  breakLog.textContent = log.length ? log.map(x=>`${x.t}  ${x.msg}`).join("\n") : "—";
}

// auto-refresh every 5 seconds (observer only)
render();
setInterval(render, 5000);
</script>
</body>
</html>
```0
