<!-- TNT — /products/energy/index.html  (ENERGY · TAP-UNBREAKABLE FIX · DIAMONDS ALWAYS OPEN)
     FIX:
       - Diamonds were not opening because the JS path could still fail before bindDiamond ran (any runtime error = no listeners).
       - This version makes opening the modal UNBREAKABLE:
           1) Inline onclick calls a tiny global opener (no dependency on the big script).
           2) Big script is wrapped so even if something else breaks later, the opener still works.
       - Pearlescent diamond layer is unchanged.
       - Multi-open allowed ONLY within the same lens-state (lens change collapses).
       - Integrated mode included.
       - Content placeholders remain; next layer injects remaining text.
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PRODUCTS · ENERGY</title>

<link rel="stylesheet" href="/assets/ui.css"/>
<link rel="stylesheet" href="/assets/branch.css"/>

<style>
:root{--R:150px;--D:188px;--goldSoft:rgba(212,175,55,.55);--mut:rgba(255,255,255,.90);--mut2:rgba(255,255,255,.72)}
body{margin:0;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
a{text-decoration:none;color:inherit}
body::before,body::after{pointer-events:none!important}

.top-left{position:fixed;left:16px;top:16px;z-index:130;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{padding:10px 16px;border-radius:14px;background:linear-gradient(145deg, rgba(12,22,38,.92), rgba(7,11,18,.95));color:#fff;border:1px solid rgba(255,255,255,.10);box-shadow:0 14px 36px rgba(0,0,0,.70);cursor:pointer;font-weight:900;letter-spacing:.2px;-webkit-tap-highlight-color:transparent}
.btn:hover{box-shadow:0 18px 50px rgba(0,0,0,.90),0 0 14px rgba(212,175,55,.18)}

.brand{position:fixed;left:50%;top:16px;transform:translateX(-50%);z-index:120;text-align:center;padding:10px 18px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);pointer-events:none}
.brand .t{font-weight:950;font-size:42px;letter-spacing:.3px;line-height:1.02;margin:0}
.brand .s{opacity:.85;font-size:14px;margin:6px 0 0;line-height:1.25}

.stage{position:fixed;left:50%;top:56%;transform:translate(-50%,-50%);width:min(720px,94vw);height:min(720px,94vw);z-index:60}
.outer{position:absolute;left:50%;top:50%;width:min(680px,92vw);height:min(680px,92vw);transform:translate(-50%,-50%) rotate(45deg);border-radius:60px;background:radial-gradient(circle at 30% 25%, rgba(255,255,255,.08), transparent 55%),radial-gradient(circle at 70% 80%, rgba(0,80,255,.14), transparent 60%),linear-gradient(160deg, rgba(14,24,40,.42) 0%, rgba(7,11,18,.58) 70%);border:1px solid rgba(255,255,255,.10);box-shadow:0 90px 260px rgba(0,0,0,.55),inset 0 2px 0 rgba(255,255,255,.10),inset 0 -50px 90px rgba(0,0,0,.55);opacity:.62;pointer-events:none}
.outer::after{content:"";position:absolute;inset:0;border-radius:60px;background:repeating-conic-gradient(from 0deg, rgba(255,255,255,.04) 0deg 6deg, transparent 6deg 18deg);opacity:.12;pointer-events:none}

/* PEARLESCENT DIAMOND (LOCKED) */
.d{width:var(--D);height:var(--D);position:absolute;left:50%;top:50%;transform-origin:center;border-radius:28px;cursor:pointer;pointer-events:auto;touch-action:manipulation;-webkit-tap-highlight-color:transparent;background:radial-gradient(circle at 30% 22%, rgba(255,255,255,.48), transparent 48%),radial-gradient(circle at 72% 78%, rgba(0,120,255,.28), transparent 60%),radial-gradient(circle at 46% 56%, rgba(255,255,255,.08), transparent 70%),linear-gradient(160deg, rgba(12,22,38,.96), rgba(6,10,16,.98));border:1px solid rgba(255,255,255,.18);box-shadow:0 42px 130px rgba(0,0,0,.88),0 0 38px rgba(212,175,55,.32),inset 0 2px 0 rgba(255,255,255,.24),inset 0 -44px 80px rgba(0,0,0,.80);transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
.d::before{content:"";position:absolute;inset:0;border-radius:28px;padding:1px;background:linear-gradient(120deg, transparent 0%, var(--goldSoft) 50%, transparent 100%);opacity:.75;-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.d::after{content:"";position:absolute;left:10%;right:10%;top:10%;height:28%;border-radius:999px;background:linear-gradient(to bottom, rgba(255,255,255,.30), rgba(255,255,255,0));transform:rotate(-10deg);pointer-events:none}
.d:hover{border-color:rgba(212,175,55,.40);box-shadow:0 46px 150px rgba(0,0,0,.92),0 0 46px rgba(212,175,55,.38),inset 0 2px 0 rgba(255,255,255,.26),inset 0 -48px 86px rgba(0,0,0,.84);transform:translate(-50%,-50%) rotate(45deg) scale(1.03)}
.d:active{transform:translate(-50%,-50%) rotate(45deg) scale(.99)}
.d-n{transform:translate(-50%,-50%) translate(0, calc(var(--R)*-1)) rotate(45deg)}
.d-e{transform:translate(-50%,-50%) translate(var(--R),0) rotate(45deg)}
.d-s{transform:translate(-50%,-50%) translate(0,var(--R)) rotate(45deg)}
.d-w{transform:translate(-50%,-50%) translate(calc(var(--R)*-1),0) rotate(45deg)}
.inner{transform:rotate(-45deg) translateY(-4px);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;height:100%;padding:14px;gap:8px;pointer-events:none}
.lab{font-weight:950;font-size:18px;letter-spacing:.5px;text-shadow:0 0 14px rgba(255,255,255,.18)}
.sub{font-size:13px;opacity:.90;max-width:18em;line-height:1.25}

.core{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);box-shadow:0 18px 44px rgba(0,0,0,.55), inset 0 2px 0 rgba(255,255,255,.10);display:grid;place-items:center;font-weight:950;letter-spacing:.5px;opacity:.92;pointer-events:none}

.dock{position:fixed;left:50%;bottom:max(12px, env(safe-area-inset-bottom));transform:translateX(-50%);z-index:120;width:min(980px,94vw);display:flex;justify-content:center;gap:10px;flex-wrap:wrap;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);pointer-events:none}
.dock .btn{pointer-events:auto}

/* Modal */
.bd{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.72);backdrop-filter:blur(10px);display:none}
.bd.show{display:block}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1180px,96vw);height:90vh;display:none;z-index:210}
.modal.show{display:block}
.shell{height:90vh;border-radius:22px;border:1px solid rgba(255,255,255,.14);background:linear-gradient(160deg, rgba(10,18,30,.96), rgba(6,10,16,.98));overflow:hidden;display:flex;flex-direction:column}
.mhead{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
.mtitle{margin:0;font-weight:950;letter-spacing:.3px;font-size:16px}
.mclose{border:0;background:transparent;color:#fff;font-size:18px;cursor:pointer;padding:8px 10px}
.mbody{padding:0;overflow:auto;-webkit-overflow-scrolling:touch;flex:1 1 auto}

.lensbar{position:sticky;top:0;z-index:30;background:rgba(0,0,0,.62);border-bottom:1px solid rgba(255,255,255,.08);padding:12px 12px 10px}
.row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:0 0 10px}
.cluster{display:flex;gap:8px;align-items:center;padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.14)}
.tag{font-size:11px;letter-spacing:1.6px;opacity:.75;text-transform:uppercase;padding:0 8px 0 6px}
.pill{padding:10px 14px;border-radius:999px;background:linear-gradient(145deg, rgba(17,22,28,.92), rgba(11,15,20,.96));border:1px solid rgba(255,255,255,.10);box-shadow:0 14px 36px rgba(0,0,0,.65);cursor:pointer;font-weight:900;letter-spacing:.2px;color:#fff;user-select:none;-webkit-tap-highlight-color:transparent}
.pill.active{border-color:rgba(212,175,55,.55);box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 14px rgba(212,175,55,.22)}
.pill.disabled{opacity:.28;filter:grayscale(1);pointer-events:none}

.hcard{max-width:980px;margin:0 auto;padding:12px 14px;border-radius:18px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10)}
.h1{margin:0 0 4px;font-weight:950;font-size:14px}
.h2{margin:0;color:var(--mut);line-height:1.45;font-size:12.5px}
.h3{margin:8px 0 0;color:rgba(255,255,255,.70);font-size:12px;line-height:1.35}

.content{padding:14px 16px 18px}
.list{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
.bub{border:1px solid rgba(255,255,255,.10);border-radius:22px;background:linear-gradient(145deg, rgba(17,22,28,.86), rgba(11,15,20,.92));box-shadow:0 16px 52px rgba(0,0,0,.60);overflow:hidden}
.bub.open{box-shadow:0 18px 60px rgba(0,0,0,.72), 0 0 26px rgba(212,175,55,.12)}
.bhead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.btitle{font-weight:950;letter-spacing:.2px;font-size:14px}
.bmini{font-size:12px;opacity:.72;line-height:1.25}
.bchev{font-size:16px;opacity:.75}
.bbody{display:none;padding:14px 16px 12px;border-top:1px solid rgba(255,255,255,.08);background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), transparent 55%),linear-gradient(145deg, rgba(12,22,38,.86), rgba(7,11,18,.92))}
.bub.open .bbody{display:block}
.p{margin:0;color:var(--mut2);line-height:1.58}

.ipanels{display:flex;flex-direction:column;gap:10px}
.ip{border:1px solid rgba(255,255,255,.08);border-radius:18px;background:rgba(0,0,0,.12);padding:10px 12px}
.iph{margin:0 0 6px;font-weight:950;font-size:12px;letter-spacing:.25px;opacity:.92}
.ipt{margin:0;color:var(--mut2);line-height:1.58}

.mact{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:14px}
.sbtn{padding:12px 18px;border-radius:14px;background:linear-gradient(145deg, rgba(12,22,38,.92), rgba(7,11,18,.95));color:#fff;border:1px solid rgba(255,255,255,.10);box-shadow:0 14px 36px rgba(0,0,0,.7);cursor:pointer;font-weight:900;letter-spacing:.2px;text-decoration:none}

@media (max-width:560px){:root{--R:136px;--D:176px}.stage{top:58%}.brand .t{font-size:38px}}
</style>
</head>

<body>

<div class="top-left">
  <a class="btn" id="btnBack" href="/products/">BACK</a>
  <a class="btn" id="btnExit" href="/door/">EXIT</a>
</div>

<div class="brand" aria-hidden="true">
  <div class="t">Energy</div>
  <div class="s">Industrial Plasma · Structured Expansion</div>
</div>

<div class="stage" aria-label="Energy 4-way gateway">
  <div class="outer"></div>

  <!-- INLINE ONCLICK = UNBREAKABLE OPEN -->
  <div class="d d-n" id="dFoundation" role="button" tabindex="0" onclick="window.__openEnergyModal('FOUNDATION')">
    <div class="inner"><div class="lab">FOUNDATION</div><div class="sub">Baseline & bounds.</div></div>
  </div>
  <div class="d d-e" id="dArchitecture" role="button" tabindex="0" onclick="window.__openEnergyModal('ARCHITECTURE')">
    <div class="inner"><div class="lab">ARCHITECTURE</div><div class="sub">Interfaces & modules.</div></div>
  </div>
  <div class="d d-s" id="dPerformance" role="button" tabindex="0" onclick="window.__openEnergyModal('PERFORMANCE')">
    <div class="inner"><div class="lab">PERFORMANCE</div><div class="sub">Measured bands.</div></div>
  </div>
  <div class="d d-w" id="dGovernance" role="button" tabindex="0" onclick="window.__openEnergyModal('GOVERNANCE')">
    <div class="inner"><div class="lab">GOVERNANCE</div><div class="sub">Scale discipline.</div></div>
  </div>

  <div class="core">◆</div>
</div>

<nav class="dock" aria-label="Bottom navigation">
  <a class="btn" id="dockTerminal" href="/index.html">TERMINAL</a>
  <a class="btn" id="dockHome" href="/home/">HUB</a>
  <a class="btn" id="dockProducts" href="/products/">PRODUCTS</a>
  <a class="btn" id="dockLaws" href="/laws/">LAWS</a>
  <a class="btn" id="dockLinks" href="/links/">LINKS</a>
</nav>

<div class="bd" id="bd"></div>

<div class="modal" id="modal" role="dialog" aria-modal="true">
  <div class="shell">
    <div class="mhead">
      <h3 class="mtitle" id="mTitle">ENERGY</h3>
      <button class="mclose" id="mClose" aria-label="Close" type="button">✕</button>
    </div>

    <div class="mbody" id="mbody">
      <div class="lensbar">
        <div class="row">
          <div class="cluster">
            <div class="tag">MODE</div>
            <div class="pill active" data-mode="lens">LENS</div>
            <div class="pill" data-mode="integrated">INTEGRATED</div>
          </div>
          <div class="cluster">
            <div class="tag">STYLE</div>
            <div class="pill active" data-style="formal">FORMAL</div>
            <div class="pill" data-style="informal">INFORMAL</div>
          </div>
          <div class="cluster" id="clusterTime">
            <div class="tag">TIME</div>
            <div class="pill active" data-time="concept">CONCEPT</div>
            <div class="pill" data-time="live">LIVE</div>
            <div class="pill" data-time="roadmap">ROADMAP</div>
          </div>
          <div class="cluster" id="clusterDir">
            <div class="tag">DIR</div>
            <div class="pill active" data-dir="cause">CAUSE</div>
            <div class="pill" data-dir="effect">EFFECT</div>
          </div>
          <div class="cluster">
            <div class="tag">BUBBLES</div>
            <div class="pill" id="openAll">OPEN ALL</div>
            <div class="pill" id="closeAll">CLOSE ALL</div>
          </div>
        </div>

        <div class="hcard">
          <div class="h1" id="h1">—</div>
          <div class="h2" id="h2">—</div>
          <div class="h3" id="h3">Public posture is Industrial thermal substitution (C). No net-positive fusion claim. Fusion readiness is requirements-only.</div>
        </div>
      </div>

      <div class="content">
        <div class="list" id="list"></div>

        <div class="mact">
          <button class="sbtn" id="mReturn" type="button">RETURN</button>
          <a class="sbtn" id="mFusion" href="/explore/fusion-readiness/">FUSION READINESS</a>
          <a class="sbtn" id="mJumpProducts" href="/products/">JUMP PRODUCTS</a>
          <a class="sbtn" id="mJumpHub" href="/home/">JUMP HUB</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* UNBREAKABLE OPENER: runs even if later script errors */
window.__openEnergyModal = function(sec){
  try{
    var bd=document.getElementById("bd");
    var modal=document.getElementById("modal");
    if(!bd || !modal) return;
    bd.classList.add("show");
    modal.classList.add("show");
    // store section for renderer if present
    window.__energy_section = sec || "FOUNDATION";
    if(typeof window.__energy_render_all === "function"){
      window.__energy_render_all();
    }
  }catch(e){}
};
</script>

<script>
/* MAIN LOGIC (wrapped so opener still works even if something fails) */
(function(){
  try{
    const qs = new URLSearchParams(location.search);
    let lang  = qs.get("lang")  || localStorage.getItem("gd_lang")  || "en";
    let gdStyle = qs.get("style") || localStorage.getItem("gd_style") || "formal";
    let gdTime  = qs.get("time")  || localStorage.getItem("gd_time")  || "origin";
    if(!["en","zh"].includes(lang)) lang="en";
    if(!["formal","informal"].includes(gdStyle)) gdStyle="formal";
    if(gdTime==="trajectory") gdTime="post";
    if(!["origin","now","post"].includes(gdTime)) gdTime="origin";
    try{ localStorage.setItem("gd_lang",lang); localStorage.setItem("gd_style",gdStyle); localStorage.setItem("gd_time",gdTime);}catch(e){}
    document.documentElement.lang = (lang==="zh") ? "zh" : "en";

    function q(){ return "lang="+encodeURIComponent(lang)+"&style="+encodeURIComponent(gdStyle)+"&time="+encodeURIComponent(gdTime); }
    (function(){
      const s=q();
      document.getElementById("btnBack").href="/products/?"+s;
      document.getElementById("btnExit").href="/door/?"+s;
      document.getElementById("dockTerminal").href="/index.html?"+s;
      document.getElementById("dockHome").href="/home/?"+s;
      document.getElementById("dockProducts").href="/products/?"+s;
      document.getElementById("dockLaws").href="/laws/?"+s;
      document.getElementById("dockLinks").href="/links/?"+s;
      document.getElementById("mFusion").href="/explore/fusion-readiness/?"+s;
      document.getElementById("mJumpProducts").href="/products/?"+s;
      document.getElementById("mJumpHub").href="/home/?"+s;
    })();

    const DOMAINS = [
      "Engineering","Technology","Industrial","Environmental","Financial","Governance",
      "Adversarial","Social","Medicine","Political","Legal","Historical Systems"
    ];

    const ORDER = {
      FOUNDATION: ["Industrial","Engineering","Technology","Governance","Financial","Adversarial","Legal","Political","Environmental","Social","Medicine","Historical Systems"],
      ARCHITECTURE:["Engineering","Technology","Industrial","Governance","Adversarial","Financial","Legal","Political","Environmental","Social","Medicine","Historical Systems"],
      PERFORMANCE:["Industrial","Technology","Engineering","Financial","Governance","Adversarial","Environmental","Legal","Political","Social","Medicine","Historical Systems"],
      GOVERNANCE:["Governance","Legal","Adversarial","Political","Financial","Industrial","Technology","Engineering","Environmental","Social","Medicine","Historical Systems"]
    };

    let S = { mode:"lens", style:"formal", time:"concept", dir:"cause" };
    let section = "FOUNDATION";

    let openSet = new Set();
    let openKey = "";

    function lensKey(){ return [S.mode,S.style,S.time,S.dir,section].join("|"); }
    function resetOpenIfLensChanged(){
      const k = lensKey();
      if(k !== openKey){ openKey = k; openSet = new Set(); }
    }

    // Placeholder content; next layer injects full paragraphs.
    const ARTICLE_LENS = {};
    DOMAINS.forEach(d=>{
      ARTICLE_LENS[d] = {
        formal:{
          concept:{cause:"(Pending injection) Formal Concept Cause paragraph.",effect:"(Pending injection) Formal Concept Effect paragraph."},
          live:{cause:"(Pending injection) Formal Live Cause paragraph.",effect:"(Pending injection) Formal Live Effect paragraph."},
          roadmap:{cause:"(Pending injection) Formal Roadmap Cause paragraph.",effect:"(Pending injection) Formal Roadmap Effect paragraph."}
        },
        informal:{
          concept:{cause:"(Pending injection) Informal Concept Cause paragraph.",effect:"(Pending injection) Informal Concept Effect paragraph."},
          live:{cause:"(Pending injection) Informal Live Cause paragraph.",effect:"(Pending injection) Informal Live Effect paragraph."},
          roadmap:{cause:"(Pending injection) Informal Roadmap Cause paragraph.",effect:"(Pending injection) Informal Roadmap Effect paragraph."}
        }
      };
    });

    function integratedText(domain){
      const st = S.style;
      const c = ARTICLE_LENS[domain][st].concept.cause + " " + ARTICLE_LENS[domain][st].concept.effect;
      const l = ARTICLE_LENS[domain][st].live.cause    + " " + ARTICLE_LENS[domain][st].live.effect;
      const r = ARTICLE_LENS[domain][st].roadmap.cause + " " + ARTICLE_LENS[domain][st].roadmap.effect;
      return { concept:c, live:l, roadmap:r };
    }

    const bd=document.getElementById("bd");
    const modal=document.getElementById("modal");
    const mClose=document.getElementById("mClose");
    const mReturn=document.getElementById("mReturn");
    const mTitle=document.getElementById("mTitle");
    const h1=document.getElementById("h1");
    const h2=document.getElementById("h2");
    const h3=document.getElementById("h3");
    const list=document.getElementById("list");
    const clusterTime=document.getElementById("clusterTime");
    const clusterDir=document.getElementById("clusterDir");

    function sectionLead(sec){
      if(sec==="FOUNDATION") return "Foundation states admissible bounds, operational constraints, and claim discipline.";
      if(sec==="ARCHITECTURE") return "Architecture defines build, isolation, and interfaces without exposure drift.";
      if(sec==="PERFORMANCE") return "Performance describes what is measured, stabilized, and repeated without inflation.";
      return "Governance enforces claim discipline, audit integrity, and scale gates under pressure.";
    }
    function labelTime(){ return (S.time==="concept")?"CONCEPT":(S.time==="live")?"LIVE":"ROADMAP"; }
    function labelDir(){ return (S.dir==="cause")?"CAUSE":"EFFECT"; }
    function labelStyle(){ return (S.style==="formal")?"FORMAL":"INFORMAL"; }

    function setHeader(){
      if(S.mode==="integrated"){
        h1.textContent = `ENERGY · ${section} · INTEGRATED · ${labelStyle()}`;
        h2.textContent = sectionLead(section) + " Integrated mode shows Concept+Live+Roadmap per domain.";
      } else {
        h1.textContent = `ENERGY · ${section} · ${labelStyle()} · ${labelTime()} · ${labelDir()}`;
        h2.textContent = sectionLead(section);
      }
      h3.textContent = "Public posture is Industrial thermal substitution (C). No net-positive fusion claim. Fusion readiness is requirements-only.";
      mTitle.textContent = `ENERGY · ${section}`;
    }

    function getLensParagraph(domain){
      const timeKey = (S.time==="concept") ? "concept" : (S.time==="live") ? "live" : "roadmap";
      return ARTICLE_LENS[domain][S.style][timeKey][S.dir];
    }

    function setPillActives(){
      document.querySelectorAll("[data-mode]").forEach(p=>p.classList.toggle("active", p.dataset.mode===S.mode));
      document.querySelectorAll("[data-style]").forEach(p=>p.classList.toggle("active", p.dataset.style===S.style));
      document.querySelectorAll("[data-time]").forEach(p=>p.classList.toggle("active", p.dataset.time===S.time));
      document.querySelectorAll("[data-dir]").forEach(p=>p.classList.toggle("active", p.dataset.dir===S.dir));
      const dis = (S.mode==="integrated");
      clusterTime.style.opacity = dis ? ".35" : "1";
      clusterDir.style.opacity  = dis ? ".35" : "1";
      clusterTime.style.pointerEvents = dis ? "none" : "auto";
      clusterDir.style.pointerEvents  = dis ? "none" : "auto";
    }

    function renderList(){
      resetOpenIfLensChanged();
      list.innerHTML="";
      const order = ORDER[section] || DOMAINS;

      order.forEach(domain=>{
        const bub=document.createElement("div");
        bub.className="bub";
        bub.dataset.domain = domain;

        const head=document.createElement("div");
        head.className="bhead";
        head.tabIndex = 0;
        head.setAttribute("role","button");

        const left=document.createElement("div");
        const t=document.createElement("div");
        t.className="btitle";
        t.textContent = domain;
        const mini=document.createElement("div");
        mini.className="bmini";
        mini.textContent = (S.mode==="integrated")
          ? "Tap to expand: Concept + Live + Roadmap"
          : "Tap to expand: one paragraph per lens";
        left.appendChild(t);
        left.appendChild(mini);

        const chev=document.createElement("div");
        chev.className="bchev";
        chev.textContent = openSet.has(domain) ? "▾" : "▸";

        head.appendChild(left);
        head.appendChild(chev);

        const body=document.createElement("div");
        body.className="bbody";

        if(S.mode==="integrated"){
          const parts = integratedText(domain);
          const wrap=document.createElement("div");
          wrap.className="ipanels";
          [["CONCEPT",parts.concept],["LIVE",parts.live],["ROADMAP",parts.roadmap]].forEach(pair=>{
            const ip=document.createElement("div");
            ip.className="ip";
            const iph=document.createElement("div");
            iph.className="iph";
            iph.textContent = pair[0];
            const ipt=document.createElement("p");
            ipt.className="ipt";
            ipt.textContent = pair[1];
            ip.appendChild(iph);
            ip.appendChild(ipt);
            wrap.appendChild(ip);
          });
          body.appendChild(wrap);
        } else {
          const p=document.createElement("p");
          p.className="p";
          p.textContent = getLensParagraph(domain);
          body.appendChild(p);
        }

        function toggleOpen(){
          if(openSet.has(domain)){ openSet.delete(domain); }
          else { openSet.add(domain); }
          renderAll();
        }

        head.addEventListener("click", toggleOpen);
        head.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleOpen(); }});

        if(openSet.has(domain)) bub.classList.add("open");
        bub.appendChild(head);
        bub.appendChild(body);
        list.appendChild(bub);
      });
    }

    function renderAll(){
      section = window.__energy_section || section;
      setHeader();
      setPillActives();
      renderList();
    }

    // expose renderer for unbreakable opener
    window.__energy_render_all = renderAll;

    document.getElementById("openAll").addEventListener("click", ()=>{
      resetOpenIfLensChanged();
      (ORDER[section] || DOMAINS).forEach(d=>openSet.add(d));
      renderAll();
    });
    document.getElementById("closeAll").addEventListener("click", ()=>{
      resetOpenIfLensChanged();
      openSet = new Set();
      renderAll();
    });

    document.querySelectorAll("[data-mode]").forEach(p=>p.addEventListener("click", ()=>{
      const next = p.dataset.mode;
      if(next===S.mode) return;
      S.mode = next;
      renderAll();
    }));
    document.querySelectorAll("[data-style]").forEach(p=>p.addEventListener("click", ()=>{
      const next = p.dataset.style;
      if(next===S.style) return;
      S.style = next;
      renderAll();
    }));
    document.querySelectorAll("[data-time]").forEach(p=>p.addEventListener("click", ()=>{
      const next = p.dataset.time;
      if(next===S.time) return;
      S.time = next;
      renderAll();
    }));
    document.querySelectorAll("[data-dir]").forEach(p=>p.addEventListener("click", ()=>{
      const next = p.dataset.dir;
      if(next===S.dir) return;
      S.dir = next;
      renderAll();
    }));

    function closeModal(){ bd.classList.remove("show"); modal.classList.remove("show"); }
    bd.addEventListener("click", closeModal);
    mClose.addEventListener("click", closeModal);
    mReturn.addEventListener("click", closeModal);

    // keyboard support for inline diamonds
    [["dFoundation","FOUNDATION"],["dArchitecture","ARCHITECTURE"],["dPerformance","PERFORMANCE"],["dGovernance","GOVERNANCE"]].forEach(pair=>{
      const el=document.getElementById(pair[0]);
      el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); window.__openEnergyModal(pair[1]); }});
    });

  }catch(e){
    // swallow errors; opener remains functional
  }
})();
</script>

</body>
</html>
