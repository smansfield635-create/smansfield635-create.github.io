<!-- TNT: /home/index.html
     PURPOSE: HOME = Explore surface map (4‚Üí4‚Üí4 drilldown).
     RULES:
       - Show ONLY 4 quadrant cards (NW/NE/SW/SE) at top level.
       - Each quadrant expands to ONLY 4 sub-bubbles.
       - Clicking a sub-bubble opens an OPAQUE POP-OVER (no scroll-jump).
       - Pop-over can drill ONE MORE level (4 sub-bubbles) ‚Üí then detailed block.
       - Origin / Now / Trajectory lens lives at TOP and filters ALL detail text.
       - Only one jump in pop-over: JUMP HOME (close). Optional ‚ÄúJump into site‚Äù buttons inside the pop-over.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Home ¬∑ Geodiametrics</title>

  <link rel="stylesheet" href="/assets/ui.css?v=9001"/>
  <link rel="stylesheet" href="/assets/branch.css?v=9001"/>

  <style>
    /* === CRP AUTUMN FIELD v2 (inlined essentials for HOME) === */
    :root{
      --ink:#05070c;
      --ink-deep:#070b12;
      --red:#7a0b14;
      --red-soft:rgba(122,11,20,.28);
      --gold:#caa04a;
      --gold-soft:rgba(202,160,74,.22);
      --text:#eaf2f6;
      --muted:rgba(234,242,246,.72);
      --glass:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --shadow:rgba(0,0,0,.55);
      --shadow2:rgba(0,0,0,.85);
    }
    html,body{margin:0;padding:0;width:100%;height:100%;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--text);background:var(--ink);overflow-x:hidden}
    body{
      background:
        radial-gradient(1200px 900px at 15% 15%, var(--gold-soft) 0%, transparent 60%),
        radial-gradient(1400px 1000px at 85% 20%, var(--red-soft) 0%, transparent 65%),
        radial-gradient(1800px 1200px at 50% 0%, rgba(122,11,20,.18) 0%, transparent 70%),
        linear-gradient(to bottom, var(--ink-deep), var(--ink));
    }
    body::before{
      content:"";
      position:fixed;inset:-10%;
      pointer-events:none;z-index:-1;
      background:
        radial-gradient(520px 520px at 18% 10%, rgba(202,160,74,.16) 0%, transparent 65%),
        radial-gradient(640px 640px at 84% 14%, rgba(161,13,28,.20) 0%, transparent 70%),
        radial-gradient(760px 760px at 50% 5%, rgba(202,160,74,.10) 0%, transparent 75%);
      opacity:.62;
      animation:fireworkPulse 6s ease-in-out infinite alternate;
      filter:blur(6px);
    }
    @keyframes fireworkPulse{0%{opacity:.45;filter:blur(7px) brightness(.98)}100%{opacity:.75;filter:blur(6px) brightness(1.06)}}
    .shooting-stars{display:none!important}

    .page{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:34px 16px 90px}
    .wrap{width:min(980px,94vw);display:flex;flex-direction:column;gap:12px}

    .hero{position:relative;z-index:2}
    .hero h1{margin:0;font-weight:950;letter-spacing:.06em;text-transform:uppercase;font-size:clamp(42px,7vw,68px)}
    .hero p{margin:10px 0 0;color:var(--muted);font-size:18px;line-height:1.35}

    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{
      border-radius:999px;padding:10px 14px;
      background:var(--glass);
      box-shadow:inset 0 0 0 1px var(--stroke);
      font-weight:900;letter-spacing:.10em;text-transform:uppercase;font-size:12px;opacity:.92;
    }
    .pill.btn{cursor:pointer;text-decoration:none;color:inherit;user-select:none;-webkit-tap-highlight-color:transparent}
    .pill.btn:hover{background:rgba(255,255,255,.08)}
    .pill.active{
      background:rgba(122,11,20,.28);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.14), 0 20px 60px rgba(0,0,0,.35);
    }
    .pill.gold{
      background:rgba(202,160,74,.16);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.14), 0 20px 60px rgba(0,0,0,.35);
    }

    .section-title{
      margin-top:10px;
      font-weight:900;letter-spacing:.18em;opacity:.7;
      font-size:12px;text-transform:uppercase
    }

    /* Quadrant cards (ONLY 4) */
    details.quad{
      border-radius:22px;
      background:rgba(255,255,255,.05);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 22px 70px rgba(0,0,0,.45);
      backdrop-filter:blur(12px);
      overflow:hidden;
    }
    details.quad + details.quad{margin-top:12px}
    details.quad summary{list-style:none;cursor:pointer;padding:16px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;-webkit-tap-highlight-color:transparent}
    details.quad summary::-webkit-details-marker{display:none}

    .q-left{display:flex;align-items:center;gap:12px;min-width:0}
    .q-badge{
      width:64px;height:44px;border-radius:18px;
      background:rgba(122,11,20,.18);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:center;
      font-weight:950;letter-spacing:.14em;
      flex:0 0 auto;
      position:relative;
    }
    .q-badge .icon{position:absolute;left:10px;top:9px;opacity:.95}
    .q-badge .code{padding-left:18px}
    .q-text{min-width:0}
    .q-text b{display:block;font-size:18px;letter-spacing:.12em}
    .q-text span{display:block;opacity:.72;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .q-arrow{
      width:42px;height:42px;border-radius:999px;
      background:rgba(255,255,255,.06);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:center;
      opacity:.9;flex:0 0 auto;
    }
    .inside{padding:0 16px 16px}

    /* Sub-bubbles inside a quadrant (ONLY 4) */
    .bubble-row{display:grid;grid-template-columns:1fr;gap:10px;margin-top:2px}
    @media(min-width:720px){.bubble-row{grid-template-columns:1fr 1fr}}
    .bubble-btn{
      border-radius:18px;
      background:rgba(0,0,0,.22);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
      padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent
    }
    .bubble-btn:hover{background:rgba(0,0,0,.28)}
    .bubble-btn .lbl{min-width:0}
    .bubble-btn b{display:block;font-size:13px;letter-spacing:.14em;text-transform:uppercase}
    .bubble-btn i{display:block;font-style:normal;opacity:.72;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bubble-btn .go{
      width:40px;height:40px;border-radius:999px;
      background:rgba(255,255,255,.06);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:center;
      opacity:.9;flex:0 0 auto;
    }

    /* POP-OVER (opaque) */
    .overlay{
      position:fixed;inset:0;z-index:9999;
      display:none;align-items:center;justify-content:center;
      background:rgba(5,7,12,.82);
      backdrop-filter:blur(10px);
      padding:18px;
    }
    .overlay.on{display:flex}
    .modal{
      width:min(980px,94vw);
      max-height:min(86vh,760px);
      overflow:auto;
      border-radius:26px;
      background:linear-gradient(180deg, rgba(122,11,20,.28), rgba(0,0,0,.28));
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.12),
        0 35px 120px rgba(0,0,0,.75);
    }
    .modal-head{
      padding:16px 16px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky;top:0;background:rgba(0,0,0,.25);backdrop-filter:blur(10px);z-index:2
    }
    .modal-title{
      min-width:0;
    }
    .modal-title b{display:block;font-size:16px;letter-spacing:.18em;text-transform:uppercase}
    .modal-title span{display:block;margin-top:4px;opacity:.75;font-size:14px;line-height:1.25}
    .close{
      border:0;cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.08);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
      color:var(--text);
      font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:12px;
      flex:0 0 auto;
    }
    .close:hover{background:rgba(255,255,255,.10)}
    .modal-body{padding:14px 16px 18px}

    .lensbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .lensbar .pill{background:rgba(255,255,255,.05)}
    .lensbar .pill.active{background:rgba(202,160,74,.16)}

    .block{
      border-radius:20px;
      background:rgba(0,0,0,.26);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
      padding:14px 14px;
    }
    .block h3{margin:0 0 8px;font-weight:950;letter-spacing:.06em}
    .block p{margin:0;color:rgba(234,242,246,.76);line-height:1.55}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chip{
      border-radius:999px;
      padding:9px 12px;
      background:rgba(255,255,255,.06);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
      font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:11px;opacity:.92;
      cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent
    }
    .chip:hover{background:rgba(255,255,255,.08)}
    .chip.gold{background:rgba(202,160,74,.16)}
    .subgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media(min-width:720px){.subgrid{grid-template-columns:1fr 1fr}}
    .jump-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .jump{
      text-decoration:none;color:var(--text);
      border-radius:18px;padding:12px 14px;
      background:rgba(255,255,255,.08);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
      font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:12px;
    }
    .jump:hover{background:rgba(255,255,255,.10)}
    .jump.gold{background:rgba(202,160,74,.18)}
    .jump.gold:hover{background:rgba(202,160,74,.22)}

    footer{margin-top:18px;text-align:center;opacity:.55;letter-spacing:3px;font-size:12px}
    .ink{margin-top:12px;text-align:center;letter-spacing:.22em;font-weight:900;opacity:.40;font-size:12px;text-transform:uppercase}
  </style>
</head>

<body>
  <div class="page">
    <div class="wrap">

      <div class="hero">
        <h1>HOME</h1>
        <p>Explore the system. Tap a quadrant ‚Üí pick a bubble ‚Üí read details in a pop-over (no scroll jump).</p>

        <div class="topbar" role="toolbar" aria-label="Global lenses">
          <span class="pill">LANG: <span id="langPill">EN</span></span>
          <a class="pill btn" href="/door/">CHANGE ROUTE</a>

          <span class="pill">DEPTH: <span id="depthPill">EXPLORE</span></span>

          <span class="pill">LENS:</span>
          <button class="pill btn active" id="lensOrigin" type="button">ORIGIN</button>
          <button class="pill btn" id="lensNow" type="button">NOW</button>
          <button class="pill btn" id="lensTraj" type="button">TRAJECTORY</button>

          <span class="pill gold">SCOPE256</span>
        </div>

        <div class="section-title">Quadrant routes (NW / NE / SW / SE)</div>
      </div>

      <!-- ONLY 4 QUADRANTS -->
      <details class="quad" data-q="NW">
        <summary>
          <div class="q-left">
            <div class="q-badge"><span class="icon">‚≠ê</span><span class="code">NW</span></div>
            <div class="q-text">
              <b>NORTHWEST</b>
              <span>Definition ¬∑ language ¬∑ structure</span>
            </div>
          </div>
          <div class="q-arrow" aria-hidden="true">‚ñæ</div>
        </summary>
        <div class="inside">
          <div class="bubble-row" id="rowNW"></div>
        </div>
      </details>

      <details class="quad" data-q="NE">
        <summary>
          <div class="q-left">
            <div class="q-badge"><span class="icon">‚òÄÔ∏è</span><span class="code">NE</span></div>
            <div class="q-text">
              <b>NORTHEAST</b>
              <span>Execution ¬∑ surfaces ¬∑ examples</span>
            </div>
          </div>
          <div class="q-arrow" aria-hidden="true">‚ñæ</div>
        </summary>
        <div class="inside">
          <div class="bubble-row" id="rowNE"></div>
        </div>
      </details>

      <details class="quad" data-q="SW">
        <summary>
          <div class="q-left">
            <div class="q-badge"><span class="icon">üèÆ</span><span class="code">SW</span></div>
            <div class="q-text">
              <b>SOUTHWEST</b>
              <span>Measurement ¬∑ diagnostics ¬∑ rules</span>
            </div>
          </div>
          <div class="q-arrow" aria-hidden="true">‚ñæ</div>
        </summary>
        <div class="inside">
          <div class="bubble-row" id="rowSW"></div>
        </div>
      </details>

      <details class="quad" data-q="SE">
        <summary>
          <div class="q-left">
            <div class="q-badge"><span class="icon">üåá</span><span class="code">SE</span></div>
            <div class="q-text">
              <b>SOUTHEAST</b>
              <span>Identity ¬∑ references ¬∑ links</span>
            </div>
          </div>
          <div class="q-arrow" aria-hidden="true">‚ñæ</div>
        </summary>
        <div class="inside">
          <div class="bubble-row" id="rowSE"></div>
        </div>
      </details>

      <footer>CANONICAL ¬∑ STABLE ¬∑ ¬© GEODIAMETRICS</footer>
      <div class="ink">GEODIAMETRICS</div>

    </div>
  </div>

  <!-- POP-OVER -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Detail popover">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">
          <b id="mTitle">DETAIL</b>
          <span id="mSubtitle">Tap bubbles to drill down. Close returns to where you were.</span>
        </div>
        <button class="close" id="mClose" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="lensbar" aria-label="Detail lens">
          <span class="pill">VIEW:</span>
          <button class="pill btn active" id="mLensOrigin" type="button">ORIGIN</button>
          <button class="pill btn" id="mLensNow" type="button">NOW</button>
          <button class="pill btn" id="mLensTraj" type="button">TRAJECTORY</button>
        </div>

        <div class="block">
          <h3 id="mH3">‚Äî</h3>
          <p id="mText">‚Äî</p>

          <div class="chips" id="mChips"></div>
          <div class="subgrid" id="mSubgrid"></div>

          <div class="jump-row" id="mJumpRow"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // GLOBAL STATE
    // ==========================
    const state = {
      lang: (localStorage.getItem("crp_lang") || "EN"),
      depth: (localStorage.getItem("crp_depth") || "EXPLORE"),
      lens: (localStorage.getItem("crp_lens") || "ORIGIN"),
      // popover stack: [{q, key, level, subkey}]
      stack: []
    };

    // ==========================
    // CONTENT MODEL (4‚Üí4‚Üí4)
    // ==========================
    // Each quadrant: 4 top bubbles. Each bubble: 4 sub-bubbles. Each sub-bubble has lens text.
    const MODEL = {
      NW: {
        title: "NORTHWEST",
        subtitle: "Definition ¬∑ language ¬∑ structure",
        jump: [
          {label:"Jump ¬∑ Laws", href:"/laws/"},
          {label:"Jump ¬∑ Categories", href:"/laws/categories/"}
        ],
        bubbles: [
          {
            key:"SSG",
            label:"SSG",
            hint:"Simplified Syntax Geometry",
            lens:{
              ORIGIN:"We needed a compact way to write app behavior as constraints instead of stories.",
              NOW:"SSG expresses behavior via Resources, Stores, Constraints, Goals, Guards (receipt-gated).",
              TRAJECTORY:"SSG becomes the contract layer for replay-safe execution across domains."
            },
            sub:[
              { key:"PRIMITIVES", label:"Primitives", hint:"R/S/C/G/Guards",
                lens:{
                  ORIGIN:"Separate what exists (Resource/Store) from what must hold (Constraint).",
                  NOW:"Use Goals + Guards to admit/deny transitions with a receipt.",
                  TRAJECTORY:"A common primitive set enables consistent tooling and audits."
                }
              },
              { key:"RECEIPTS", label:"Receipts", hint:"Gated advancement",
                lens:{
                  ORIGIN:"Progress must be provable‚Äîno invisible gates.",
                  NOW:"Advance only after a receipt; back-nav invalidates downstream receipts.",
                  TRAJECTORY:"Receipts become universal verification tokens across platforms."
                }
              },
              { key:"INVARIANTS", label:"Invariants", hint:"Navigation-first",
                lens:{
                  ORIGIN:"Prevent drift by keeping rules explicit.",
                  NOW:"No timers as gates; unified press primitives; atomic handoff with receipt.",
                  TRAJECTORY:"Invariant-first systems resist exploit and ambiguity at scale."
                }
              },
              { key:"EXAMPLES", label:"Examples", hint:"Small specs",
                lens:{
                  ORIGIN:"Show the smallest working unit.",
                  NOW:"Example specs map to deterministic screens/stores/guards.",
                  TRAJECTORY:"Examples become templates for certification + reuse."
                }
              }
            ]
          },
          {
            key:"DIAMOND_GRAMMAR",
            label:"Diamond Grammar",
            hint:"Four routes ¬∑ one choice",
            lens:{
              ORIGIN:"Navigation needed a fixed grammar that doesn‚Äôt drift under pressure.",
              NOW:"Every hub presents 4 routes; one choice at a time; return is always valid.",
              TRAJECTORY:"Diamond grammar becomes the universal traversal language (human + machine)."
            },
            sub:[
              { key:"RULE_ONE", label:"One choice", hint:"No multi-tab inside branch",
                lens:{ ORIGIN:"Confusion comes from parallel commitments.", NOW:"Choose one route; finish or return.", TRAJECTORY:"Reduces fragmentation in teams and systems." }
              },
              { key:"RETURN", label:"Return", hint:"Hub-first protocol",
                lens:{ ORIGIN:"Stops users getting trapped.", NOW:"Return to hub to choose again.", TRAJECTORY:"Return protocol becomes a safety standard." }
              },
              { key:"MAP", label:"Map", hint:"N/E/S/W meaning",
                lens:{ ORIGIN:"Directions encode functions, not geography.", NOW:"N=definition, E=execution, S=measurement, W=identity.", TRAJECTORY:"Encoding generalizes across any project." }
              },
              { key:"COMPRESSION", label:"Compression", hint:"Diamond vs panel",
                lens:{ ORIGIN:"Not all screens fit diamonds.", NOW:"Use diamond when possible; panel when dense.", TRAJECTORY:"Dual compression stays readable at scale." }
              }
            ]
          },
          {
            key:"DOT_GRID",
            label:"DOT.GRID",
            hint:"256-state indexing",
            lens:{
              ORIGIN:"We needed a way to label system states consistently for replay and audit.",
              NOW:"DOT.GRID provides a 256-state lattice for observer-consistent classification.",
              TRAJECTORY:"The lattice becomes a portable index for governance, safety, and measurement."
            },
            sub:[
              { key:"STATE", label:"State", hint:"256 lattice",
                lens:{ ORIGIN:"Avoid vague labels.", NOW:"Index state transitions explicitly.", TRAJECTORY:"Cross-domain comparability emerges." }
              },
              { key:"REPLAY", label:"Replay", hint:"Evidence stream",
                lens:{ ORIGIN:"If you can‚Äôt replay it, you can‚Äôt verify it.", NOW:"Re-run evidence through the same rules.", TRAJECTORY:"Replay becomes default for dispute resolution." }
              },
              { key:"AUDIT", label:"Audit", hint:"Observer-consistent",
                lens:{ ORIGIN:"Different observers must agree.", NOW:"Same evidence ‚Üí same classification.", TRAJECTORY:"Audits become fast, cheap, and standard." }
              },
              { key:"PACKS", label:"Packs", hint:"Exports",
                lens:{ ORIGIN:"Move data between rooms/systems.", NOW:"CSV/JSONL packs feed sweeps.", TRAJECTORY:"Packs become the shared interchange format." }
              }
            ]
          },
          {
            key:"ACRONYMS",
            label:"Acronyms",
            hint:"Pillar map + usage",
            lens:{
              ORIGIN:"We needed a consistent naming layer to prevent drift.",
              NOW:"Acronyms are categorized by pillars with usage notes and links.",
              TRAJECTORY:"Acronyms become searchable interface tokens across the platform."
            },
            sub:[
              { key:"CORE", label:"Core set", hint:"High-frequency",
                lens:{ ORIGIN:"Start with what repeats.", NOW:"List top recurring terms.", TRAJECTORY:"Core set becomes onboarding." }
              },
              { key:"PILLARS", label:"Pillars", hint:"Category map",
                lens:{ ORIGIN:"Group by function.", NOW:"Each pillar owns a glossary slice.", TRAJECTORY:"Pillars scale to 256." }
              },
              { key:"LOOKUP", label:"Lookup", hint:"Search rules",
                lens:{ ORIGIN:"Find terms fast.", NOW:"Prefix rules + tags.", TRAJECTORY:"Lookup becomes in-UI microsearch." }
              },
              { key:"EXAMPLES", label:"Examples", hint:"Usage",
                lens:{ ORIGIN:"Meaning comes from use.", NOW:"Short sentence examples.", TRAJECTORY:"Examples align teams quickly." }
              }
            ]
          }
        ]
      },

      NE: {
        title:"NORTHEAST",
        subtitle:"Execution ¬∑ surfaces ¬∑ examples",
        jump:[
          {label:"Jump ¬∑ Products", href:"/products/"},
          {label:"Jump ¬∑ RGSC", href:"/rgsc/"}
        ],
        bubbles:[
          { key:"SURFACES", label:"Execution Surfaces", hint:"Apps ¬∑ portals ¬∑ interfaces",
            lens:{ ORIGIN:"Expose the engine as usable workflow.", NOW:"Portals wrap rules into navigation-first screens.", TRAJECTORY:"Surfaces become standardized modules (portable UI)."},
            sub:[
              { key:"PORTALS", label:"Portals", hint:"Entry points", lens:{ ORIGIN:"Start simple.", NOW:"Each portal is one task lane.", TRAJECTORY:"Portals become products."}},
              { key:"UI_RULES", label:"UI Rules", hint:"Press primitives", lens:{ ORIGIN:"Stop inconsistent gestures.", NOW:"Unified press primitives.", TRAJECTORY:"Fewer bugs + fewer exploits."}},
              { key:"STATE", label:"State", hint:"Stores mapping", lens:{ ORIGIN:"State must be visible.", NOW:"Stores map to screens.", TRAJECTORY:"State becomes audit-ready."}},
              { key:"DEPLOY", label:"Deploy", hint:"Ship surfaces", lens:{ ORIGIN:"Make it runnable.", NOW:"Surface = packaged workflow.", TRAJECTORY:"Deployment becomes repeatable."}}
            ]
          },
          { key:"WORKFLOWS", label:"Workflows & Receipts", hint:"Audit trails ¬∑ replay safety",
            lens:{ ORIGIN:"Work must be provable.", NOW:"Receipts log decisions & transitions.", TRAJECTORY:"Receipts power dispute resolution."},
            sub:[
              { key:"TOKENS", label:"Tokens", hint:"Receipts", lens:{ ORIGIN:"Proof of step.", NOW:"Receipt per advancement.", TRAJECTORY:"Universal verification."}},
              { key:"TRAILS", label:"Trails", hint:"Audit", lens:{ ORIGIN:"Keep a chain.", NOW:"Immutable event trail.", TRAJECTORY:"Cheap compliance."}},
              { key:"REPLAY", label:"Replay", hint:"Re-run", lens:{ ORIGIN:"Verify later.", NOW:"Re-run evidence.", TRAJECTORY:"Automatic audits."}},
              { key:"EXIT", label:"Exit", hint:"Return token", lens:{ ORIGIN:"Leave safely.", NOW:"Exit emits terminal+return token.", TRAJECTORY:"Safe resumability."}}
            ]
          },
          { key:"EXAMPLES", label:"Examples", hint:"How to use system",
            lens:{ ORIGIN:"Teach by small moves.", NOW:"Examples show the drilldown pattern.", TRAJECTORY:"Examples become lessons + docs."},
            sub:[
              { key:"QUADRANTS", label:"Quadrants", hint:"NW/NE/SW/SE", lens:{ ORIGIN:"Explain the lanes.", NOW:"Each quadrant has 4 bubbles.", TRAJECTORY:"Pattern scales."}},
              { key:"CARDINAL", label:"Cardinal", hint:"N/E/S/W", lens:{ ORIGIN:"Map domains.", NOW:"Cardinal plate is the hub.", TRAJECTORY:"Universal compass."}},
              { key:"LENS", label:"Lens", hint:"Origin/Now/Trajectory", lens:{ ORIGIN:"Time context matters.", NOW:"One lens filters all content.", TRAJECTORY:"Coherent narratives."}},
              { key:"DEPTH", label:"Depth", hint:"Explore vs Learn", lens:{ ORIGIN:"Avoid overwhelm.", NOW:"Explore = surface, Learn = nested.", TRAJECTORY:"Adaptive density."}}
            ]
          },
          { key:"PACKS", label:"Packs & Outputs", hint:"Downloadables ¬∑ packaged artifacts",
            lens:{ ORIGIN:"Make results portable.", NOW:"Packs export structured outputs.", TRAJECTORY:"Outputs become product SKUs."},
            sub:[
              { key:"PDFS", label:"PDFs", hint:"Reports", lens:{ ORIGIN:"Readable artifacts.", NOW:"PDF summaries.", TRAJECTORY:"Standard bundles."}},
              { key:"DATA", label:"Data", hint:"CSV/JSONL", lens:{ ORIGIN:"Machine replay.", NOW:"Evidence exports.", TRAJECTORY:"Interoperable audits."}},
              { key:"TEMPLATES", label:"Templates", hint:"Copycode", lens:{ ORIGIN:"Fast reuse.", NOW:"TNT blocks.", TRAJECTORY:"Rapid scaling."}},
              { key:"KITS", label:"Kits", hint:"Starter packs", lens:{ ORIGIN:"Onboard.", NOW:"Packaged starter flows.", TRAJECTORY:"Marketplace-ready."}}
            ]
          }
        ]
      },

      SW: {
        title:"SOUTHWEST",
        subtitle:"Measurement ¬∑ diagnostics ¬∑ rules",
        jump:[
          {label:"Jump ¬∑ Gauges", href:"/gauges/"},
          {label:"Jump ¬∑ Diagnostic", href:"/diagnostic/"}
        ],
        bubbles:[
          { key:"GAUGES", label:"Gauges", hint:"Instrument panels ¬∑ thresholds",
            lens:{ ORIGIN:"Measure what matters.", NOW:"Panels track stability, drift, coherence signals.", TRAJECTORY:"Gauges become early-warning systems."},
            sub:[
              { key:"PANELS", label:"Panels", hint:"Dashboards", lens:{ ORIGIN:"See state.", NOW:"Panels display signals.", TRAJECTORY:"Standard dashboards."}},
              { key:"THRESH", label:"Thresholds", hint:"Bounds", lens:{ ORIGIN:"Define limits.", NOW:"Threshold rules trigger states.", TRAJECTORY:"Automated alerts."}},
              { key:"SIGNALS", label:"Signals", hint:"Inputs", lens:{ ORIGIN:"Choose inputs.", NOW:"Behavioral signals only.", TRAJECTORY:"Observer-invariant metrics."}},
              { key:"LOGS", label:"Logs", hint:"Records", lens:{ ORIGIN:"Keep history.", NOW:"Log every change.", TRAJECTORY:"Audit-ready."}}
            ]
          },
          { key:"DIAGNOSTICS", label:"Diagnostics", hint:"Classification under constraint",
            lens:{ ORIGIN:"Classify consistently.", NOW:"Coherence/drift/confusion categories.", TRAJECTORY:"Shared diagnostic language."},
            sub:[
              { key:"CATS", label:"Categories", hint:"Coherence/drift", lens:{ ORIGIN:"Name states.", NOW:"Stable classes.", TRAJECTORY:"Fast triage."}},
              { key:"TESTS", label:"Tests", hint:"Stress", lens:{ ORIGIN:"Probe limits.", NOW:"Run stress suites.", TRAJECTORY:"Continuous validation."}},
              { key:"INVAR", label:"Observer rule", hint:"Same evidence", lens:{ ORIGIN:"Prevent narrative bias.", NOW:"Evidence-only classification.", TRAJECTORY:"Trustworthy diagnostics."}},
              { key:"REC", label:"Receipts", hint:"Replay", lens:{ ORIGIN:"Verify.", NOW:"Replay driven.", TRAJECTORY:"Dispute resolution."}}
            ]
          },
          { key:"RULES", label:"Rules", hint:"Navigation + integrity",
            lens:{ ORIGIN:"Rules reduce chaos.", NOW:"Return protocol, one-choice rule, receipt gating.", TRAJECTORY:"Rules become standards."},
            sub:[
              { key:"ONE", label:"One choice", hint:"Single route", lens:{ ORIGIN:"Stop fragmentation.", NOW:"One choice at a time.", TRAJECTORY:"Higher coherence."}},
              { key:"RETURN", label:"Return", hint:"Hub-first", lens:{ ORIGIN:"Avoid traps.", NOW:"Return to choose again.", TRAJECTORY:"Safer systems."}},
              { key:"NO_TIMER", label:"No timers", hint:"No gates", lens:{ ORIGIN:"Timers create hidden force.", NOW:"No timers as gates.", TRAJECTORY:"Predictable UX."}},
              { key:"PRESS", label:"Press policy", hint:"Unified", lens:{ ORIGIN:"Consistency.", NOW:"Unified press primitives.", TRAJECTORY:"Lower defect rate."}}
            ]
          },
          { key:"PROTOCOLS", label:"Protocols", hint:"Return ¬∑ replay ¬∑ audit",
            lens:{ ORIGIN:"Operationalize rules.", NOW:"Protocols define how to run, stop, resume.", TRAJECTORY:"Protocols scale across orgs."},
            sub:[
              { key:"ENTRY", label:"Entry", hint:"Start", lens:{ ORIGIN:"Start clean.", NOW:"Entry sets lenses.", TRAJECTORY:"Fast onboarding."}},
              { key:"EXIT", label:"Exit", hint:"Stop", lens:{ ORIGIN:"Leave safely.", NOW:"Exit emits return token.", TRAJECTORY:"Resumable workflows."}},
              { key:"HANDOFF", label:"Handoff", hint:"Atomic", lens:{ ORIGIN:"No partial transfer.", NOW:"Atomic handoff with receipt.", TRAJECTORY:"Reliable delegation."}},
              { key:"AUDIT", label:"Audit", hint:"Replay", lens:{ ORIGIN:"Verify operations.", NOW:"Replay + compare.", TRAJECTORY:"Continuous compliance."}}
            ]
          }
        ]
      },

      SE: {
        title:"SOUTHEAST",
        subtitle:"Identity ¬∑ references ¬∑ links",
        jump:[
          {label:"Jump ¬∑ Links", href:"/links/"},
          {label:"Jump ¬∑ Contact", href:"/contact/"}
        ],
        bubbles:[
          { key:"ORCID", label:"ORCID", hint:"Research identity anchor",
            lens:{ ORIGIN:"Identity makes attribution stable.", NOW:"ORCID anchors the researcher profile.", TRAJECTORY:"Identity becomes verifiable across outputs."},
            sub:[
              { key:"ID", label:"ID", hint:"Canonical", lens:{ ORIGIN:"One stable identifier.", NOW:"ORCID iD used everywhere.", TRAJECTORY:"Attribution stays consistent."}},
              { key:"PUB", label:"Publications", hint:"Links", lens:{ ORIGIN:"Attach work.", NOW:"Link outputs.", TRAJECTORY:"Portable credibility."}},
              { key:"CITE", label:"Citation", hint:"Standard", lens:{ ORIGIN:"Make citations easy.", NOW:"Use consistent format.", TRAJECTORY:"Faster verification."}},
              { key:"VERIFY", label:"Verify", hint:"Proof", lens:{ ORIGIN:"Avoid imposters.", NOW:"Verified profile.", TRAJECTORY:"Trust layer."}}
            ]
          },
          { key:"OSF", label:"OSF", hint:"Project registry / preprints",
            lens:{ ORIGIN:"Registry makes work visible and persistent.", NOW:"OSF holds project nodes and materials.", TRAJECTORY:"Registry becomes the public spine."},
            sub:[
              { key:"NODES", label:"Nodes", hint:"Projects", lens:{ ORIGIN:"Separate scopes.", NOW:"Node per axis.", TRAJECTORY:"Scalable organization."}},
              { key:"FILES", label:"Files", hint:"Artifacts", lens:{ ORIGIN:"Publish evidence.", NOW:"Attach PDFs/data.", TRAJECTORY:"Reproducible work."}},
              { key:"ANALYTICS", label:"Analytics", hint:"Signals", lens:{ ORIGIN:"Measure reach.", NOW:"Monitor visits.", TRAJECTORY:"Trajectory tracking."}},
              { key:"UPDATES", label:"Updates", hint:"Changelog", lens:{ ORIGIN:"Show movement.", NOW:"Post updates.", TRAJECTORY:"Transparent evolution."}}
            ]
          },
          { key:"REFS", label:"References", hint:"Core citations / anchors",
            lens:{ ORIGIN:"References reduce ambiguity.", NOW:"Citations anchor claims to sources.", TRAJECTORY:"Better trust with less narrative."},
            sub:[
              { key:"CORE", label:"Core", hint:"Key refs", lens:{ ORIGIN:"Start minimal.", NOW:"Core set listed.", TRAJECTORY:"Expandable library."}},
              { key:"MAP", label:"Map", hint:"Where used", lens:{ ORIGIN:"Trace meaning.", NOW:"Reference map.", TRAJECTORY:"Faster learning."}},
              { key:"TERMS", label:"Terms", hint:"Glossary", lens:{ ORIGIN:"Define words.", NOW:"Terms tied to refs.", TRAJECTORY:"Consistent language."}},
              { key:"ETHICS", label:"Ethics", hint:"Boundaries", lens:{ ORIGIN:"Prevent misuse.", NOW:"Explicit bounds.", TRAJECTORY:"Safe scaling."}}
            ]
          },
          { key:"CONTACT", label:"Contact", hint:"Direct channel",
            lens:{ ORIGIN:"Direct channel enables collaboration.", NOW:"Use contact for partner/research inquiries.", TRAJECTORY:"Network growth with integrity."},
            sub:[
              { key:"CHANNEL", label:"Channel", hint:"Email/form", lens:{ ORIGIN:"One place.", NOW:"Direct link.", TRAJECTORY:"Scales outreach."}},
              { key:"PARTNER", label:"Partner", hint:"Collab", lens:{ ORIGIN:"Selective collaboration.", NOW:"Inquiry intake.", TRAJECTORY:"Structured partnerships."}},
              { key:"PRESS", label:"Press", hint:"Media", lens:{ ORIGIN:"Controlled story.", NOW:"Press path.", TRAJECTORY:"Public clarity."}},
              { key:"SEC", label:"Security", hint:"Report", lens:{ ORIGIN:"Protect IP.", NOW:"Report issues.", TRAJECTORY:"Safer platform."}}
            ]
          }
        ]
      }
    };

    // ==========================
    // RENDER HELPERS
    // ==========================
    const $ = (id) => document.getElementById(id);

    function setPills(){
      $("langPill").textContent = state.lang;
      $("depthPill").textContent = state.depth;

      // Global lens buttons
      $("lensOrigin").classList.toggle("active", state.lens==="ORIGIN");
      $("lensNow").classList.toggle("active", state.lens==="NOW");
      $("lensTraj").classList.toggle("active", state.lens==="TRAJECTORY");

      // Modal lens buttons mirror global
      $("mLensOrigin").classList.toggle("active", state.lens==="ORIGIN");
      $("mLensNow").classList.toggle("active", state.lens==="NOW");
      $("mLensTraj").classList.toggle("active", state.lens==="TRAJECTORY");
    }

    function renderQuadrant(q){
      const row = document.getElementById("row"+q);
      const data = MODEL[q];
      row.innerHTML = "";
      data.bubbles.forEach((b) => {
        const btn = document.createElement("div");
        btn.className = "bubble-btn";
        btn.setAttribute("role","button");
        btn.tabIndex = 0;
        btn.innerHTML = `
          <div class="lbl">
            <b>${escapeHtml(b.label)}</b>
            <i>${escapeHtml(b.hint)}</i>
          </div>
          <div class="go">‚ñ∂</div>
        `;
        btn.addEventListener("click", ()=> openModal({q, key:b.key, level:1}));
        btn.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") {e.preventDefault(); openModal({q, key:b.key, level:1});}});
        row.appendChild(btn);
      });
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ==========================
    // MODAL LOGIC (no scroll jump)
    // ==========================
    function openModal(node){
      state.stack = [node];
      renderModal();
      $("overlay").classList.add("on");
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      $("overlay").classList.remove("on");
      document.body.style.overflow = "";
      state.stack = [];
    }

    function currentNode(){ return state.stack[state.stack.length-1]; }

    function findBubble(q, key){
      const quad = MODEL[q];
      return quad.bubbles.find(x=>x.key===key);
    }

    function renderModal(){
      const n = currentNode();
      const quad = MODEL[n.q];
      const bubble = findBubble(n.q, n.key);

      $("mTitle").textContent = `${quad.title} ¬∑ ${bubble.label}`;
      $("mSubtitle").textContent = quad.subtitle;

      // Main text for selected bubble (lens-filtered)
      $("mH3").textContent = bubble.label;
      $("mText").textContent = bubble.lens[state.lens] || "";

      // Chips (Origin/Now/Trajectory quick toggles)
      const chips = $("mChips");
      chips.innerHTML = "";
      ["ORIGIN","NOW","TRAJECTORY"].forEach((L)=>{
        const c = document.createElement("div");
        c.className = "chip" + (L===state.lens ? " gold" : "");
        c.textContent = L;
        c.addEventListener("click", ()=>{ setLens(L); });
        chips.appendChild(c);
      });

      // Sub-bubbles (level 2): ALWAYS 4
      const sg = $("mSubgrid");
      sg.innerHTML = "";
      bubble.sub.forEach((s)=>{
        const btn = document.createElement("div");
        btn.className = "bubble-btn";
        btn.innerHTML = `
          <div class="lbl">
            <b>${escapeHtml(s.label)}</b>
            <i>${escapeHtml(s.hint)}</i>
          </div>
          <div class="go">‚ñ∂</div>
        `;
        btn.addEventListener("click", ()=>{
          // Level 3 = detailed block for the sub-bubble
          state.stack.push({q:n.q, key:n.key, level:2, subkey:s.key});
          renderSubDetail();
        });
        sg.appendChild(btn);
      });

      // Jump buttons (site jumps) + Jump Home (close)
      const jr = $("mJumpRow");
      jr.innerHTML = "";
      // Jump Home (close modal)
      const jHome = document.createElement("a");
      jHome.className = "jump gold";
      jHome.href = "#";
      jHome.textContent = "Jump ¬∑ Home";
      jHome.addEventListener("click",(e)=>{ e.preventDefault(); closeModal(); });
      jr.appendChild(jHome);

      // Optional site jumps (kept inside modal, not on page)
      quad.jump.forEach((j)=>{
        const a = document.createElement("a");
        a.className = "jump";
        a.href = j.href;
        a.textContent = j.label.toUpperCase();
        jr.appendChild(a);
      });

      // If the user is already on a sub-detail node, render it
      if(n.level===2 && n.subkey){
        renderSubDetail();
      }
    }

    function renderSubDetail(){
      const n = currentNode(); // level 2 node
      const quad = MODEL[n.q];
      const bubble = findBubble(n.q, n.key);
      const sub = bubble.sub.find(x=>x.key===n.subkey);

      $("mTitle").textContent = `${quad.title} ¬∑ ${bubble.label} ¬∑ ${sub.label}`;
      $("mH3").textContent = sub.label;
      $("mText").textContent = sub.lens[state.lens] || "";

      // Replace subgrid with a single ‚ÄúBack‚Äù + keep the four sub-bubbles visible (no drift)
      // (We keep the grid, but also add a top "Back one step" chip)
      const chips = $("mChips");
      const back = document.createElement("div");
      back.className = "chip";
      back.textContent = "BACK";
      back.addEventListener("click", ()=>{
        state.stack.pop();
        renderModal();
      });
      chips.prepend(back);
    }

    function setLens(L){
      state.lens = L;
      localStorage.setItem("crp_lens", L);
      setPills();
      if($("overlay").classList.contains("on")) renderModal();
    }

    // ==========================
    // INIT
    // ==========================
    function init(){
      setPills();

      ["NW","NE","SW","SE"].forEach(renderQuadrant);

      // Global lens buttons
      $("lensOrigin").addEventListener("click", ()=> setLens("ORIGIN"));
      $("lensNow").addEventListener("click", ()=> setLens("NOW"));
      $("lensTraj").addEventListener("click", ()=> setLens("TRAJECTORY"));

      // Modal lens buttons mirror global
      $("mLensOrigin").addEventListener("click", ()=> setLens("ORIGIN"));
      $("mLensNow").addEventListener("click", ()=> setLens("NOW"));
      $("mLensTraj").addEventListener("click", ()=> setLens("TRAJECTORY"));

      // Close actions
      $("mClose").addEventListener("click", closeModal);
      $("overlay").addEventListener("click", (e)=>{ if(e.target.id==="overlay") closeModal(); });
      document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && $("overlay").classList.contains("on")) closeModal(); });

      // Update state from storage (language/depth set elsewhere)
      $("langPill").textContent = state.lang;
      $("depthPill").textContent = state.depth;
    }

    init();
  </script>
</body>
</html>
