<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
  <style>
    .kv { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .status-dot {
      display:inline-block;
      width:10px;height:10px;
      border-radius:50%;
      margin-right:8px;
      background:#f0c000;
    }
    .status-ok { background:#2ecc71; }
    .status-degraded { background:#f1c40f; }
    .status-down { background:#e74c3c; }
  </style>
</head>

<body class="bg-gradient">
<main class="page">

  <section class="panel hero">
    <h1>Control</h1>
    <p class="subtitle">Live read-only gauges. Truth first. No actions forced.</p>
  </section>

  <section class="panel bubble">
    <h3>Truth source</h3>
    <div class="kv" id="source">
      https://geodiametrics-aggregator.smansfield635.workers.dev/metrics
    </div>

    <div class="grid-2">
      <div>
        <strong>Polling</strong><br/>
        <span id="poll">10s</span>
      </div>
      <div>
        <strong>Last updated</strong><br/>
        <span id="lastUpdated">—</span>
      </div>
      <div>
        <strong>Age (sec)</strong><br/>
        <span id="ageSec">—</span>
      </div>
      <div>
        <strong>Status</strong><br/>
        <span class="status-dot status-degraded" id="statusDot"></span>
        <span id="statusText">DEGRADED</span>
      </div>
    </div>
  </section>

  <section class="panel bubble">
    <div class="gauge-wrap">
      <div class="gauge" id="sessions">0</div>
      <label>Sessions</label>
    </div>
    <div class="gauge-wrap">
      <div class="gauge" id="pageviews">0</div>
      <label>Pageviews</label>
    </div>
    <div class="gauge-wrap">
      <div class="gauge" id="clicks">0</div>
      <label>Clicks</label>
    </div>
  </section>

  <section class="panel nav">
    <a class="btn" href="/home/">Home</a>
    <a class="btn" href="/engine/">Engine</a>
    <a class="btn" href="/laws/">Laws</a>
  </section>

</main>

<script>
const ENDPOINT = "https://geodiametrics-aggregator.smansfield635.workers.dev/metrics";
const POLL_MS = 10000;

async function refresh() {
  try {
    const res = await fetch(ENDPOINT, { cache: "no-store" });
    const data = await res.json();

    // Metrics
    document.getElementById("sessions").textContent = data.metrics.sessions;
    document.getElementById("pageviews").textContent = data.metrics.pageviews;
    document.getElementById("clicks").textContent = data.metrics.clicks;

    // Time handling
    const now = data.meta?.now ?? Date.now();
    const last = data.metrics.lastUpdated || 0;

    if (last > 0) {
      const age = Math.max(0, Math.floor((now - last) / 1000));
      document.getElementById("ageSec").textContent = age;
      document.getElementById("lastUpdated").textContent =
        new Date(last).toLocaleTimeString();
    } else {
      document.getElementById("ageSec").textContent = "—";
      document.getElementById("lastUpdated").textContent = "—";
    }

    // Status
    const status = data.status || "UNKNOWN";
    const dot = document.getElementById("statusDot");
    dot.className = "status-dot";

    if (status === "OPERATIONAL") dot.classList.add("status-ok");
    else if (status === "DEGRADED") dot.classList.add("status-degraded");
    else dot.classList.add("status-down");

    document.getElementById("statusText").textContent = status;

  } catch (e) {
    document.getElementById("statusText").textContent = "OFFLINE";
    document.getElementById("statusDot").className = "status-dot status-down";
  }
}

refresh();
setInterval(refresh, POLL_MS);
</script>

</body>
</html>
