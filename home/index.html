<!-- TNT — /home/index.html
     HUB A · MIRROR-RECURSIVE SPLINE ARCHITECTURE (MRSA) · CATEGORY-LOCKED
     LOCK (NON-NEGOTIABLE):
       - Geometry governs placement ONLY. Categories are immutable.
       - Band A (COMPASS / GENERATIVE / RECURSIVE): N · E · S · W (recursive Russian doll)
       - Band B (SYSTEM / REFERENTIAL / TERMINAL): APPENDIX · GLOSSARY · ABOUT · LINKS (terminal; no recursion)
     BEHAVIOR:
       - Click a plate → opens Focus Pane immediately (scrolls into view).
       - Focus Pane contains lens toggle (INFORMAL / FORMAL / BOTH) (inside pane).
       - Language is page-level only (EN / 中文 / ES) (top-right buttons).
       - Each node shows 3-line skeleton per lens (Aspect → Process → Resolution).
       - Each node includes:
           • Analog Layer sub-bubble
           • Reality binding line (tool/platform surface)
           • JI (Jump Index overlay) + JUMP (Jump Deck overlay)
     STATE:
       - URL: lang/style/time/depth
       - LS: gd_lang/gd_style/gd_time/gd_depth
     OWNERSHIP:
       - ui.css owns field (no html/body background styling)
       - branch.css geometry only
       - instruments.js canonical state loader
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HUB A · Index</title>

<link rel="stylesheet" href="/assets/ui.css"/>
<link rel="stylesheet" href="/assets/branch.css"/>
<script defer src="/assets/instruments.js"></script>

<style>
/* DO NOT TOUCH FIELD — ui.css owns html/body background */
a{color:inherit;text-decoration:none}
:root{--dockH:88px}

/* page */
.page{
  width:min(1100px,94vw);
  margin:0 auto;
  padding:14px 0 calc(var(--dockH) + 22px);
  display:flex;
  flex-direction:column;
  gap:12px;
  position:relative;
  z-index:5;
}

/* header */
.header{
  border:1px solid rgba(255,255,255,.10);
  border-radius:22px;
  background:rgba(0,0,0,.14);
  backdrop-filter:blur(10px);
  padding:14px 16px;
  box-shadow:0 24px 80px rgba(0,0,0,.55);
  position:relative;
  z-index:20;
}
.k{font-size:11px;letter-spacing:4px;text-transform:uppercase;opacity:.72;margin:0 0 6px}
.t{font-weight:950;font-size:24px;letter-spacing:.3px;margin:0 0 6px}
.s{font-size:13px;opacity:.82;line-height:1.5;margin:0;max-width:980px}
.ctrl{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-top:12px}
.metric{
  margin-top:10px;padding:10px 12px;border-radius:18px;
  border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.14);
  color:rgba(255,255,255,.86);line-height:1.45;font-size:13px;
}

/* language buttons (page-level only) */
.top-right{
  position:fixed;right:16px;top:16px;z-index:240;
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
}

/* bands */
.bandLabel{
  padding:10px 12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.12);
  color:rgba(255,255,255,.86);
  font-weight:950;
  letter-spacing:.2px;
}

/* 4-up rows */
.row4{
  display:grid;
  grid-template-columns:repeat(4, minmax(0, 1fr));
  gap:10px;
}
@media (max-width:980px){
  .row4{grid-template-columns:repeat(2, minmax(0, 1fr));}
}

/* jewel plates */
.plate{
  --c:#93C5FD;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.06), transparent 55%),
    linear-gradient(160deg, rgba(12,22,38,.92), rgba(7,11,18,.95));
  box-shadow:0 18px 60px rgba(0,0,0,.62);
  padding:14px 14px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
  display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
  position:relative;
}
.plate:hover{border-color:rgba(212,175,55,.35)}
.plate.active{
  border-color:rgba(212,175,55,.65);
  box-shadow:0 18px 60px rgba(0,0,0,.62),0 0 18px rgba(212,175,55,.22);
}
.pLeft{display:flex;gap:10px;align-items:flex-start;min-width:0}
.swatch{
  width:12px;height:12px;transform:rotate(45deg);border-radius:4px;background:var(--c);
  box-shadow:0 0 0 1px rgba(255,255,255,.12),0 0 14px rgba(0,0,0,.35);
  flex:0 0 auto;margin-top:4px;pointer-events:none;
}
.pTxt{min-width:0}
.pName{font-weight:950;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pHint{margin-top:6px;font-size:12.5px;opacity:.78;line-height:1.35}
.pChev{opacity:.75;font-size:18px;flex:0 0 auto;pointer-events:none}

/* focus pane */
.focus{
  border:1px solid rgba(255,255,255,.12);
  border-radius:22px;
  background:rgba(0,0,0,.16);
  backdrop-filter:blur(10px);
  box-shadow:0 24px 80px rgba(0,0,0,.55);
  padding:14px 16px;
  display:none;
}
.focus.show{display:block}
.fHead{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
.fTitle{margin:0;font-weight:950;letter-spacing:.2px;font-size:16px}
.fClose{border:0;background:transparent;color:#fff;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:12px}
.fClose:hover{background:rgba(255,255,255,.08)}

/* lens toggle inside pane */
.lensRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
.lensRow .btn{padding:10px 12px;border-radius:999px}

/* nodes */
.node{
  --c:#93C5FD;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:rgba(0,0,0,.18);
  overflow:hidden;
  box-shadow:0 12px 36px rgba(0,0,0,.45);
  margin-top:12px;
}
.nHead{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px 14px;cursor:pointer;font-weight:950;letter-spacing:.2px;
  touch-action:manipulation;
}
.nLeft{display:flex;align-items:center;gap:10px;min-width:0}
.nLabel{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nBody{
  display:none;
  padding:12px 14px 14px;
  border-top:1px solid rgba(255,255,255,.08);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
.node.open>.nBody{display:block}
.childStack{display:flex;flex-direction:column;gap:10px;margin-top:12px}

/* 3-line skeleton */
.line{
  margin:0;
  line-height:1.6;
  font-size:13.75px;
  color:rgba(255,255,255,.90);
}
.line + .line{margin-top:8px}
.line[data-lens="informal"]{display:none}
.line[data-lens="formal"]{display:block}
.view-informal .line[data-lens="formal"]{display:none}
.view-informal .line[data-lens="informal"]{display:block}
.view-both .line{display:block}

/* analog sub-bubble */
.subNode{border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.16);overflow:hidden;margin-top:10px}
.subHead{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;font-weight:950;letter-spacing:.2px;font-size:13px;touch-action:manipulation}
.subBody{display:none;padding:10px 12px 12px;border-top:1px solid rgba(255,255,255,.08)}
.subNode.open .subBody{display:block}
.analog{margin:0;line-height:1.55;font-size:13px;color:rgba(255,255,255,.86)}

/* reality binding */
.bind{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.14);
  color:rgba(255,255,255,.86);
  line-height:1.45;
  font-size:13px;
}

/* actions */
.actRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:12px}
.pill{
  display:inline-flex;align-items:center;justify-content:center;
  padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);font-weight:950;letter-spacing:.2px;cursor:pointer
}
.pill:hover{border-color:var(--gold)}
.pill:active{transform:scale(.98)}
.pill.ji{min-width:44px}

/* dock */
.dock{
  position:fixed;left:50%;
  bottom:max(10px, env(safe-area-inset-bottom));
  transform:translateX(-50%);
  z-index:220;
  width:min(980px,94vw);
  padding:10px 12px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(10px);
  box-shadow:0 18px 60px rgba(0,0,0,.55);
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:10px;
}
.dock .btn{width:100%;padding:10px 10px;border-radius:999px;white-space:nowrap}
@media (max-width:520px){:root{--dockH:92px}.dock{grid-template-columns:repeat(3, minmax(0,1fr))}}

/* overlays */
.ov{position:fixed;inset:0;z-index:500;display:none;background:rgba(0,0,0,.72);backdrop-filter:blur(10px)}
.ov.show{display:block}
.panel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(980px,94vw);height:min(86vh, 860px);z-index:510;display:none}
.panel.show{display:block}
.shell{height:100%;border-radius:22px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(160deg, rgba(12,22,38,.92), rgba(7,11,18,.95));box-shadow:0 60px 180px rgba(0,0,0,.85);overflow:hidden;display:flex;flex-direction:column}
.pHead{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid rgba(255,255,255,.08)}
.pTitle{margin:0;font-weight:950;letter-spacing:.2px;font-size:16px}
.pClose{border:0;background:transparent;color:#fff;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:12px}
.pClose:hover{background:rgba(255,255,255,.08)}
.pBody{padding:14px 16px 18px;overflow:auto;-webkit-overflow-scrolling:touch;flex:1 1 auto}
.dirList{display:flex;flex-direction:column;gap:10px}
.row{border:1px solid rgba(255,255,255,.10);border-radius:18px;background:rgba(0,0,0,.18);padding:12px 14px}
.rTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.rName{font-weight:950;letter-spacing:.2px}
.rSent{margin-top:6px;color:rgba(255,255,255,.86);line-height:1.45;font-size:13px}
</style>
</head>

<body>

<div class="page view-formal" id="page">

  <div class="header">
    <p class="k" id="hk">CARDINAL AXIS</p>
    <h1 class="t" id="ht">HUB A · Index</h1>
    <p class="s" id="hs">Compass (recursive) · System (terminal) · Orientation to scale</p>

    <div class="ctrl">
      <div></div>
    </div>

    <div class="metric" id="metric">Orientation before scale · Scale before claims</div>
  </div>

  <div class="bandLabel" id="labA">COMPASS</div>
  <div class="row4" id="bandA"></div>

  <div class="bandLabel" id="labB">SYSTEM</div>
  <div class="row4" id="bandB"></div>

  <div class="focus" id="focus">
    <div class="fHead">
      <h3 class="fTitle" id="fTitle">—</h3>
      <button class="fClose" id="fClose" type="button" aria-label="Close">✕</button>
    </div>

    <div class="lensRow">
      <button class="btn" id="lensInformal" type="button">INFORMAL</button>
      <button class="btn" id="lensFormal" type="button">FORMAL</button>
      <button class="btn" id="lensBoth" type="button">BOTH</button>
    </div>

    <div id="focusBody"></div>
  </div>

</div>

<div class="top-right">
  <button class="btn" id="btnEN" type="button">EN</button>
  <button class="btn" id="btnZH" type="button">中文</button>
  <button class="btn" id="btnES" type="button">ES</button>
</div>

<nav class="dock" aria-label="Bottom actions">
  <button class="btn" id="navExit" type="button">EXIT</button>
  <button class="btn" id="navJI" type="button">JUMP INDEX</button>
  <button class="btn" id="navJD" type="button">JUMP DECK</button>
  <button class="btn" id="navActive" type="button">ACTIVE</button>
</nav>

<!-- JI overlay -->
<div class="ov" id="ovJI"></div>
<div class="panel" id="panelJI" role="dialog" aria-modal="true">
  <div class="shell">
    <div class="pHead">
      <h3 class="pTitle" id="jiTitle">JUMP INDEX</h3>
      <button class="pClose" id="jiClose" type="button" aria-label="Close">✕</button>
    </div>
    <div class="pBody">
      <div class="dirList" id="jiList"></div>
    </div>
  </div>
</div>

<!-- JD overlay -->
<div class="ov" id="ovJD"></div>
<div class="panel" id="panelJD" role="dialog" aria-modal="true">
  <div class="shell">
    <div class="pHead">
      <h3 class="pTitle" id="jdTitle">JUMP DECK</h3>
      <button class="pClose" id="jdClose" type="button" aria-label="Close">✕</button>
    </div>
    <div class="pBody">
      <div class="dirList" id="jdBody"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs=new URLSearchParams(location.search);
  const lsGet=k=>{try{return localStorage.getItem(k)}catch(e){return null}};
  const lsSet=(k,v)=>{try{localStorage.setItem(k,String(v))}catch(e){}};

  let lang  = qs.get("lang")  || lsGet("gd_lang")  || "en";
  let style = qs.get("style") || lsGet("gd_style") || "formal";
  let time  = qs.get("time")  || lsGet("gd_time")  || "now";
  let depth = qs.get("depth") || lsGet("gd_depth") || "explore";

  if(lang!=="en" && lang!=="zh" && lang!=="es") lang="en";
  if(style!=="formal" && style!=="informal") style="formal";
  if(time!=="origin" && time!=="now" && time!=="post") time="now";
  if(depth!=="explore" && depth!=="learn") depth="explore";

  lsSet("gd_lang",lang); lsSet("gd_style",style); lsSet("gd_time",time); lsSet("gd_depth",depth);
  document.documentElement.lang = (lang==="zh") ? "zh" : (lang==="es" ? "es" : "en");

  function makeQS(over){
    const p=new URLSearchParams();
    p.set("lang",  (over&&over.lang)  || lang);
    p.set("style", (over&&over.style) || style);
    p.set("time",  (over&&over.time)  || time);
    p.set("depth", (over&&over.depth) || depth);
    return "?"+p.toString();
  }

  // language buttons
  const btnEN=document.getElementById("btnEN");
  const btnZH=document.getElementById("btnZH");
  const btnES=document.getElementById("btnES");
  function paintLang(){
    btnEN.classList.toggle("active", lang==="en");
    btnZH.classList.toggle("active", lang==="zh");
    btnES.classList.toggle("active", lang==="es");
  }
  paintLang();
  function setLang(next){
    if(next!=="en"&&next!=="zh"&&next!=="es") next="en";
    lang=next; lsSet("gd_lang",lang);
    history.replaceState({}, "", location.pathname + makeQS({lang}));
    location.reload();
  }
  btnEN.onclick=()=>setLang("en");
  btnZH.onclick=()=>setLang("zh");
  btnES.onclick=()=>setLang("es");

  const L={
    en:{A:"COMPASS",B:"SYSTEM",metric:"Orientation before scale · Scale before claims",inf:"INFORMAL",frm:"FORMAL",both:"BOTH",analog:"Analog Layer",ji:"JUMP INDEX",jd:"JUMP DECK",active:"ACTIVE",exit:"EXIT"},
    zh:{A:"罗盘",B:"系统",metric:"先导览 · 再规模 · 再主张",inf:"非正式",frm:"正式",both:"两者",analog:"类比层",ji:"跳转目录",jd:"跳转卡组",active:"当前",exit:"退出"},
    es:{A:"BRÚJULA",B:"SISTEMA",metric:"Orientación · Escala · Afirmaciones",inf:"INFORMAL",frm:"FORMAL",both:"AMBOS",analog:"Capa Analógica",ji:"ÍNDICE",jd:"MAZO",active:"ACTIVO",exit:"SALIR"}
  };
  const T = (lang==="zh")?L.zh:(lang==="es")?L.es:L.en;

  document.getElementById("labA").textContent=T.A;
  document.getElementById("labB").textContent=T.B;
  document.getElementById("metric").textContent=T.metric;

  // lens buttons inside focus
  const pageEl=document.getElementById("page");
  const lensInformal=document.getElementById("lensInformal");
  const lensFormal=document.getElementById("lensFormal");
  const lensBoth=document.getElementById("lensBoth");
  lensInformal.textContent=T.inf;
  lensFormal.textContent=T.frm;
  lensBoth.textContent=T.both;

  function applyLens(v){
    pageEl.classList.remove("view-formal","view-informal","view-both");
    pageEl.classList.add("view-"+v);
    lensInformal.classList.toggle("active", v==="informal");
    lensFormal.classList.toggle("active", v==="formal");
    lensBoth.classList.toggle("active", v==="both");
    lsSet("hub_view", v);
  }
  applyLens(lsGet("hub_view") || (style==="informal" ? "informal" : "formal"));
  lensInformal.onclick=()=>applyLens("informal");
  lensFormal.onclick=()=>applyLens("formal");
  lensBoth.onclick=()=>applyLens("both");

  // tree (minimal for demo; expand later by barcode table)
  const TREE = {
    N:{label:{en:"N · DEFINITIONS",zh:"N · 定义",es:"N · DEFINICIONES"}, color:"#1F3A8A", children:["N:NE","N:NW","N:SE","N:SW"]},
    E:{label:{en:"E · PRODUCTS",zh:"E · 产品",es:"E · PRODUCTOS"}, color:"#0EA5E9", children:["E:NE","E:NW","E:SE","E:SW"]},
    S:{label:{en:"S · CONSTRAINTS",zh:"S · 约束",es:"S · RESTRICCIONES"}, color:"#F59E0B", children:["S:NE","S:NW","S:SE","S:SW"]},
    W:{label:{en:"W · CONTAINMENT",zh:"W · 隔离",es:"W · CONTENCIÓN"}, color:"#7F1D1D", children:["W:NE","W:NW","W:SE","W:SW"]},
    APPENDIX:{label:{en:"APPENDIX",zh:"附录",es:"APÉNDICE"}, color:"#A3A3A3", children:[]},
    GLOSSARY:{label:{en:"GLOSSARY",zh:"术语表",es:"GLOSARIO"}, color:"#93C5FD", children:[]},
    ABOUT:{label:{en:"ABOUT",zh:"关于",es:"ACERCA"}, color:"#D4AF37", children:[]},
    LINKS:{label:{en:"LINKS",zh:"链接",es:"ENLACES"}, color:"#60A5FA", children:[]},

    "N:NE":{label:{en:"NE",zh:"NE",es:"NE"}, color:"#2C3EAF", children:[]},
    "N:NW":{label:{en:"NW",zh:"NW",es:"NW"}, color:"#9333EA", children:[]},
    "N:SE":{label:{en:"SE",zh:"SE",es:"SE"}, color:"#14B8A6", children:[]},
    "N:SW":{label:{en:"SW",zh:"SW",es:"SW"}, color:"#EA580C", children:[]},

    "E:NE":{label:{en:"NE",zh:"NE",es:"NE"}, color:"#2C3EAF", children:[]},
    "E:NW":{label:{en:"NW",zh:"NW",es:"NW"}, color:"#9333EA", children:[]},
    "E:SE":{label:{en:"SE",zh:"SE",es:"SE"}, color:"#14B8A6", children:[]},
    "E:SW":{label:{en:"SW",zh:"SW",es:"SW"}, color:"#EA580C", children:[]},

    "S:NE":{label:{en:"NE",zh:"NE",es:"NE"}, color:"#2C3EAF", children:[]},
    "S:NW":{label:{en:"NW",zh:"NW",es:"NW"}, color:"#9333EA", children:[]},
    "S:SE":{label:{en:"SE",zh:"SE",es:"SE"}, color:"#14B8A6", children:[]},
    "S:SW":{label:{en:"SW",zh:"SW",es:"SW"}, color:"#EA580C", children:[]},

    "W:NE":{label:{en:"NE",zh:"NE",es:"NE"}, color:"#2C3EAF", children:[]},
    "W:NW":{label:{en:"NW",zh:"NW",es:"NW"}, color:"#9333EA", children:[]},
    "W:SE":{label:{en:"SE",zh:"SE",es:"SE"}, color:"#14B8A6", children:[]},
    "W:SW":{label:{en:"SW",zh:"SW",es:"SW"}, color:"#EA580C", children:[]}
  };

  function nodeLabel(id){
    const o=TREE[id] && TREE[id].label;
    if(!o) return id;
    if(lang==="zh") return o.zh;
    if(lang==="es") return o.es || o.en;
    return o.en;
  }

  function skeleton(id, lens){
    const core = id.split(":")[0];
    const isSystem = (id==="APPENDIX"||id==="GLOSSARY"||id==="ABOUT"||id==="LINKS");
    // simple universal skeleton, non-repeating, bounded
    if(lang==="zh"){
      if(isSystem){
        if(id==="APPENDIX") return lens==="formal"?["用途：收纳包。","过程：统一引用。","结果：可溯源。"]:["附录：集中关键包。","少找，多用。","需要就跳。"];
        if(id==="GLOSSARY") return lens==="formal"?["用途：锁术语。","过程：防漂移。","结果：可比较。"]:["术语表：同词同义。","减少争论。","需要就跳。"];
        if(id==="ABOUT") return lens==="formal"?["用途：声明边界。","过程：防膨胀。","结果：少误读。"]:["关于：是什么/不是什么。","不卖信仰。","需要就跳。"];
        return lens==="formal"?["用途：外部锚点。","过程：直达证据。","结果：可核查。"]:["链接：直达锚点。","少解释。","需要就跳。"];
      }
      if(lens==="formal"){
        if(core==="N") return ["定义：范围先于权力。","过程：锁语义→控扩张。","结果：漂移收敛。"];
        if(core==="E") return ["执行：继承边界条件。","过程：执行面不越界。","结果：可复制。"];
        if(core==="S") return ["闸门：约束定义可采信。","过程：无证据拒绝。","结果：扩张有序。"];
        if(core==="W") return ["隔离：失败局部化。","过程：分段/回滚。","结果：恢复一致性。"];
      }else{
        if(core==="N") return ["先钉住含义。","再谈怎么走。","不然会漂。"];
        if(core==="E") return ["先守边界。","再上线扩张。","否则反噬。"];
        if(core==="S") return ["闸门先行。","没边界就停。","否则腐化。"];
        if(core==="W") return ["先隔离。","再修复。","避免级联。"];
      }
    }else if(lang==="es"){
      if(isSystem){
        if(id==="APPENDIX") return lens==="formal"?["Propósito: paquetes.","Proceso: referencia única.","Resultado: proveniencia."]:["Apéndice: todo junto.","Menos búsqueda.","Salta cuando quieras."];
        if(id==="GLOSSARY") return lens==="formal"?["Propósito: fijar términos.","Proceso: bloquear deriva.","Resultado: comparabilidad."]:["Glosario: mismas palabras.","Menos ruido.","Salta cuando quieras."];
        if(id==="ABOUT") return lens==="formal"?["Propósito: límites.","Proceso: evitar inflación.","Resultado: menos errores."]:["Acerca: qué es/qué no es.","Sin venta.","Salta cuando quieras."];
        return lens==="formal"?["Propósito: anclas externas.","Proceso: evidencia directa.","Resultado: verificable."]:["Enlaces: directo a anclas.","Sin charla.","Salta cuando quieras."];
      }
      if(lens==="formal"){
        if(core==="N") return ["Definición: alcance primero.","Proceso: fijar significado.","Resultado: menos deriva."];
        if(core==="E") return ["Ejecución: límites heredados.","Proceso: superficie acotada.","Resultado: réplica estable."];
        if(core==="S") return ["Compuertas: admisibilidad.","Proceso: rechazo sin evidencia.","Resultado: escala disciplinada."];
        if(core==="W") return ["Contención: fallo local.","Proceso: segmentar/rollback.","Resultado: coherencia."];
      }else{
        if(core==="N") return ["Fija el significado.","Luego avanzas.","Si no, deriva."];
        if(core==="E") return ["Ejecuta con límites.","Si no, te rompe.","Escala amplifica."];
        if(core==="S") return ["Compuertas primero.","Sin límites, no.","O se pudre."];
        if(core==="W") return ["Aísla y repara.","Corta cascada.","Vuelve estable."];
      }
    }else{
      if(isSystem){
        if(id==="APPENDIX") return lens==="formal"?["Purpose: packets.","Process: single reference.","Result: provenance."]:["Appendix: everything in one place.","Less hunting.","Jump when needed."];
        if(id==="GLOSSARY") return lens==="formal"?["Purpose: lock terms.","Process: prevent drift.","Result: comparability."]:["Glossary: same words.","Less arguing.","Jump when needed."];
        if(id==="ABOUT") return lens==="formal"?["Purpose: posture + limits.","Process: prevent inflation.","Result: fewer misreads."]:["About: what it is / isn’t.","No selling.","Jump when needed."];
        return lens==="formal"?["Purpose: external anchors.","Process: direct evidence.","Result: verifiable."]:["Links: direct anchors.","No talk.","Jump when needed."];
      }
      if(lens==="formal"){
        if(core==="N") return ["Definition: scope first.","Process: lock meaning.","Result: drift reduced."];
        if(core==="E") return ["Execution: bounded surfaces.","Process: inherit limits.","Result: stable replication."];
        if(core==="S") return ["Gates: admissibility.","Process: refuse without evidence.","Result: disciplined scale."];
        if(core==="W") return ["Containment: local failure.","Process: segment/rollback.","Result: coherence restored."];
      }else{
        if(core==="N") return ["Lock meaning.","Then move.","Or drift."];
        if(core==="E") return ["Execute inside limits.","Scale amplifies failure.","Working wins."];
        if(core==="S") return ["Gate first.","No limits, no scale.","Or rot."];
        if(core==="W") return ["Isolate and repair.","Stop cascade.","Return stable."];
      }
    }
    return ["—","—","—"];
  }

  function analogSentence(id){
    const core = id.split(":")[0];
    if(lang==="zh"){
      if(core==="N") return "边界/宪制/不变量：定义层的统一锚点。";
      if(core==="E") return "执行/转移/部署：把结构变成可用表面。";
      if(core==="S") return "门控/验证/阶段：压力下保持可采信。";
      if(core==="W") return "隔离/回滚/恢复：阻断级联。";
      return "参考节点：语义稳定与外部锚点。";
    }
    if(lang==="es"){
      if(core==="N") return "Límites/constitución/invariantes: ancla de definición.";
      if(core==="E") return "Ejecución/transición/despliegue: superficie utilizable.";
      if(core==="S") return "Compuertas/validación/fases: admisibilidad bajo presión.";
      if(core==="W") return "Contención/rollback/recuperación: cortar cascada.";
      return "Nodos de referencia: estabilidad semántica y anclas.";
    }
    if(core==="N") return "Boundaries/constitution/invariants: definition anchor.";
    if(core==="E") return "Execution/transition/deployment: usable surfaces.";
    if(core==="S") return "Gating/validation/phases: admissibility under pressure.";
    if(core==="W") return "Containment/rollback/recovery: stop cascade.";
    return "Reference nodes: semantic stability and anchors.";
  }

  // reality bindings (platform spine)
  const BIND = {
    N:{label:{en:"Coherence Diagnostic + Laws",zh:"一致性诊断 + 法则",es:"Diagnóstico + Leyes"}, route:"/laws/", sentence:{
      en:"Pins meaning and admissibility so every downstream claim stays bounded.",
      zh:"锁定语义与可采信，保证下游主张有界。",
      es:"Fija significado y admisibilidad para acotar afirmaciones."
    }},
    E:{label:{en:"Products (Platforms)",zh:"产品（平台）",es:"Productos (Plataformas)"}, route:"/products/", sentence:{
      en:"Maps structure into deployable adoption surfaces without exceeding scope.",
      zh:"把结构映射为可部署采纳面且不越界。",
      es:"Convierte estructura en superficies desplegables sin exceder alcance."
    }},
    S:{label:{en:"Adoption Ladder + Gates",zh:"采纳阶梯 + 闸门",es:"Escalera + Compuertas"}, route:"/products/adoption-ladder/", sentence:{
      en:"Defines phase gates that prevent scaling beyond verification capacity.",
      zh:"定义阶段门控，防止超出核查能力的扩张。",
      es:"Define compuertas por fases para evitar escalar sin verificación."
    }},
    W:{label:{en:"Containment + Enforcement",zh:"隔离 + 执行",es:"Contención + Ejecución"}, route:"/laws/", sentence:{
      en:"Keeps failures local and enforces rollback discipline under load.",
      zh:"让失败局部化，并在负载下执行回滚纪律。",
      es:"Mantiene fallos locales y disciplina de rollback bajo carga."
    }},
    APPENDIX:{label:{en:"Appendix",zh:"附录",es:"Apéndice"}, route:"/appendix/", sentence:{
      en:"Centralizes packets, receipts, and provenance surfaces.",
      zh:"集中协议包、收据与溯源面。",
      es:"Centraliza paquetes, recibos y proveniencia."
    }},
    GLOSSARY:{label:{en:"Glossary",zh:"术语表",es:"Glosario"}, route:"/glossary/", sentence:{
      en:"Locks canonical terms to prevent semantic drift across the site.",
      zh:"锁定规范术语，防止跨页语义漂移。",
      es:"Fija términos canónicos para evitar deriva semántica."
    }},
    ABOUT:{label:{en:"About",zh:"关于",es:"Acerca"}, route:"/about/", sentence:{
      en:"States posture and boundaries to prevent claim inflation.",
      zh:"声明姿态与边界，避免主张膨胀。",
      es:"Declara postura y límites para evitar inflación."
    }},
    LINKS:{label:{en:"Links",zh:"链接",es:"Enlaces"}, route:"/links/", sentence:{
      en:"Routes to external anchors for verification and provenance.",
      zh:"指向外部锚点以便核查与溯源。",
      es:"Enruta a anclas externas para verificación y proveniencia."
    }}
  };

  function bindLine(id){
    const key = (id in BIND) ? id : (id.split(":")[0]);
    const pack = BIND[key];
    if(!pack){
      return (lang==="zh")?"绑定：未设定":"Bind: not set";
    }
    const lbl = (lang==="zh")?pack.label.zh:(lang==="es")?(pack.label.es||pack.label.en):pack.label.en;
    const sent = (lang==="zh")?pack.sentence.zh:(lang==="es")?(pack.sentence.es||pack.sentence.en):pack.sentence.en;
    return lbl + " — " + sent;
  }

  function bindRoute(id){
    const key = (id in BIND) ? id : (id.split(":")[0]);
    const pack = BIND[key];
    return pack ? pack.route : "#";
  }

  // overlays
  const ovJI=document.getElementById("ovJI");
  const panelJI=document.getElementById("panelJI");
  const jiClose=document.getElementById("jiClose");
  const jiTitle=document.getElementById("jiTitle");
  const jiList=document.getElementById("jiList");

  const ovJD=document.getElementById("ovJD");
  const panelJD=document.getElementById("panelJD");
  const jdClose=document.getElementById("jdClose");
  const jdTitle=document.getElementById("jdTitle");
  const jdBody=document.getElementById("jdBody");

  function openJI(){
    jiTitle.textContent = (lang==="zh")?"跳转目录":(lang==="es")?"ÍNDICE":"JUMP INDEX";
    jiList.innerHTML="";
    Object.keys(TREE).forEach(id=>{
      if(id.indexOf(":")>=0) return; // keep index minimal: top-level only
      const row=document.createElement("div");
      row.className="row";
      const top=document.createElement("div");
      top.className="rTop";
      const nm=document.createElement("div");
      nm.className="rName";
      nm.textContent=nodeLabel(id);
      const act=document.createElement("div");
      const jb=document.createElement("button");
      jb.className="btn"; jb.type="button";
      jb.textContent=(lang==="zh")?"打开":(lang==="es")?"ABRIR":"OPEN";
      jb.onclick=()=>openJD(id);
      act.appendChild(jb);
      top.appendChild(nm);
      top.appendChild(act);

      const view = lsGet("hub_view") || (style==="informal" ? "informal" : "formal");
      const sent=document.createElement("div");
      sent.className="rSent";
      sent.textContent = skeleton(id, view==="both" ? "formal" : view)[0];

      row.appendChild(top);
      row.appendChild(sent);
      jiList.appendChild(row);
    });
    ovJI.classList.add("show");
    panelJI.classList.add("show");
  }
  function closeJI(){ovJI.classList.remove("show");panelJI.classList.remove("show");}

  function openJD(id){
    jdTitle.textContent = (lang==="zh")?"跳转卡组":(lang==="es")?"MAZO":"JUMP DECK";
    jdBody.innerHTML="";

    const row=document.createElement("div");
    row.className="row";

    const top=document.createElement("div");
    top.className="rTop";
    const nm=document.createElement("div");
    nm.className="rName";
    nm.textContent=nodeLabel(id);
    top.appendChild(nm);
    row.appendChild(top);

    const view = lsGet("hub_view") || (style==="informal" ? "informal" : "formal");
    const lines = skeleton(id, view==="both" ? "formal" : view);

    const s=document.createElement("div");
    s.className="rSent";
    s.textContent = lines.join(" ");
    row.appendChild(s);

    const a=document.createElement("div");
    a.className="rSent";
    a.textContent = analogSentence(id);
    row.appendChild(a);

    const b=document.createElement("div");
    b.className="rSent";
    b.textContent = bindLine(id);
    row.appendChild(b);

    const go=document.createElement("div");
    go.className="rSent";
    go.style.opacity=".8";
    go.textContent = (lang==="zh") ? "（跳转）进入对应平台/页面。"
                    : (lang==="es") ? "(Salto) Ir a la superficie correspondiente."
                    : "(Jump) Go to the corresponding surface.";
    row.appendChild(go);

    const btn=document.createElement("a");
    btn.className="btn";
    const route = bindRoute(id);
    btn.href = (route==="#" ? "#" : (route + makeQS()));
    btn.textContent = (lang==="zh")?"跳转":(lang==="es")?"SALTAR":"JUMP";
    row.appendChild(btn);

    jdBody.appendChild(row);

    ovJD.classList.add("show");
    panelJD.classList.add("show");
    lsSet("hub_active_node", id);
  }
  function closeJD(){ovJD.classList.remove("show");panelJD.classList.remove("show");}

  ovJI.addEventListener("pointerup", (e)=>{e.preventDefault();closeJI();}, {passive:false});
  ovJD.addEventListener("pointerup", (e)=>{e.preventDefault();closeJD();}, {passive:false});
  jiClose.onclick=closeJI;
  jdClose.onclick=closeJD;
  panelJI.onclick=(e)=>e.stopPropagation();
  panelJD.onclick=(e)=>e.stopPropagation();

  // focus open
  const focus=document.getElementById("focus");
  const fTitle=document.getElementById("fTitle");
  const fClose=document.getElementById("fClose");
  const focusBody=document.getElementById("focusBody");

  function buildAnalogSub(id){
    const sub=document.createElement("div");
    sub.className="subNode";
    const sh=document.createElement("div");
    sh.className="subHead";
    sh.innerHTML="<div>"+T.analog+"</div><div>▸</div>";
    const sb=document.createElement("div");
    sb.className="subBody";
    const ap=document.createElement("p");
    ap.className="analog";
    ap.textContent=analogSentence(id);
    sb.appendChild(ap);
    sub.appendChild(sh);
    sub.appendChild(sb);
    sh.onclick=(e)=>{e.stopPropagation();sub.classList.toggle("open");};
    return sub;
  }

  function buildActions(id){
    const act=document.createElement("div");
    act.className="actRow";

    const ji=document.createElement("div");
    ji.className="pill ji";
    ji.textContent="JI";
    ji.onclick=(e)=>{e.stopPropagation();openJI();};

    const jump=document.createElement("div");
    jump.className="pill";
    jump.textContent=(lang==="zh")?"跳转":(lang==="es")?"SALTAR":"JUMP";
    jump.onclick=(e)=>{e.stopPropagation();openJD(id);};

    act.appendChild(ji);
    act.appendChild(jump);
    return act;
  }

  function buildBindBox(id){
    const b=document.createElement("div");
    b.className="bind";
    b.textContent = bindLine(id);
    return b;
  }

  function buildRecursiveNode(id){
    const info=TREE[id];
    const node=document.createElement("section");
    node.className="node";
    node.style.setProperty("--c", info.color || "#93C5FD");

    const head=document.createElement("div");
    head.className="nHead";
    head.innerHTML="<div class='nLeft'><div class='swatch'></div><div class='nLabel'>"+nodeLabel(id)+"</div></div><div>▸</div>";
    head.querySelector(".swatch").style.background=(info.color||"#93C5FD");

    const body=document.createElement("div");
    body.className="nBody";

    const inf = skeleton(id,"informal");
    const frm = skeleton(id,"formal");

    ["informal",inf[0],inf[1],inf[2]].forEach((v,i)=>{
      if(i===0) return;
      const p=document.createElement("p");
      p.className="line"; p.dataset.lens="informal"; p.textContent=v;
      body.appendChild(p);
    });
    ["formal",frm[0],frm[1],frm[2]].forEach((v,i)=>{
      if(i===0) return;
      const p=document.createElement("p");
      p.className="line"; p.dataset.lens="formal"; p.textContent=v;
      body.appendChild(p);
    });

    body.appendChild(buildAnalogSub(id));
    body.appendChild(buildBindBox(id));
    body.appendChild(buildActions(id));

    if(info.children && info.children.length){
      const stack=document.createElement("div");
      stack.className="childStack";
      info.children.forEach(child=>stack.appendChild(buildRecursiveNode(child)));
      body.appendChild(stack);
    }

    head.onclick=()=>node.classList.toggle("open");
    node.appendChild(head);
    node.appendChild(body);
    return node;
  }

  function buildTerminalNode(id){
    const info=TREE[id];
    const node=document.createElement("section");
    node.className="node";
    node.style.setProperty("--c", info.color || "#93C5FD");

    const head=document.createElement("div");
    head.className="nHead";
    head.innerHTML="<div class='nLeft'><div class='swatch'></div><div class='nLabel'>"+nodeLabel(id)+"</div></div><div>▸</div>";
    head.querySelector(".swatch").style.background=(info.color||"#93C5FD");

    const body=document.createElement("div");
    body.className="nBody";

    const inf = skeleton(id,"informal");
    const frm = skeleton(id,"formal");

    [inf[0],inf[1],inf[2]].forEach(v=>{
      const p=document.createElement("p");
      p.className="line"; p.dataset.lens="informal"; p.textContent=v;
      body.appendChild(p);
    });
    [frm[0],frm[1],frm[2]].forEach(v=>{
      const p=document.createElement("p");
      p.className="line"; p.dataset.lens="formal"; p.textContent=v;
      body.appendChild(p);
    });

    body.appendChild(buildBindBox(id));
    body.appendChild(buildActions(id));

    head.onclick=()=>node.classList.toggle("open");
    node.appendChild(head);
    node.appendChild(body);
    return node;
  }

  function openFocus(rootId){
    lsSet("hub_active_node", rootId);
    fTitle.textContent=nodeLabel(rootId);
    focusBody.innerHTML="";

    const isCompass = (rootId==="N"||rootId==="E"||rootId==="S"||rootId==="W");
    focusBody.appendChild(isCompass ? buildRecursiveNode(rootId) : buildTerminalNode(rootId));

    focus.classList.add("show");

    document.querySelectorAll(".plate").forEach(p=>{
      p.classList.toggle("active", p.dataset.id===rootId);
    });

    setTimeout(()=>focus.scrollIntoView({behavior:"smooth", block:"start"}), 0);
  }

  fClose.onclick=()=>{
    focus.classList.remove("show");
    document.querySelectorAll(".plate").forEach(p=>p.classList.remove("active"));
  };

  // build plates
  const bandA=document.getElementById("bandA");
  const bandB=document.getElementById("bandB");
  const ORDER_A=["N","E","S","W"];
  const ORDER_B=["APPENDIX","GLOSSARY","ABOUT","LINKS"];

  function plateHint(id){
    const view = lsGet("hub_view") || (style==="informal" ? "informal" : "formal");
    return skeleton(id, view==="both" ? "formal" : view)[0];
  }

  function makePlate(id){
    const info=TREE[id];
    const p=document.createElement("div");
    p.className="plate";
    p.dataset.id=id;
    p.style.setProperty("--c", info.color || "#93C5FD");

    const left=document.createElement("div");
    left.className="pLeft";
    const sw=document.createElement("div");
    sw.className="swatch";
    const txt=document.createElement("div");
    txt.className="pTxt";
    const name=document.createElement("div");
    name.className="pName";
    name.textContent=nodeLabel(id);
    const hint=document.createElement("div");
    hint.className="pHint";
    hint.textContent=plateHint(id);

    txt.appendChild(name);
    txt.appendChild(hint);
    left.appendChild(sw);
    left.appendChild(txt);

    const chev=document.createElement("div");
    chev.className="pChev";
    chev.textContent="›";

    p.appendChild(left);
    p.appendChild(chev);
    p.onclick=()=>openFocus(id);
    return p;
  }

  bandA.innerHTML=""; ORDER_A.forEach(id=>bandA.appendChild(makePlate(id)));
  bandB.innerHTML=""; ORDER_B.forEach(id=>bandB.appendChild(makePlate(id)));

  // dock
  const navExit=document.getElementById("navExit");
  const navJI=document.getElementById("navJI");
  const navJD=document.getElementById("navJD");
  const navActive=document.getElementById("navActive");
  navExit.textContent=T.exit;
  navJI.textContent=T.ji;
  navJD.textContent=T.jd;
  navActive.textContent=T.active;

  navExit.onclick=()=>location.href="/index.html"+makeQS();
  navJI.onclick=openJI;
  navJD.onclick=()=>openJD(lsGet("hub_active_node")||"N");
  navActive.onclick=()=>openJD(lsGet("hub_active_node")||"N");

  // default open last active
  const last = lsGet("hub_active_node") || "N";
  openFocus((last in TREE) ? last : "N");

})();
</script>

</body>
</html>
