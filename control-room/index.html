<script>
/* ===============================
   CONTROL ROOM Â· QUAD-CORE ENGINE
   Functional, deterministic, live
================================= */

(function () {

  const ENGINES = [
    "INGESTION",
    "INDEX",
    "QUERY_RANK",
    "FEEDBACK_UPDATE"
  ];

  const PREFIX = "QC::";
  const nowISO = () => new Date().toISOString();

  function engineKey(name) {
    return PREFIX + name;
  }

  function load(name) {
    return JSON.parse(localStorage.getItem(engineKey(name)) || "null");
  }

  function save(name, data) {
    localStorage.setItem(engineKey(name), JSON.stringify(data));
  }

  function initEngine(name) {
    if (load(name)) return;

    save(name, {
      name,
      selection: null,
      resolution: null,
      commitment: null,
      continuation: "IDLE",
      updated_at: nowISO()
    });
  }

  function tickEngine(name) {
    const e = load(name);
    if (!e) return;

    e.continuation = "RUNNING";
    e.updated_at = nowISO();
    save(name, e);
  }

  function registerAll() {
    ENGINES.forEach(initEngine);
  }

  function activityRPM() {
    const now = Date.now();
    let count = 0;

    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (!k.startsWith(PREFIX)) continue;

      const e = JSON.parse(localStorage.getItem(k));
      if (!e?.updated_at) continue;

      if (now - Date.parse(e.updated_at) < 60000) count++;
    }
    return count;
  }

  function updateGauges() {
    const rpm = activityRPM();
    const rpmBar = document.getElementById("rpm-bar");
    const speedBar = document.getElementById("speed-bar");
    const fuelBar = document.getElementById("fuel-bar");
    const riskBar = document.getElementById("risk-bar");

    rpmBar.style.width = Math.min(100, rpm * 25) + "%";
    speedBar.style.width = Math.min(100, rpm * 15) + "%";
    fuelBar.style.width = "100%";
    riskBar.style.width = rpm > 10 ? "40%" : "0%";

    document.getElementById("last-event").textContent = nowISO();
  }

  function loop() {
    ENGINES.forEach(tickEngine);
    updateGauges();
  }

  // BOOT
  registerAll();
  loop();
  setInterval(loop, 5000);

})();
</script>
