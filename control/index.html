<!-- DEMOLITION TNT #6 — /control/index.html (FULL REPLACE: LIVE POLL + COLORED GAUGES + BUBBLES ONLY) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
</head>

<body class="bg-gradient">
<main class="page">

  <section class="panel hero center">
    <h1>Control</h1>
    <p class="subtitle">Live read-only gauges. Color = intensity. Badge = health.</p>
  </section>

  <section class="panel center">
    <div id="healthBadge" class="badge red">HEALTH: RED</div>
    <p class="small" style="margin-top:10px">
      Truth: <span class="mono" id="truth">—</span> · Polling: <span id="poll">10s</span>
    </p>
    <p class="small">
      Last updated: <span id="last">—</span> · Age: <span id="age">—</span>s
    </p>
  </section>

  <section class="panel">
    <details class="bubble" open>
      <summary>Gauges (to scale)</summary>
      <div class="bubble-content">

        <div class="kv">
          <div class="k">Sessions</div><div class="v" id="v_sessions">—</div>
        </div>
        <div class="bar"><i id="b_sessions"></i></div>

        <div style="height:10px"></div>

        <div class="kv">
          <div class="k">Pageviews</div><div class="v" id="v_pageviews">—</div>
        </div>
        <div class="bar"><i id="b_pageviews"></i></div>

        <div style="height:10px"></div>

        <div class="kv">
          <div class="k">Clicks</div><div class="v" id="v_clicks">—</div>
        </div>
        <div class="bar"><i id="b_clicks"></i></div>

        <div style="height:10px"></div>

        <div class="kv">
          <div class="k">Writes</div><div class="v" id="v_writes">—</div>
        </div>
        <div class="bar"><i id="b_writes"></i></div>

        <p class="note" style="margin-top:12px">
          Bars share one scale (max value across metrics + sources in this payload).
        </p>

      </div>
    </details>
  </section>

  <section class="panel">
    <details class="bubble">
      <summary>Sources (to scale)</summary>
      <div class="bubble-content">

        <div class="kv">
          <div class="k">GitHub</div><div class="v" id="s_github">—</div>
        </div>
        <div class="bar"><i id="b_github"></i></div>

        <div style="height:10px"></div>

        <div class="kv">
          <div class="k">OSF</div><div class="v" id="s_osf">—</div>
        </div>
        <div class="bar"><i id="b_osf"></i></div>

        <div style="height:10px"></div>

        <div class="kv">
          <div class="k">Direct</div><div class="v" id="s_direct">—</div>
        </div>
        <div class="bar"><i id="b_direct"></i></div>

        <div style="height:10px"></div>

        <div class="kv">
          <div class="k">Other</div><div class="v" id="s_other">—</div>
        </div>
        <div class="bar"><i id="b_other"></i></div>

      </div>
    </details>
  </section>

  <section class="panel">
    <details class="bubble">
      <summary>Raw payload (JSON)</summary>
      <div class="bubble-content">
        <pre id="raw" class="mono" style="white-space:pre-wrap;margin:0;color:rgba(233,238,252,.75)">{}</pre>
      </div>
    </details>
  </section>

  <section class="panel center">
    <div class="bubble-grid">
      <a class="bubble nav" href="/">Home</a>
      <a class="bubble nav" href="/engine/">Engine</a>
      <a class="bubble nav" href="/laws/">Laws</a>
      <a class="bubble nav" href="/principles/">Principles</a>
      <a class="bubble nav" href="/geodynamics/">Geodynamics</a>
      <a class="bubble nav" href="/reference/">Reference</a>
      <a class="bubble nav" href="/about/">About</a>
    </div>
  </section>

  <section class="panel footer center">
    <p class="small">Build: 2026-02-01a · Canonical</p>
  </section>

</main>

<script>
  const POLL_MS = 10000;
  const TRUTH_BASE = "https://geodiametrics-aggregator.smansfield635.workers.dev";
  const METRICS_URL = TRUTH_BASE + "/metrics";

  const el = (id)=>document.getElementById(id);
  const num = (v)=> (typeof v==="number" && isFinite(v)) ? v : 0;

  function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
  function pct(v,max){return max<=0?0:clamp((v/max)*100,0,100);}

  function intensityColor(p){
    // red <33, yellow <66, green >=66
    if(p>=66) return "rgba(50,255,140,.75)";
    if(p>=33) return "rgba(255,210,60,.78)";
    return "rgba(255,80,80,.78)";
  }

  function setBar(id, p){
    const bar = el(id);
    bar.style.width = p.toFixed(1)+"%";
    bar.style.background = intensityColor(p);
  }

  function setBadge(level){
    const b = el("healthBadge");
    b.classList.remove("red","yellow","green");
    b.classList.add(level);
    b.textContent = "HEALTH: " + level.toUpperCase();
  }

  function fmtTime(ms){
    const d=new Date(ms);
    if(isNaN(d.getTime())) return "—";
    return d.toLocaleString();
  }

  async function tick(){
    const url = METRICS_URL + "?t=" + Date.now();
    el("truth").textContent = url;
    try{
      const r = await fetch(url,{cache:"no-store"});
      if(!r.ok) throw new Error(r.status);
      const j = await r.json();
      el("raw").textContent = JSON.stringify(j,null,2);

      const m = j.metrics || {};
      const src = m.sources || j.sources || {};

      const sessions = num(m.sessions);
      const pageviews = num(m.pageviews);
      const clicks = num(m.clicks);
      const writes = num(m.writes);
      const lu = num(m.lastUpdated);

      el("v_sessions").textContent = sessions;
      el("v_pageviews").textContent = pageviews;
      el("v_clicks").textContent = clicks;
      el("v_writes").textContent = writes;

      const gGitHub = num(src.GitHub);
      const gOSF = num(src.OSF);
      const gDirect = num(src.Direct);
      const gOther = num(src.Other);

      el("s_github").textContent = gGitHub;
      el("s_osf").textContent = gOSF;
      el("s_direct").textContent = gDirect;
      el("s_other").textContent = gOther;

      const globalMax = Math.max(1, sessions, pageviews, clicks, writes, gGitHub, gOSF, gDirect, gOther);

      setBar("b_sessions", pct(sessions, globalMax));
      setBar("b_pageviews", pct(pageviews, globalMax));
      setBar("b_clicks", pct(clicks, globalMax));
      setBar("b_writes", pct(writes, globalMax));

      setBar("b_github", pct(gGitHub, globalMax));
      setBar("b_osf", pct(gOSF, globalMax));
      setBar("b_direct", pct(gDirect, globalMax));
      setBar("b_other", pct(gOther, globalMax));

      el("last").textContent = fmtTime(lu);
      const age = lu ? Math.max(0, Math.floor((Date.now()-lu)/1000)) : "—";
      el("age").textContent = String(age);

      const errors = num(m.errors);
      const stale = lu ? (Date.now()-lu) > (POLL_MS*3) : true;
      const status = (j.status||"").toUpperCase();

      if(status==="OPERATIONAL" && !stale && errors===0) setBadge("green");
      else if(status==="DEGRADED" || stale || errors>0) setBadge("yellow");
      else setBadge("red");

      el("poll").textContent = (POLL_MS/1000).toFixed(0)+"s";
    }catch(e){
      el("raw").textContent = "Unavailable";
      el("v_sessions").textContent = "—";
      el("v_pageviews").textContent = "—";
      el("v_clicks").textContent = "—";
      el("v_writes").textContent = "—";
      el("s_github").textContent = "—";
      el("s_osf").textContent = "—";
      el("s_direct").textContent = "—";
      el("s_other").textContent = "—";
      el("last").textContent = "—";
      el("age").textContent = "—";
      setBadge("red");
    }
  }

  tick();
  setInterval(tick, POLL_MS);
</script>

</body>
</html>
