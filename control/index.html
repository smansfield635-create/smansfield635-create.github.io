<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Control · Geodiametrics</title>

  <link rel="stylesheet" href="/assets/ui.css"/>

  <style>
    .gauge {
      width: 260px;
      height: 260px;
      border-radius: 50%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center, #0b1220 55%, transparent 56%);
    }

    .gauge::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: conic-gradient(
        var(--color) calc(var(--pct) * 1%),
        rgba(255,255,255,0.08) 0
      );
      mask: radial-gradient(circle, transparent 55%, black 56%);
    }

    .gauge .value {
      text-align: center;
      z-index: 1;
    }

    .gauge .value h2 {
      margin: 0;
      font-size: 2.6rem;
    }

    .gauge .value span {
      opacity: 0.7;
      font-size: 0.95rem;
    }

    .gauges {
      display: grid;
      gap: 24px;
      justify-content: center;
    }

    .page-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    .page-table th,
    .page-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 600;
    }

    .status-ok { background: rgba(60,200,120,0.15); color: #3cc878; }
    .status-bad { background: rgba(255,200,60,0.15); color: #ffd24d; }
  </style>
</head>

<body class="bg-gradient">
<main class="page">

  <!-- HERO -->
  <section class="panel hero">
    <h1>Control</h1>
    <p class="subtitle">Live read-only gauges. Truth first. No actions forced.</p>
  </section>

  <!-- SOURCE -->
  <section class="panel bubble">
    <h3>Truth source</h3>
    <code id="source">—</code>

    <div class="tight">
      <div>Polling: <strong>10s</strong></div>
      <div>Last updated: <strong id="lastUpdated">—</strong></div>
      <div>Age (sec): <strong id="age">—</strong></div>
    </div>

    <div id="status" class="status-pill status-bad">● DEGRADED</div>
  </section>

  <!-- GAUGES -->
  <section class="panel bubble">
    <h3>Gauges (to scale)</h3>

    <div class="gauges">
      <div class="gauge" style="--pct:0;--color:#3cc878" id="g_pageviews">
        <div class="value">
          <h2 id="pv">0</h2>
          <span>Pageviews</span>
        </div>
      </div>

      <div class="gauge" style="--pct:0;--color:#ffd24d" id="g_clicks">
        <div class="value">
          <h2 id="cl">0</h2>
          <span>Clicks</span>
        </div>
      </div>

      <div class="gauge" style="--pct:0;--color:#5dade2" id="g_sessions">
        <div class="value">
          <h2 id="se">0</h2>
          <span>Sessions</span>
        </div>
      </div>
    </div>
  </section>

  <!-- PER PAGE -->
  <section class="panel bubble">
    <h3>Top pages (latest)</h3>
    <table class="page-table">
      <thead>
        <tr>
          <th>Path</th>
          <th>Pageviews</th>
          <th>Clicks</th>
        </tr>
      </thead>
      <tbody id="pages"></tbody>
    </table>
  </section>

  <!-- NAV -->
  <section class="panel nav">
    <div class="nav-grid">
      <a class="btn" href="/">Home</a>
      <a class="btn" href="/engine/">Engine</a>
      <a class="btn" href="/laws/">Laws</a>
      <a class="btn" href="/principles/">Principles</a>
    </div>
  </section>

</main>

<script>
const ENDPOINT = "https://geodiametrics-aggregator.smansfield635.workers.dev/metrics";

document.getElementById("source").textContent = ENDPOINT;

async function tick() {
  try {
    const res = await fetch(ENDPOINT, { cache: "no-store" });
    const data = await res.json();

    const m = data.metrics || {};
    const pages = data.pages || {};
    const meta = data.meta || {};

    // Numbers
    pv.textContent = m.pageviews || 0;
    cl.textContent = m.clicks || 0;
    se.textContent = m.sessions || 0;

    // Scale gauges (relative)
    const max = Math.max(m.pageviews || 1, m.clicks || 1, m.sessions || 1);
    g_pageviews.style.setProperty("--pct", (m.pageviews / max) * 100);
    g_clicks.style.setProperty("--pct", (m.clicks / max) * 100);
    g_sessions.style.setProperty("--pct", (m.sessions / max) * 100);

    // Status
    const status = document.getElementById("status");
    if (data.status === "OPERATIONAL") {
      status.className = "status-pill status-ok";
      status.textContent = "● OPERATIONAL";
    } else {
      status.className = "status-pill status-bad";
      status.textContent = "● DEGRADED";
    }

    // Timing
    if (meta.now && m.lastUpdated) {
      const age = Math.floor((meta.now - m.lastUpdated) / 1000);
      ageEl.textContent = age;
      lastUpdated.textContent = new Date(m.lastUpdated).toLocaleTimeString();
    }

    // Pages table
    const tbody = document.getElementById("pages");
    tbody.innerHTML = "";
    Object.entries(pages).forEach(([path, p]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${path}</td>
        <td>${p.pageviews || 0}</td>
        <td>${p.clicks || 0}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch (e) {
    console.error("Control fetch failed", e);
  }
}

setInterval(tick, 10000);
tick();
</script>

</body>
</html>
