<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DIAMOND · Scope</title>

  <link rel="stylesheet" href="/assets/ui.css?v=INDEX_SCOPE_1" />
  <link rel="stylesheet" href="/assets/branch.css?v=INDEX_SCOPE_1" />
  <script defer src="/assets/instrument.js?v=INDEX_SCOPE_1"></script>

  <!-- No backgrounds, no :root overrides. Layout-only helpers. -->
  <style>
    .scope-grid{display:grid;gap:14px;max-width:760px;margin:0 auto;}
    .scope-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .scope-label{opacity:.8;font-weight:900;letter-spacing:.25px;margin:6px 0 2px;text-align:center}
    .scope-help{opacity:.75;margin:0;text-align:center;line-height:1.35}
    .scope-chip{min-width:140px;justify-content:center}
    .scope-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
    .scope-mini{opacity:.7;font-size:12px;text-align:center;margin-top:10px}
  </style>
</head>

<body>
  <main class="crp-shell crp-center">
    <section class="crp-card" aria-label="Scope Selector" style="text-align:center">
      <header class="crp-header">
        <div class="crp-mark" aria-hidden="true">GEODIAMETRICS</div>
        <h1 class="crp-title" style="margin-bottom:6px">DIAMOND</h1>
        <p class="crp-subtitle" style="margin-bottom:8px">Choose your scope.</p>
        <p class="scope-help">Language · Depth · Style · Time</p>
      </header>

      <div class="scope-grid" aria-label="Scope controls">

        <!-- LANGUAGE -->
        <div>
          <div class="scope-label">LANGUAGE</div>
          <div class="scope-row" role="group" aria-label="Language">
            <button type="button" class="crp-btn scope-chip" data-set="lang" data-val="en">ENGLISH</button>
            <button type="button" class="crp-btn scope-chip" data-set="lang" data-val="zh">中文</button>
          </div>
        </div>

        <!-- DEPTH -->
        <div>
          <div class="scope-label">DEPTH</div>
          <div class="scope-row" role="group" aria-label="Depth">
            <button type="button" class="crp-btn scope-chip" data-set="depth" data-val="explore">EXPLORE</button>
            <button type="button" class="crp-btn scope-chip" data-set="depth" data-val="learn">LEARN</button>
          </div>
        </div>

        <!-- STYLE -->
        <div>
          <div class="scope-label">STYLE</div>
          <div class="scope-row" role="group" aria-label="Style">
            <button type="button" class="crp-btn scope-chip" data-set="style" data-val="formal">FORMAL</button>
            <button type="button" class="crp-btn scope-chip" data-set="style" data-val="informal">INFORMAL</button>
          </div>
        </div>

        <!-- TIME -->
        <div>
          <div class="scope-label">TIME</div>
          <div class="scope-row" role="group" aria-label="Time">
            <button type="button" class="crp-btn scope-chip" data-set="time" data-val="origin">ORIGIN</button>
            <button type="button" class="crp-btn scope-chip" data-set="time" data-val="now">NOW</button>
            <button type="button" class="crp-btn scope-chip" data-set="time" data-val="trajectory">TRAJECTORY</button>
          </div>
        </div>

      </div>

      <div class="scope-actions">
        <!-- ENTER uses JS (sets gd_* + navigates). -->
        <button id="enter" type="button" class="crp-btn crp-btn-primary" style="min-width:240px;justify-content:center">
          ENTER
        </button>

        <!-- Fallback link if JS is blocked -->
        <a class="crp-btn" href="/home/?lang=en&depth=explore&style=formal&time=origin" role="button">
          Fallback (EN)
        </a>
      </div>

      <div class="scope-mini">
        Canonical keys only: gd_lang · gd_depth · gd_style · gd_time
      </div>

      <footer class="crp-footer">
        <small class="crp-footnote">BUILD: <strong>INDEX_SCOPE_1</strong></small>
      </footer>
    </section>
  </main>

  <script>
    (function () {
      "use strict";

      // Canonical keys only
      var K_LANG  = "gd_lang";
      var K_DEPTH = "gd_depth";
      var K_STYLE = "gd_style";
      var K_TIME  = "gd_time";

      var allowLang  = { en: 1, zh: 1 };
      var allowDepth = { explore: 1, learn: 1 };
      var allowStyle = { formal: 1, informal: 1 };
      var allowTime  = { origin: 1, now: 1, trajectory: 1 };

      function lsGet(k){ try { return localStorage.getItem(k); } catch(e){ return null; } }
      function lsSet(k,v){ try { localStorage.setItem(k,v); } catch(e){} }

      // Defaults (English-first)
      var state = {
        lang:  (allowLang[lsGet(K_LANG)] ? lsGet(K_LANG) : "en"),
        depth: (allowDepth[lsGet(K_DEPTH)] ? lsGet(K_DEPTH) : "explore"),
        style: (allowStyle[lsGet(K_STYLE)] ? lsGet(K_STYLE) : "formal"),
        time:  (allowTime[lsGet(K_TIME)] ? lsGet(K_TIME) : "origin")
      };

      function applyActive() {
        var buttons = document.querySelectorAll("button[data-set][data-val]");
        for (var i=0;i<buttons.length;i++){
          var b = buttons[i];
          var set = b.getAttribute("data-set");
          var val = b.getAttribute("data-val");
          var on = (state[set] === val);
          b.classList.toggle("crp-btn-primary", on);
        }
      }

      function setState(set, val){
        if (set === "lang" && allowLang[val]) state.lang = val;
        if (set === "depth" && allowDepth[val]) state.depth = val;
        if (set === "style" && allowStyle[val]) state.style = val;
        if (set === "time" && allowTime[val]) state.time = val;
        applyActive();
      }

      // Wire buttons
      document.addEventListener("click", function (e) {
        var t = e.target;
        if (!t) return;
        if (t.matches && t.matches("button[data-set][data-val]")) {
          setState(t.getAttribute("data-set"), t.getAttribute("data-val"));
        }
      });

      // Enter executes: persist + navigate (query params mirror state)
      var enter = document.getElementById("enter");
      if (enter) enter.addEventListener("click", function () {
        lsSet(K_LANG, state.lang);
        lsSet(K_DEPTH, state.depth);
        lsSet(K_STYLE, state.style);
        lsSet(K_TIME, state.time);

        var url =
          "/home/?lang=" + encodeURIComponent(state.lang) +
          "&depth=" + encodeURIComponent(state.depth) +
          "&style=" + encodeURIComponent(state.style) +
          "&time=" + encodeURIComponent(state.time);

        window.location.href = url;
      });

      // initial paint
      applyActive();
    })();
  </script>
</body>
</html>
