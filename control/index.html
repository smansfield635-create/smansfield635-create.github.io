<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
</head>
<body class="bg-gradient">
  <main class="page">

    <section class="panel hero">
      <h1>Control</h1>
      <p class="subtitle">Live read-only gauges. Color = intensity. Badge = health.</p>
    </section>

    <section class="panel">
      <h2>Live status</h2>
      <div class="card">
        <div class="mono" id="status">Truth source—\nPolling—\nLast updated—\nAge (sec)—\nHEALTH—</div>
      </div>

      <details open style="margin-top:12px">
        <summary>Activity (what’s happening) <span class="chev">▾</span></summary>
        <div class="body">
          <p>These are conservative counts. They only increase when the website explicitly reports an event.</p>
          <div class="mono" id="counts">Sessions 0\nPageviews 0\nClicks 0\nWrites 0</div>
        </div>
      </details>

      <details style="margin-top:10px">
        <summary>Sources (to scale) <span class="chev">▾</span></summary>
        <div class="body">
          <div class="mono" id="sources">GitHub 0\nOSF 0\nDirect 0\nOther 0</div>
          <p>Bars share one scale. Color intensity reflects relative magnitude.</p>
        </div>
      </details>

      <details style="margin-top:10px">
        <summary>Raw payload (JSON) <span class="chev">▾</span></summary>
        <div class="body">
          <div class="mono" id="raw">—</div>
        </div>
      </details>
    </section>

    <section class="panel nav">
      <div class="nav-grid">
        <a class="btn" href="/home/">Home</a>
        <a class="btn" href="/">Landing</a>
        <a class="btn" href="/execution-space/">Execution Space</a>
        <a class="btn" href="/laws/">Laws</a>
        <a class="btn" href="/engine/">Engine</a>
      </div>
    </section>

    <div class="footer">© Geodiametrics</div>
  </main>

  <script>
    // This page only renders what the "Truth" endpoint returns.
    // You will wire pageviews/sessions next by making the website report events to the Worker.
    const TRUTH = "https://geodiametrics-aggregator.smansfield635.workers.dev/metrics";
    const POLL_MS = 10000;

    const elStatus = document.getElementById("status");
    const elCounts = document.getElementById("counts");
    const elSources = document.getElementById("sources");
    const elRaw = document.getElementById("raw");

    function nowIso(){
      const d=new Date();
      return d.toLocaleString();
    }
    function ageSec(ts){
      if(!ts) return "—";
      const ms = Date.now() - Number(ts);
      return Math.max(0, Math.round(ms/1000));
    }
    function setText(el, s){ el.textContent = s; }

    async function tick(){
      try{
        const u = TRUTH + "?t=" + Date.now();
        const res = await fetch(u, { cache:"no-store" });
        const json = await res.json();

        setText(elRaw, JSON.stringify(json, null, 2));

        const m = (json && json.metrics) ? json.metrics : {};
        const s = (json && json.sources) ? json.sources : {};
        const updated = m.lastUpdated || 0;

        const health = (json && json.status) ? json.status : "UNKNOWN";

        setText(elStatus,
          "Truth source—\n" +
          u + "\n" +
          "Polling " + (POLL_MS/1000) + "s\n" +
          "Last updated " + (updated ? nowIso() : "—") + "\n" +
          "Age (sec) " + ageSec(updated) + "\n" +
          "HEALTH: " + health
        );

        setText(elCounts,
          "Sessions " + (m.sessions||0) + "\n" +
          "Pageviews " + (m.pageviews||0) + "\n" +
          "Clicks " + (m.clicks||0) + "\n" +
          "Writes " + (m.writes||0)
        );

        setText(elSources,
          "GitHub " + (s.GitHub||0) + "\n" +
          "OSF " + (s.OSF||0) + "\n" +
          "Direct " + (s.Direct||0) + "\n" +
          "Other " + (s.Other||0)
        );
      }catch(e){
        setText(elRaw, String(e));
        setText(elStatus, "Truth source—\n" + TRUTH + "\nPolling " + (POLL_MS/1000) + "s\nLast updated—\nAge (sec)—\nHEALTH: RED");
      }
    }

    tick();
    setInterval(tick, POLL_MS);
  </script>
</body>
</html>
