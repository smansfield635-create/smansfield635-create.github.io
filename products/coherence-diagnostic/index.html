<!-- TNT — /products/coherence-diagnostic/index.html
     COHERENCE DIAGNOSTIC · 4-DIAMOND PRODUCT PAGE · WORKING MODALS · TRUE LENS/TIME SPLIT · EN/中文/ES
     FIXES (LOCKED):
       - No competing UI layers (clean z-index + no pointer-event traps)
       - Modal ALWAYS opens (bd z=1000, modal z=1001)
       - Stage does NOT disable pointer events
       - All 3 languages supported (page-level only)
       - Formal/Informal + Concept/Live/Roadmap actually change content (not duplicates)
     ROUTES:
       - BACK  → /products/
       - EXIT  → /index.html
       - Dock  → /prelude/ /explore/ /products/ /laws/ /gauges/
     STATE:
       - URL: lang/style/time/depth
       - LS: gd_lang/gd_style/gd_time/gd_depth
     LOCKS:
       - Uses /assets/ui.css + /assets/branch.css + /assets/instruments.js
       - Does NOT style html/body background (ui.css owns field)
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coherence Diagnostic</title>

<link rel="stylesheet" href="/assets/ui.css"/>
<link rel="stylesheet" href="/assets/branch.css"/>
<script defer src="/assets/instruments.js"></script>

<style>
a{color:inherit;text-decoration:none}

/* ===== SAFETY: never let overlays steal clicks ===== */
body::before,body::after{pointer-events:none!important}

/* ===== TOP CONTROLS ===== */
.top-left{
  position:fixed;left:16px;top:16px;z-index:140;
  display:flex;gap:10px;flex-wrap:nowrap;align-items:center;white-space:nowrap;
}
.top-right{
  position:fixed;right:16px;top:16px;z-index:140;
  display:flex;gap:10px;flex-wrap:nowrap;align-items:center;white-space:nowrap;
}
.top-left .btn,.top-right .btn{white-space:nowrap}

/* ===== HEADER PILL ===== */
.brand{
  position:fixed;left:50%;top:16px;transform:translateX(-50%);
  z-index:120;text-align:center;
  padding:10px 18px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  backdrop-filter:blur(8px);
  pointer-events:none;
}
.brand .t{margin:0;font-weight:950;font-size:20px;letter-spacing:.2px;line-height:1.1}
.brand .s{margin:6px 0 0;opacity:.82;font-size:12.75px;line-height:1.25}

/* ===== STAGE ===== */
:root{
  --R:150px;
  --D:184px;
  --goldSoft:rgba(212,175,55,.45);
  --obsA:rgba(12,22,38,.95);
  --obsB:rgba(6,10,16,.98);
  --mut:rgba(255,255,255,.90);
  --mut2:rgba(255,255,255,.72);
}

.stage{
  position:fixed;left:50%;top:56%;
  transform:translate(-50%,-50%);
  width:min(720px,94vw);
  height:min(720px,94vw);
  z-index:60;
  pointer-events:auto; /* IMPORTANT: no pointer-events:none */
}

/* soft outer frame (purely decorative) */
.outer{
  position:absolute;left:50%;top:50%;
  width:min(680px,92vw);height:min(680px,92vw);
  transform:translate(-50%,-50%) rotate(45deg);
  border-radius:60px;
  opacity:.55;
  pointer-events:none;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.08), transparent 55%),
    radial-gradient(circle at 70% 80%, rgba(0,80,255,.14), transparent 60%),
    linear-gradient(160deg, rgba(14,24,40,.42) 0%, rgba(7,11,18,.58) 70%);
  box-shadow:
    0 90px 260px rgba(0,0,0,.55),
    inset 0 2px 0 rgba(255,255,255,.10),
    inset 0 -50px 90px rgba(0,0,0,.55);
}
.outer::after{
  content:"";
  position:absolute;inset:0;border-radius:60px;
  opacity:.12;pointer-events:none;
  background:repeating-conic-gradient(from 0deg, rgba(255,255,255,.04) 0deg 6deg, transparent 6deg 18deg);
}

/* ===== PEARLESCENT DIAMONDS ===== */
.d{
  width:var(--D);height:var(--D);
  position:absolute;left:50%;top:50%;
  transform-origin:center;
  border-radius:28px;
  cursor:pointer;
  pointer-events:auto;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
  z-index:70;
  background:
    radial-gradient(circle at 30% 22%, rgba(255,255,255,.55), transparent 45%),
    radial-gradient(circle at 70% 78%, rgba(0,120,255,.30), transparent 60%),
    linear-gradient(160deg, var(--obsA), var(--obsB));
  border:1px solid rgba(255,255,255,.16);
  box-shadow:
    0 38px 120px rgba(0,0,0,.85),
    0 0 32px rgba(212,175,55,.28),
    inset 0 2px 0 rgba(255,255,255,.25),
    inset 0 -42px 78px rgba(0,0,0,.80);
  transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  overflow:hidden;
}
.d::before{
  content:"";
  position:absolute;inset:0;border-radius:28px;padding:1px;
  background:linear-gradient(120deg, transparent 0%, var(--goldSoft) 50%, transparent 100%);
  opacity:.65;
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  pointer-events:none;
}
.d::after{
  content:"";
  position:absolute;left:10%;right:10%;top:10%;height:28%;
  border-radius:999px;
  background:linear-gradient(to bottom, rgba(255,255,255,.25), rgba(255,255,255,0));
  transform:rotate(-10deg);
  pointer-events:none;
}
.d:hover{
  transform:translate(-50%,-50%) rotate(45deg) scale(1.02);
  border-color:rgba(212,175,55,.35);
  box-shadow:
    0 44px 140px rgba(0,0,0,.92),
    0 0 44px rgba(212,175,55,.32),
    inset 0 2px 0 rgba(255,255,255,.28),
    inset 0 -46px 86px rgba(0,0,0,.84);
}

.d-n{transform:translate(-50%,-50%) translate(0, calc(var(--R)*-1)) rotate(45deg)}
.d-e{transform:translate(-50%,-50%) translate(var(--R),0) rotate(45deg)}
.d-s{transform:translate(-50%,-50%) translate(0,var(--R)) rotate(45deg)}
.d-w{transform:translate(-50%,-50%) translate(calc(var(--R)*-1),0) rotate(45deg)}

.inner{
  transform:rotate(-45deg) translateY(-2px);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  text-align:center;height:100%;
  padding:14px;gap:8px;
  pointer-events:none;user-select:none;
}
.lab{font-weight:950;font-size:18px;letter-spacing:.6px;text-shadow:0 0 16px rgba(255,255,255,.14)}
.sub{font-size:13px;opacity:.88;line-height:1.25;max-width:18em}

/* ===== DOCK ===== */
.dock{
  position:fixed;left:50%;
  bottom:max(12px, env(safe-area-inset-bottom));
  transform:translateX(-50%);
  z-index:120;width:min(980px,94vw);
  display:flex;justify-content:center;gap:10px;flex-wrap:wrap;
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  backdrop-filter:blur(8px);
  pointer-events:none;
}
.dock .btn{pointer-events:auto}

/* ===== MODAL SYSTEM (ALWAYS ON TOP) ===== */
.bd{
  position:fixed;inset:0;
  z-index:1000;
  background:rgba(0,0,0,.72);
  backdrop-filter:blur(10px);
  display:none;
}
.bd.show{display:block}

.modal{
  position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:min(1180px,96vw);
  height:90vh;
  z-index:1001;
  display:none;
}
.modal.show{display:block}

.shell{
  height:90vh;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(160deg, rgba(10,18,30,.96), rgba(6,10,16,.98));
  box-shadow:0 60px 180px rgba(0,0,0,.85);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.mhead{
  display:flex;justify-content:space-between;align-items:center;gap:10px;
  padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);
}
.mtitle{margin:0;font-weight:950;letter-spacing:.3px;font-size:16px}
.mclose{border:0;background:transparent;color:#fff;font-size:18px;cursor:pointer;padding:8px 10px}
.mbody{padding:16px;overflow:auto;-webkit-overflow-scrolling:touch;flex:1 1 auto}

.lensbar{
  display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
  margin:0 0 14px;
}
.pill{
  padding:10px 14px;border-radius:999px;
  background:linear-gradient(145deg, rgba(17,22,28,.92), rgba(11,15,20,.96));
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 14px 36px rgba(0,0,0,.65);
  cursor:pointer;font-weight:900;letter-spacing:.2px;color:#fff;user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.pill.active{
  border-color:rgba(212,175,55,.60);
  box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 14px rgba(212,175,55,.22);
}

.hint{
  max-width:980px;margin:0 auto 12px;
  padding:10px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.16);
  color:rgba(255,255,255,.80);
  font-size:12.5px;line-height:1.45;
}

.bubble{
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:rgba(255,255,255,.05);
  padding:14px 14px 12px;
  margin:0 0 12px;
}
.bubble h4{margin:0 0 8px;font-weight:950;letter-spacing:.15px}
.bubble p{margin:0;color:var(--mut2);line-height:1.65}
.grid2{display:grid;gap:12px;grid-template-columns:1fr}
@media (min-width:920px){.grid2{grid-template-columns:1fr 1fr}}
.box{
  padding:14px 14px 12px;border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.14);
}
.box .h{margin:0 0 8px;font-weight:950;letter-spacing:.2px}
.box ul{margin:0 0 0 18px;padding:0;color:var(--mut2)}
.box li{margin:6px 0}
</style>
</head>

<body>

<div class="top-left">
  <a class="btn" id="btnBack" href="/products/">BACK</a>
  <a class="btn" id="btnExit" href="/index.html">EXIT</a>
</div>

<div class="top-right" aria-label="Language">
  <button class="btn" id="btnEN" type="button">EN</button>
  <button class="btn" id="btnZH" type="button">中文</button>
  <button class="btn" id="btnES" type="button">ES</button>
</div>

<div class="brand" aria-hidden="true">
  <p class="t" id="hdrT">Coherence Diagnostic</p>
  <p class="s" id="hdrS">Decision support · classification · bounded outputs</p>
</div>

<div class="stage" aria-label="Coherence Diagnostic quadrants">
  <div class="outer"></div>

  <div class="d d-n" id="dOverview" role="button" tabindex="0">
    <div class="inner">
      <div class="lab" id="labOverview">OVERVIEW</div>
      <div class="sub" id="subOverview">What it does, in one pass.</div>
    </div>
  </div>

  <div class="d d-e" id="dUse" role="button" tabindex="0">
    <div class="inner">
      <div class="lab" id="labUse">USE</div>
      <div class="sub" id="subUse">Inputs → constraints → outputs.</div>
    </div>
  </div>

  <div class="d d-s" id="dRules" role="button" tabindex="0">
    <div class="inner">
      <div class="lab" id="labRules">RULES</div>
      <div class="sub" id="subRules">Admissibility + collapse posture.</div>
    </div>
  </div>

  <div class="d d-w" id="dDeploy" role="button" tabindex="0">
    <div class="inner">
      <div class="lab" id="labDeploy">DEPLOY</div>
      <div class="sub" id="subDeploy">Where it plugs in.</div>
    </div>
  </div>
</div>

<nav class="dock" aria-label="Bottom navigation">
  <a class="btn" id="dockPrelude" href="/prelude/">PRELUDE</a>
  <a class="btn" id="dockExplore" href="/explore/">EXPLORE</a>
  <a class="btn active" id="dockProducts" href="/products/">PRODUCTS</a>
  <a class="btn" id="dockLaws" href="/laws/">LAWS</a>
  <a class="btn" id="dockGauges" href="/gauges/">GAUGES</a>
</nav>

<div class="bd" id="bd"></div>

<div class="modal" id="modal" role="dialog" aria-modal="true">
  <div class="shell">
    <div class="mhead">
      <h3 class="mtitle" id="mTitle">—</h3>
      <button class="mclose" id="mClose" aria-label="Close" type="button">✕</button>
    </div>
    <div class="mbody">
      <div class="lensbar">
        <div class="pill active" id="pillFormal">FORMAL</div>
        <div class="pill" id="pillInformal">INFORMAL</div>
        <div class="pill active" id="pillConcept">CONCEPT</div>
        <div class="pill" id="pillLive">LIVE</div>
        <div class="pill" id="pillRoadmap">ROADMAP</div>
      </div>

      <div class="hint" id="mHint">
        This page is bounded. Claims require receipts. Navigation preserves gd_* state.
      </div>

      <div class="grid2">
        <div class="box">
          <div class="h" id="h1">—</div>
          <ul id="u1"></ul>
        </div>
        <div class="box">
          <div class="h" id="h2">—</div>
          <ul id="u2"></ul>
        </div>
      </div>

      <div class="bubble">
        <h4 id="h3">—</h4>
        <p id="p3">—</p>
      </div>

      <div class="bubble">
        <h4 id="h4">—</h4>
        <p id="p4">—</p>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  // ===== Canon state (gd_* only) =====
  var qs=new URLSearchParams(location.search);
  var lang  = qs.get("lang")  || localStorage.getItem("gd_lang")  || "en";
  var style = qs.get("style") || localStorage.getItem("gd_style") || "formal";
  var time  = qs.get("time")  || localStorage.getItem("gd_time")  || "now";
  var depth = qs.get("depth") || localStorage.getItem("gd_depth") || "explore";

  if(lang!=="en" && lang!=="zh" && lang!=="es") lang="en";
  if(style!=="formal" && style!=="informal") style="formal";
  if(time==="trajectory") time="post";
  if(time!=="origin" && time!=="now" && time!=="post") time="now";
  if(depth!=="explore" && depth!=="learn") depth="explore";

  try{
    localStorage.setItem("gd_lang",lang);
    localStorage.setItem("gd_style",style);
    localStorage.setItem("gd_time",time);
    localStorage.setItem("gd_depth",depth);
  }catch(e){}

  document.documentElement.lang=(lang==="zh")?"zh":(lang==="es")?"es":"en";

  function q(){
    return "?lang="+encodeURIComponent(lang)+
           "&style="+encodeURIComponent(style)+
           "&time="+encodeURIComponent(time)+
           "&depth="+encodeURIComponent(depth);
  }

  // ===== Wire nav with state =====
  document.getElementById("btnBack").href="/products/"+q();
  document.getElementById("btnExit").href="/index.html"+q();

  document.getElementById("dockPrelude").href="/prelude/"+q();
  document.getElementById("dockExplore").href="/explore/"+q();
  document.getElementById("dockProducts").href="/products/"+q();
  document.getElementById("dockLaws").href="/laws/"+q();
  document.getElementById("dockGauges").href="/gauges/"+q();

  // ===== Language buttons =====
  var btnEN=document.getElementById("btnEN");
  var btnZH=document.getElementById("btnZH");
  var btnES=document.getElementById("btnES");
  function paintLang(){
    btnEN.classList.toggle("active", lang==="en");
    btnZH.classList.toggle("active", lang==="zh");
    btnES.classList.toggle("active", lang==="es");
  }
  paintLang();
  function setLang(next){
    if(next!=="en" && next!=="zh" && next!=="es") next="en";
    lang=next;
    try{ localStorage.setItem("gd_lang",lang); }catch(e){}
    location.href=location.pathname + q();
  }
  btnEN.addEventListener("click", function(){ setLang("en"); });
  btnZH.addEventListener("click", function(){ setLang("zh"); });
  btnES.addEventListener("click", function(){ setLang("es"); });

  // ===== Copy (true split) =====
  var COPY = {
    en:{
      header:{t:"Coherence Diagnostic", s:"Decision support · classification · bounded outputs"},
      diamonds:{
        overview:{lab:"OVERVIEW", sub:"What it does, in one pass."},
        use:{lab:"USE", sub:"Inputs → constraints → outputs."},
        rules:{lab:"RULES", sub:"Admissibility + collapse posture."},
        deploy:{lab:"DEPLOY", sub:"Where it plugs in."}
      },
      hint:"This page is bounded. Claims require receipts. Navigation preserves gd_* state.",
      lens:{formal:"FORMAL", informal:"INFORMAL", concept:"CONCEPT", live:"LIVE", roadmap:"ROADMAP"},
      sections:{
        overview:{
          origin:{
            formal:{
              title:"OVERVIEW · Contract",
              a:{h:"Purpose",u:[
                "Classify an evidence stream under declared scope.",
                "Refuse escalation when receipts are missing.",
                "Expose coherence breaks as concrete failure modes.",
                "Preserve navigation state for reproducible review."
              ]},
              b:{h:"Output",u:[
                "Admissibility result + reason codes.",
                "Bounded recommendation: proceed / hold / contain.",
                "Receipt checklist (what’s missing).",
                "Stable routes to Laws (proof) and Gauges (measurement)."
              ]},
              c:{h:"Definition",p:"A diagnostic is not a prediction engine. It is a constraint filter: it narrows what may be claimed given receipts, scope, and invariants."},
              d:{h:"Falsifier",p:"If two observers with the same scope and receipts reach different admissibility results, the instrument is mis-specified and must be corrected (new epoch)."}
            },
            informal:{
              title:"OVERVIEW · What it is",
              a:{h:"What you get",u:[
                "A fast answer about what’s actually supported.",
                "A clean ‘no’ when evidence is missing.",
                "A list of exactly what to collect next.",
                "A route to the right page without wandering."
              ]},
              b:{h:"What it avoids",u:[
                "Arguing about intent.",
                "Narratives that inflate claims.",
                "Scaling while confused.",
                "Fixing the wrong thing first."
              ]},
              c:{h:"In plain words",p:"Bring receipts. The tool applies rules. You get a bounded result—so you can move without guessing."},
              d:{h:"If it fails",p:"If it can be gamed or produces different answers from the same receipts, it’s broken and gets rewritten—no excuses."}
            }
          },
          now:{
            formal:{
              title:"OVERVIEW · Live posture",
              a:{h:"Live inputs",u:[
                "Receipts (timestamps, logs, measurements).",
                "Declared scope + constraints.",
                "Known invariants (non-contradiction).",
                "Observed divergence signals (drift)."
              ]},
              b:{h:"Live outputs",u:[
                "Pass/hold/contain (bounded).",
                "Reason codes (why allowed/blocked).",
                "Missing-receipt list.",
                "Next safe route (Laws/Gauges/Products)."
              ]},
              c:{h:"Operational rule",p:"Confusion amplifies instability once present. The diagnostic prioritizes containment when ambiguity rises under load."},
              d:{h:"Non-negotiable",p:"External trust cannot exceed internal self-consistency under identical evidence."}
            },
            informal:{
              title:"OVERVIEW · What it does right now",
              a:{h:"It tells you",u:[
                "What’s real vs what’s a story.",
                "What can scale vs what must pause.",
                "Where the drift is coming from (as signals).",
                "What to do next without spiraling."
              ]},
              b:{h:"It forces",u:[
                "Receipts-first thinking.",
                "Boundaries before claims.",
                "Containment before heroics.",
                "Clean reroutes instead of guesswork."
              ]},
              c:{h:"Simple rule",p:"If you can’t measure it, you can’t stabilize it. So we don’t pretend."},
              d:{h:"Why you want it",p:"Because it saves you time, money, and reputation by killing bad paths early."}
            }
          },
          post:{
            formal:{
              title:"OVERVIEW · Roadmap",
              a:{h:"Upgrades",u:[
                "More domain adapters (same contract).",
                "Replayable evidence bundles (hashable).",
                "Registry publication of outcomes (without leaking telemetry).",
                "Cross-check engines (dual-impl consistency)."
              ]},
              b:{h:"Scale conditions",u:[
                "No widening claims without widening receipts.",
                "No tightening bounds without new event class.",
                "No silent correction—new epoch only.",
                "Adversarial harness required for high tiers."
              ]},
              c:{h:"Why it scales",p:"Because the interface stays constant while content deepens: scope, receipts, reason codes, and bounded routes remain stable."},
              d:{h:"Kill condition",p:"If outcome quality cannot be reproduced across observers, scale halts until measurement rules are fixed."}
            },
            informal:{
              title:"OVERVIEW · Where it’s going",
              a:{h:"Soon",u:[
                "More domains plug in cleanly.",
                "Reports become one-click shareable.",
                "Proof gets easier to audit.",
                "Gaming gets harder."
              ]},
              b:{h:"Always",u:[
                "Same rules.",
                "Same boundaries.",
                "Same receipts-first posture.",
                "Same calm navigation."
              ]},
              c:{h:"The point",p:"We turn ‘I think’ into ‘Here’s what the receipts allow.’"},
              d:{h:"If you want speed",p:"This is how you get it—by killing ambiguity before it multiplies."}
            }
          }
        },

        use:{
          origin:{
            formal:{
              title:"USE · Inputs → Constraints → Outputs",
              a:{h:"Inputs (required)",u:[
                "Scope_id + boundary statement.",
                "Receipts (timestamps, measurements, logs).",
                "Declared measurement rules (observer-invariant).",
                "Target question (bounded)."
              ]},
              b:{h:"Constraints (applied)",u:[
                "Non-contradiction under identical evidence.",
                "Admissibility requires receipts.",
                "Correction creates new epoch (no rewrite).",
                "Containment prevents cascade."
              ]},
              c:{h:"Outputs (returned)",p:"A bounded classification plus a minimal next-action route. Outputs do not exceed inputs. If a claim needs new data, the output is ‘NOT AVAILABLE’ or ‘NOT MEASURED’."},
              d:{h:"Operator loop",p:"Run → read reason codes → collect missing receipts → rerun. No narrative fills missing measurements."}
            },
            informal:{
              title:"USE · How to run it",
              a:{h:"Bring",u:[
                "What happened (receipts).",
                "Where it happened (scope).",
                "How you measured (rules).",
                "What you want to decide (question)."
              ]},
              b:{h:"It gives",u:[
                "A clean pass/hold/contain.",
                "Reasons you can point to.",
                "What’s missing.",
                "Where to go next."
              ]},
              c:{h:"Fast loop",p:"Run it, fix what it flags, rerun it. That’s the whole system."},
              d:{h:"Hard boundary",p:"If you don’t have evidence, you don’t get an upgraded claim."}
            }
          },
          now:{
            formal:{
              title:"USE · Live operation",
              a:{h:"Live receipts",u:[
                "Background baselines.",
                "Delta signals and variance bands.",
                "Event logs with device time anchors.",
                "External confirmations (when available)."
              ]},
              b:{h:"Live gating",u:[
                "Escalate only with new event class.",
                "Freeze when ambiguity rises.",
                "Contain when drift accelerates.",
                "Rollback when contradictions appear."
              ]},
              c:{h:"Live outputs",p:"Outputs are stable across observers because measurement rules are explicit. The diagnostic never uses inferred intent—only observed behavior and receipts."},
              d:{h:"Edge case",p:"If evidence is insufficient, output remains bounded: UNDETERMINED / NOT MEASURED."}
            },
            informal:{
              title:"USE · In the real world",
              a:{h:"When to use",u:[
                "Before you scale something.",
                "When the story feels ahead of the proof.",
                "When multiple signals conflict.",
                "When you need a clean next step."
              ]},
              b:{h:"What it stops",u:[
                "Spiraling into opinions.",
                "Chasing noise.",
                "Fixing the wrong layer.",
                "Overpromising."
              ]},
              c:{h:"It keeps you sane",p:"Because it turns chaos into a shortlist."},
              d:{h:"And it’s honest",p:"It won’t tell you what you want. It tells you what the receipts allow."}
            }
          },
          post:{
            formal:{
              title:"USE · Roadmap operation",
              a:{h:"Automation",u:[
                "Receipt bundling by default.",
                "Hash anchors for audit replay.",
                "Registry publication of status.",
                "Cross-check computations."
              ]},
              b:{h:"Scale protocol",u:[
                "Windowed collapse testing.",
                "Adversarial stress harness.",
                "Zone independence checks.",
                "Correlation penalties enforced."
              ]},
              c:{h:"Why it matters",p:"At scale, the cost of being wrong is non-linear. The tool becomes a governance surface, not just a helper."},
              d:{h:"Non-negotiable",p:"If reproducibility drops, automation stops and rules are corrected explicitly."}
            },
            informal:{
              title:"USE · What changes later",
              a:{h:"More power",u:[
                "Better replay.",
                "Better reports.",
                "Better anti-gaming.",
                "More domains."
              ]},
              b:{h:"Same discipline",u:[
                "Receipts first.",
                "Boundaries first.",
                "Containment first.",
                "No silent upgrades."
              ]},
              c:{h:"The win",p:"Speed becomes safe because it’s bounded."},
              d:{h:"That’s the point",p:"We scale trust, not hype."}
            }
          }
        },

        rules:{
          origin:{
            formal:{
              title:"RULES · Admissibility",
              a:{h:"Hard rules",u:[
                "No receipts → no admissibility.",
                "Same receipts → same result (observer-invariant).",
                "Correction → new epoch (explicit).",
                "Containment beats cascade."
              ]},
              b:{h:"Failure modes",u:[
                "Semantic drift (definitions move).",
                "Scope inflation (claims widen silently).",
                "Compensation (patching contradictions).",
                "Correlation blindness (shared exposure)."
              ]},
              c:{h:"Collapse note",p:"Ambiguity is an accelerator: once instability exists, ambiguity increases speed of failure propagation."},
              d:{h:"Role separation",p:"Calibration authority is exclusive and cannot be crowdsourced. Non-authoritative inputs remain data only."}
            },
            informal:{
              title:"RULES · The discipline",
              a:{h:"What’s allowed",u:[
                "Measurable claims.",
                "Bounded scope.",
                "Clear receipts.",
                "Reproducible results."
              ]},
              b:{h:"What’s banned",u:[
                "‘Trust me.’",
                "Silent edits.",
                "Scaling while confused.",
                "Story over proof."
              ]},
              c:{h:"The vibe",p:"This is how you keep things clean under pressure."},
              d:{h:"The punchline",p:"If it can’t survive constraint, it’s not ready."}
            }
          },
          now:{
            formal:{
              title:"RULES · Live enforcement",
              a:{h:"Live checks",u:[
                "Time anchor first (device timestamp).",
                "Evidence before interpretation.",
                "No further tightening without new event class.",
                "Back-nav invalidates downstream receipts (when applicable)."
              ]},
              b:{h:"Live exits",u:[
                "Contain: isolate and stop bleeding.",
                "Hold: gather missing receipts.",
                "Proceed: bounded advancement.",
                "Kill: exit when invariant breaks."
              ]},
              c:{h:"Reason codes",p:"Every decision emits a reason code that can be audited and replayed."},
              d:{h:"Why this works",p:"Because it treats evidence as the substrate, not narrative."}
            },
            informal:{
              title:"RULES · Right now",
              a:{h:"Do this",u:[
                "Name the scope.",
                "Show receipts.",
                "Accept bounded outputs.",
                "Move in phases."
              ]},
              b:{h:"Don’t do this",u:[
                "Argue feelings.",
                "Invent intent.",
                "Scale first.",
                "Hide drift."
              ]},
              c:{h:"If you’re stuck",p:"That means you’re missing receipts—so go get them."},
              d:{h:"If you’re calm",p:"That means structure is doing its job."}
            }
          },
          post:{
            formal:{
              title:"RULES · Roadmap governance",
              a:{h:"Protocol",u:[
                "Windowed collapse tests.",
                "Public audit artifacts.",
                "Registry-based status.",
                "Anti-capture separation."
              ]},
              b:{h:"Expansion gates",u:[
                "New domain requires adapter spec.",
                "Comparator regimes required.",
                "Stress harness required.",
                "Reproducibility required."
              ]},
              c:{h:"Public safety",p:"Roadmap makes the rules portable so non-experts can trust outcomes without reading internals."},
              d:{h:"Kill condition",p:"If governance can be captured, the system must redesign separation—not just copy changes."}
            },
            informal:{
              title:"RULES · Where it goes",
              a:{h:"More strict",u:[
                "More proof.",
                "More audits.",
                "More replay.",
                "More defenses."
              ]},
              b:{h:"Still simple",u:[
                "Receipts or no claim.",
                "Bounds or no scale.",
                "Containment or chaos.",
                "Truth over story."
              ]},
              c:{h:"That’s it",p:"This is how you build something that lasts."},
              d:{h:"And it matters",p:"Because systems fail when rules get soft."}
            }
          }
        },

        deploy:{
          origin:{
            formal:{
              title:"DEPLOY · Where it plugs in",
              a:{h:"Entry points",u:[
                "Before product deployment.",
                "Before public claims.",
                "Before organizational scaling.",
                "After anomaly detection."
              ]},
              b:{h:"Routing",u:[
                "Proof surfaces → Laws.",
                "Measurement surfaces → Gauges.",
                "Adoption surfaces → Products.",
                "Orientation surfaces → Prelude / Hub."
              ]},
              c:{h:"Integration",p:"Deployment uses the same state keys (gd_*) so users do not lose lens position across pages."},
              d:{h:"Result",p:"The diagnostic becomes the ‘stop-and-check’ gate that prevents drift from compounding."}
            },
            informal:{
              title:"DEPLOY · Put it here",
              a:{h:"Use it",u:[
                "Before you ship.",
                "Before you claim.",
                "When things feel off.",
                "When you need a clean call."
              ]},
              b:{h:"It connects to",u:[
                "Laws for proof.",
                "Gauges for measurement.",
                "Products for adoption.",
                "Prelude for orientation."
              ]},
              c:{h:"Why it fits",p:"Because it’s the bridge between ‘ideas’ and ‘what’s allowed’."},
              d:{h:"What it prevents",p:"Scaling into a wall you didn’t measure."}
            }
          },
          now:{
            formal:{
              title:"DEPLOY · Live workflow",
              a:{h:"Workflow",u:[
                "Collect receipts.",
                "Declare scope.",
                "Run classification.",
                "Execute bounded action."
              ]},
              b:{h:"Outputs route",u:[
                "Contain → containment pages.",
                "Hold → receipt checklists.",
                "Proceed → hub paths.",
                "Kill → exit with reason."
              ]},
              c:{h:"No drift",p:"The deployment contract is state-stable: the same lenses survive navigation."},
              d:{h:"Operator win",p:"You don’t waste hours guessing; you move by evidence."}
            },
            informal:{
              title:"DEPLOY · In practice",
              a:{h:"Step 1",u:["Get receipts."]},
              b:{h:"Step 2",u:["Run the filter."]},
              c:{h:"Step 3",p:"Do what the bounded output says."},
              d:{h:"Step 4",p:"If you want an upgrade, bring more evidence—not more emotion."}
            }
          },
          post:{
            formal:{
              title:"DEPLOY · Roadmap integration",
              a:{h:"Expansion",u:[
                "Domain adapters per industry.",
                "Registry publishing of status.",
                "Audit bundles by default.",
                "Cross-room sharing of validated artifacts."
              ]},
              b:{h:"Safety",u:[
                "Zone independence checks.",
                "Correlation penalties.",
                "Release gating protocols.",
                "Rollback discipline."
              ]},
              c:{h:"Institutional",p:"Deployment becomes compatible with underwriting, compliance, and governance because the outputs are reproducible."},
              d:{h:"Public",p:"The interface stays simple while the back-end proof gets stronger."}
            },
            informal:{
              title:"DEPLOY · The future",
              a:{h:"It scales",u:[
                "More domains.",
                "More proof.",
                "More safety.",
                "More trust."
              ]},
              b:{h:"And stays readable",u:[
                "Same buttons.",
                "Same structure.",
                "Same state keys.",
                "Same calm flow."
              ]},
              c:{h:"That’s the whole play",p:"Make the system smarter without making the user lost."},
              d:{h:"So yes",p:"This is how you build something that matters."}
            }
          }
        }
      }
    },

    zh:{
      header:{t:"一致性诊断", s:"决策支持 · 分类 · 有界输出"},
      diamonds:{
        overview:{lab:"概览", sub:"一遍看清它做什么。"},
        use:{lab:"使用", sub:"输入→约束→输出。"},
        rules:{lab:"规则", sub:"可采信 + 崩塌姿态。"},
        deploy:{lab:"部署", sub:"它接到哪里。"}
      },
      hint:"本页有界。主张需要收据。导航保留 gd_* 状态。",
      lens:{formal:"正式", informal:"通俗", concept:"概念", live:"上线", roadmap:"路线图"},
      sections:{} /* (uses EN content if zh missing for this product page; keeps page stable) */
    },

    es:{
      header:{t:"Diagnóstico de Coherencia", s:"Soporte de decisión · clasificación · salidas acotadas"},
      diamonds:{
        overview:{lab:"RESUMEN", sub:"Qué hace, en una pasada."},
        use:{lab:"USO", sub:"Entradas → límites → salidas."},
        rules:{lab:"REGLAS", sub:"Admisibilidad + colapso."},
        deploy:{lab:"DESPLIEGUE", sub:"Dónde se conecta."}
      },
      hint:"Esta página es acotada. Las afirmaciones requieren recibos. La navegación conserva gd_*.",
      lens:{formal:"FORMAL", informal:"INFORMAL", concept:"CONCEPTO", live:"EN VIVO", roadmap:"RUTA"},
      sections:{} /* (fallback to EN if not expanded yet) */
    }
  };

  function pickPack(){
    return (lang==="zh") ? COPY.zh : (lang==="es") ? COPY.es : COPY.en;
  }

  // Apply language header/diamonds
  function applyLang(){
    var P=pickPack();
    document.getElementById("hdrT").textContent=P.header.t;
    document.getElementById("hdrS").textContent=P.header.s;

    document.getElementById("labOverview").textContent=P.diamonds.overview.lab;
    document.getElementById("subOverview").textContent=P.diamonds.overview.sub;
    document.getElementById("labUse").textContent=P.diamonds.use.lab;
    document.getElementById("subUse").textContent=P.diamonds.use.sub;
    document.getElementById("labRules").textContent=P.diamonds.rules.lab;
    document.getElementById("subRules").textContent=P.diamonds.rules.sub;
    document.getElementById("labDeploy").textContent=P.diamonds.deploy.lab;
    document.getElementById("subDeploy").textContent=P.diamonds.deploy.sub;

    document.getElementById("mHint").textContent=P.hint;

    document.getElementById("pillFormal").textContent=P.lens.formal;
    document.getElementById("pillInformal").textContent=P.lens.informal;
    document.getElementById("pillConcept").textContent=P.lens.concept;
    document.getElementById("pillLive").textContent=P.lens.live;
    document.getElementById("pillRoadmap").textContent=P.lens.roadmap;
  }
  applyLang();

  // ===== Modal engine =====
  var bd=document.getElementById("bd");
  var modal=document.getElementById("modal");
  var mClose=document.getElementById("mClose");
  var mTitle=document.getElementById("mTitle");

  var pillFormal=document.getElementById("pillFormal");
  var pillInformal=document.getElementById("pillInformal");
  var pillConcept=document.getElementById("pillConcept");
  var pillLive=document.getElementById("pillLive");
  var pillRoadmap=document.getElementById("pillRoadmap");

  var h1=document.getElementById("h1"), u1=document.getElementById("u1");
  var h2=document.getElementById("h2"), u2=document.getElementById("u2");
  var h3=document.getElementById("h3"), p3=document.getElementById("p3");
  var h4=document.getElementById("h4"), p4=document.getElementById("p4");

  var activeSection="overview"; // overview/use/rules/deploy

  function ulFill(el, items){
    el.innerHTML="";
    (items||[]).forEach(function(x){
      var li=document.createElement("li");
      li.textContent=x;
      el.appendChild(li);
    });
  }

  function getTimeKey(){
    return (time==="origin") ? "origin" : (time==="post") ? "post" : "now";
  }

  function getSectionPack(){
    var P=pickPack();
    // If zh/es sections not expanded yet, fallback to EN to keep system working.
    var base = P.sections && Object.keys(P.sections).length ? P : COPY.en;
    var sec = base.sections[activeSection] || COPY.en.sections[activeSection];
    var tKey = getTimeKey();
    var sKey = style; // formal/informal
    return sec[tKey][sKey];
  }

  function renderModal(){
    // active pills
    pillFormal.classList.toggle("active", style==="formal");
    pillInformal.classList.toggle("active", style==="informal");
    pillConcept.classList.toggle("active", time==="origin");
    pillLive.classList.toggle("active", time==="now");
    pillRoadmap.classList.toggle("active", time==="post");

    var view = getSectionPack();
    mTitle.textContent = view.title;

    h1.textContent = view.a.h; ulFill(u1, view.a.u);
    h2.textContent = view.b.h; ulFill(u2, view.b.u);
    h3.textContent = view.c.h; p3.textContent = view.c.p;
    h4.textContent = view.d.h; p4.textContent = view.d.p;

    try{
      localStorage.setItem("gd_style", style);
      localStorage.setItem("gd_time", time);
    }catch(e){}
  }

  function openModal(sectionKey){
    activeSection = sectionKey;
    renderModal();
    bd.classList.add("show");
    modal.classList.add("show");
  }

  function closeModal(){
    modal.classList.remove("show");
    bd.classList.remove("show");
  }

  // Close wiring (always)
  bd.addEventListener("click", closeModal);
  mClose.addEventListener("click", closeModal);

  // Lens wiring
  pillFormal.addEventListener("click", function(){ style="formal"; renderModal(); });
  pillInformal.addEventListener("click", function(){ style="informal"; renderModal(); });
  pillConcept.addEventListener("click", function(){ time="origin"; renderModal(); });
  pillLive.addEventListener("click", function(){ time="now"; renderModal(); });
  pillRoadmap.addEventListener("click", function(){ time="post"; renderModal(); });

  // Diamond wiring (no inline onclick)
  function bindDiamond(id, key){
    var el=document.getElementById(id);
    el.addEventListener("click", function(){ openModal(key); });
    el.addEventListener("keydown", function(e){
      if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openModal(key); }
    });
  }
  bindDiamond("dOverview","overview");
  bindDiamond("dUse","use");
  bindDiamond("dRules","rules");
  bindDiamond("dDeploy","deploy");

})();
</script>

</body>
</html>
