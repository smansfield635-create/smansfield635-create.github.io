<!-- TNT — /home/index.html
     HUB A · DIAMOND FORK TREE (FIXED) + RUSSIAN DOLL
     INSTRUMENT-COMPATIBLE:
       URL keys: lang/style/time/depth
       LS keys: gd_lang/gd_style/gd_time/gd_depth

     TREE (LOCKED):
       Start: N / E / S / W only
       Open Primary -> North Star + NE/NW/SE/SW
       Open Diagonal -> ENE/WNW/ESE/WSW
       Optional: WNW -> NNW, WSW -> SSW
       Open North Star -> local N/E/S/W

     CONTENT:
       One paragraph per lens (informal/formal)
       View: Informal/Formal/Both
       Language: EN/中文
       Per node Jump (fill JUMPS)
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HUB A · Index</title>

<link rel="stylesheet" href="/assets/ui.css"/>
<link rel="stylesheet" href="/assets/branch.css"/>
<script defer src="/assets/instruments.js"></script>

<style>
a{color:inherit;text-decoration:none}
:root{--dockH:92px}
.page{
  width:min(980px,94vw);
  margin:0 auto;
  padding:14px 0 calc(var(--dockH) + 22px);
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* header */
.header{
  border:1px solid rgba(255,255,255,.10);
  border-radius:22px;
  background:rgba(0,0,0,.14);
  backdrop-filter:blur(10px);
  padding:14px 16px;
  box-shadow:0 24px 80px rgba(0,0,0,.55);
}
.k{font-size:11px;letter-spacing:4px;text-transform:uppercase;opacity:.72;margin:0 0 6px}
.t{font-weight:950;font-size:24px;letter-spacing:.3px;margin:0 0 6px}
.s{font-size:13px;opacity:.82;line-height:1.5;margin:0;max-width:860px}
.ctrl{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin-top:12px}

/* node */
.node{
  --c:#93C5FD;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.06), transparent 55%),
    linear-gradient(160deg, rgba(12,22,38,.92), rgba(7,11,18,.95));
  box-shadow:0 18px 60px rgba(0,0,0,.62);
  overflow:hidden;
}
.nHead{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:14px 16px;cursor:pointer;font-weight:950;letter-spacing:.2px;
}
.nLeft{display:flex;align-items:center;gap:10px;min-width:0}
.diamond{
  width:12px;height:12px;transform:rotate(45deg);border-radius:4px;background:var(--c);
  box-shadow:0 0 0 1px rgba(255,255,255,.12),0 0 14px rgba(0,0,0,.35);
  flex:0 0 auto;pointer-events:none;
}
.nLabel{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nBody{
  display:none;
  padding:12px 14px 14px;
  border-top:1px solid rgba(255,255,255,.08);

  /* Russian doll scroll */
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
.node.open>.nBody{display:block}

.childStack{display:flex;flex-direction:column;gap:10px;margin-top:12px}

/* content */
.lensBlock{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:12px 14px;
  background:rgba(0,0,0,.18);
  margin-bottom:10px;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
}
.lensTitle{font-weight:950;font-size:12px;margin:0 0 8px;opacity:.88}
.paragraph{margin:0;line-height:1.72;font-size:14.5px;color:rgba(255,255,255,.90)}
.indexLine{
  margin-top:10px;padding:10px 12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.14);
  font-size:12.5px;color:rgba(255,255,255,.80)
}
.indexLine a{color:var(--gold);font-weight:950;text-decoration:none}

/* view filter */
.view-formal .lensBlock[data-lens="informal"]{display:none}
.view-informal .lensBlock[data-lens="formal"]{display:none}
.view-both .lensBlock{display:block}

/* dock */
.dock{
  position:fixed;left:50%;
  bottom:max(10px, env(safe-area-inset-bottom));
  transform:translateX(-50%);
  z-index:220;
  width:min(980px,94vw);
  padding:10px 12px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(10px);
  box-shadow:0 18px 60px rgba(0,0,0,.55);

  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:10px;
}
.dock .btn{width:100%;padding:10px 10px;border-radius:999px;}
.dock .full{grid-column:1 / -1;}
@media (max-width:520px){
  .dock{grid-template-columns:repeat(3, minmax(0,1fr))}
  .dock .full{grid-column:1 / -1;}
}
</style>
</head>

<body>

<div class="page">
  <div class="header" id="brand">
    <p class="k" id="hk">CARDINAL AXIS</p>
    <h1 class="t" id="ht">HUB A · Index</h1>
    <p class="s" id="hs">Diamond fork. Start with N/E/S/W. Each expands into North Star + diagonals. Diagonals refine only when opened.</p>

    <div class="ctrl">
      <button class="btn" id="vInformal" type="button">INFORMAL</button>
      <button class="btn" id="vFormal" type="button">FORMAL</button>
      <button class="btn" id="vBoth" type="button">BOTH</button>
      <button class="btn" id="bEN" type="button">EN</button>
      <button class="btn" id="bZH" type="button">中文</button>
    </div>
  </div>

  <div id="root"></div>
</div>

<div class="dock" id="dock" aria-label="Navigation">
  <button class="btn" id="navBack" type="button">BACK</button>
  <button class="btn" id="navForward" type="button">FORWARD</button>
  <button class="btn" id="navHub" type="button">HUB</button>
  <button class="btn" id="navExplore" type="button">EXPLORE</button>
  <button class="btn" id="navProducts" type="button">PRODUCTS</button>
  <button class="btn" id="navLaws" type="button">LAWS</button>
  <button class="btn" id="navGauges" type="button">GAUGES</button>
  <button class="btn" id="navTop" type="button">TOP</button>
  <button class="btn full" id="navJump" type="button">JUMP (ACTIVE PROJECT)</button>
</div>

<script>
(function(){
  // ---- Instrument-compatible state: URL keys lang/style/time/depth ----
  const qs=new URLSearchParams(location.search);
  const lsGet=k=>{try{return localStorage.getItem(k)}catch(e){return null}};
  const lsSet=(k,v)=>{try{localStorage.setItem(k,String(v))}catch(e){}};

  let lang  = qs.get("lang")  || lsGet("gd_lang")  || "en";
  let style = qs.get("style") || lsGet("gd_style") || "formal";
  let time  = qs.get("time")  || lsGet("gd_time")  || "now";
  let depth = qs.get("depth") || lsGet("gd_depth") || "explore";

  if(lang!=="en"&&lang!=="zh") lang="en";
  if(style!=="formal"&&style!=="informal") style="formal";
  if(time!=="origin"&&time!=="now"&&time!=="post") time="now";
  if(depth!=="explore"&&depth!=="learn") depth="explore";

  lsSet("gd_lang",lang); lsSet("gd_style",style); lsSet("gd_time",time); lsSet("gd_depth",depth);
  document.documentElement.lang=lang;

  function makeQS(over){
    const p=new URLSearchParams();
    p.set("lang",  (over&&over.lang)  || lang);
    p.set("style", (over&&over.style) || style);
    p.set("time",  (over&&over.time)  || time);
    p.set("depth", (over&&over.depth) || depth);
    return "?"+p.toString();
  }
  function nav(path){ location.href = path + makeQS(); }

  // ---- View toggle (UI only) ----
  const root=document.getElementById("root");
  const vInformal=document.getElementById("vInformal");
  const vFormal=document.getElementById("vFormal");
  const vBoth=document.getElementById("vBoth");
  function applyView(v){
    root.classList.remove("view-formal","view-informal","view-both");
    root.classList.add("view-"+v);
    vInformal.classList.toggle("active", v==="informal");
    vFormal.classList.toggle("active", v==="formal");
    vBoth.classList.toggle("active", v==="both");
  }
  applyView(style);

  vInformal.onclick=()=>applyView("informal");
  vFormal.onclick=()=>applyView("formal");
  vBoth.onclick=()=>applyView("both");

  // ---- Lang toggle (instrument-compatible: URL uses lang=) ----
  const bEN=document.getElementById("bEN");
  const bZH=document.getElementById("bZH");
  function paintLang(){
    bEN.classList.toggle("active", lang==="en");
    bZH.classList.toggle("active", lang==="zh");
    hk.textContent = (lang==="zh") ? "基轴体系" : "CARDINAL AXIS";
    ht.textContent = (lang==="zh") ? "枢纽A · 索引" : "HUB A · Index";
    hs.textContent = (lang==="zh")
      ? "钻石分叉。从N/E/S/W开始。展开为北极星 + 对角。对角仅在打开时细化。"
      : "Diamond fork. Start with N/E/S/W. Each expands into North Star + diagonals. Diagonals refine only when opened.";
  }
  const hk=document.getElementById("hk");
  const ht=document.getElementById("ht");
  const hs=document.getElementById("hs");
  paintLang();

  function snapshotOpen(){
    const ids=[];
    root.querySelectorAll(".node.open").forEach(n=>ids.push(n.getAttribute("data-id")));
    return ids;
  }
  function restoreOpen(ids){
    const set=new Set(ids);
    root.querySelectorAll(".node").forEach(n=>{
      if(set.has(n.getAttribute("data-id"))) n.classList.add("open");
    });
    recomputeHeights();
  }

  function setLang(next){
    const open=snapshotOpen();
    lang=next;
    lsSet("gd_lang",lang);
    document.documentElement.lang=lang;
    history.replaceState({}, "", location.pathname + makeQS({lang}));
    paintLang();
    render();
    restoreOpen(open);
  }
  bEN.onclick=()=>setLang("en");
  bZH.onclick=()=>setLang("zh");

  // ---- FIXED TREE (Diamond Fork functioning correctly) ----
  // PRIMARY: N/E/S/W only
  // Each primary children: STAR + NE/NW/SE/SW
  // Diagonal refinement: NE->ENE, NW->WNW, SE->ESE, SW->WSW
  // Optional: WNW->NNW, WSW->SSW
  // STAR children: local N/E/S/W
  const TREE = {
    N:{label:{en:"N · DEFINITIONS",zh:"N · 定义"}, color:"#1F3A8A", children:["N★","N:NE","N:NW","N:SE","N:SW"]},
    E:{label:{en:"E · PRODUCTS",zh:"E · 产品"}, color:"#0EA5E9", children:["E★","E:NE","E:NW","E:SE","E:SW"]},
    S:{label:{en:"S · CONSTRAINTS",zh:"S · 约束"}, color:"#F59E0B", children:["S★","S:NE","S:NW","S:SE","S:SW"]},
    W:{label:{en:"W · CONTAINMENT",zh:"W · 隔离"}, color:"#7F1D1D", children:["W★","W:NE","W:NW","W:SE","W:SW"]},

    // Star nodes
    "N★":{label:{en:"NORTH STAR",zh:"北极星"}, color:"#2C3EAF", children:["N★:N","N★:E","N★:S","N★:W"]},
    "E★":{label:{en:"NORTH STAR",zh:"北极星"}, color:"#2C3EAF", children:["E★:N","E★:E","E★:S","E★:W"]},
    "S★":{label:{en:"NORTH STAR",zh:"北极星"}, color:"#2C3EAF", children:["S★:N","S★:E","S★:S","S★:W"]},
    "W★":{label:{en:"NORTH STAR",zh:"北极星"}, color:"#2C3EAF", children:["W★:N","W★:E","W★:S","W★:W"]},

    // Diagonals (same labels, but unique IDs)
    "N:NE":{label:{en:"NE",zh:"NE"}, color:"#2C3EAF", children:["N:ENE"]},
    "N:NW":{label:{en:"NW",zh:"NW"}, color:"#9333EA", children:["N:WNW"]},
    "N:SE":{label:{en:"SE",zh:"SE"}, color:"#14B8A6", children:["N:ESE"]},
    "N:SW":{label:{en:"SW",zh:"SW"}, color:"#EA580C", children:["N:WSW"]},

    "E:NE":{label:{en:"NE",zh:"NE"}, color:"#2C3EAF", children:["E:ENE"]},
    "E:NW":{label:{en:"NW",zh:"NW"}, color:"#9333EA", children:["E:WNW"]},
    "E:SE":{label:{en:"SE",zh:"SE"}, color:"#14B8A6", children:["E:ESE"]},
    "E:SW":{label:{en:"SW",zh:"SW"}, color:"#EA580C", children:["E:WSW"]},

    "S:NE":{label:{en:"NE",zh:"NE"}, color:"#2C3EAF", children:["S:ENE"]},
    "S:NW":{label:{en:"NW",zh:"NW"}, color:"#9333EA", children:["S:WNW"]},
    "S:SE":{label:{en:"SE",zh:"SE"}, color:"#14B8A6", children:["S:ESE"]},
    "S:SW":{label:{en:"SW",zh:"SW"}, color:"#EA580C", children:["S:WSW"]},

    "W:NE":{label:{en:"NE",zh:"NE"}, color:"#2C3EAF", children:["W:ENE"]},
    "W:NW":{label:{en:"NW",zh:"NW"}, color:"#9333EA", children:["W:WNW"]},
    "W:SE":{label:{en:"SE",zh:"SE"}, color:"#14B8A6", children:["W:ESE"]},
    "W:SW":{label:{en:"SW",zh:"SW"}, color:"#EA580C", children:["W:WSW"]},

    // Refinements
    "N:ENE":{label:{en:"ENE",zh:"ENE"}, color:"#4B3FBF", children:[]},
    "N:WNW":{label:{en:"WNW",zh:"WNW"}, color:"#9333EA", children:["N:NNW"]},
    "N:ESE":{label:{en:"ESE",zh:"ESE"}, color:"#14B8A6", children:[]},
    "N:WSW":{label:{en:"WSW",zh:"WSW"}, color:"#DC2626", children:["N:SSW"]},
    "N:NNW":{label:{en:"NNW",zh:"NNW"}, color:"#334155", children:[]},
    "N:SSW":{label:{en:"SSW",zh:"SSW"}, color:"#EA580C", children:[]},

    "E:ENE":{label:{en:"ENE",zh:"ENE"}, color:"#4B3FBF", children:[]},
    "E:WNW":{label:{en:"WNW",zh:"WNW"}, color:"#9333EA", children:["E:NNW"]},
    "E:ESE":{label:{en:"ESE",zh:"ESE"}, color:"#14B8A6", children:[]},
    "E:WSW":{label:{en:"WSW",zh:"WSW"}, color:"#DC2626", children:["E:SSW"]},
    "E:NNW":{label:{en:"NNW",zh:"NNW"}, color:"#334155", children:[]},
    "E:SSW":{label:{en:"SSW",zh:"SSW"}, color:"#EA580C", children:[]},

    "S:ENE":{label:{en:"ENE",zh:"ENE"}, color:"#4B3FBF", children:[]},
    "S:WNW":{label:{en:"WNW",zh:"WNW"}, color:"#9333EA", children:["S:NNW"]},
    "S:ESE":{label:{en:"ESE",zh:"ESE"}, color:"#14B8A6", children:[]},
    "S:WSW":{label:{en:"WSW",zh:"WSW"}, color:"#DC2626", children:["S:SSW"]},
    "S:NNW":{label:{en:"NNW",zh:"NNW"}, color:"#334155", children:[]},
    "S:SSW":{label:{en:"SSW",zh:"SSW"}, color:"#EA580C", children:[]},

    "W:ENE":{label:{en:"ENE",zh:"ENE"}, color:"#4B3FBF", children:[]},
    "W:WNW":{label:{en:"WNW",zh:"WNW"}, color:"#9333EA", children:["W:NNW"]},
    "W:ESE":{label:{en:"ESE",zh:"ESE"}, color:"#14B8A6", children:[]},
    "W:WSW":{label:{en:"WSW",zh:"WSW"}, color:"#DC2626", children:["W:SSW"]},
    "W:NNW":{label:{en:"NNW",zh:"NNW"}, color:"#334155", children:[]},
    "W:SSW":{label:{en:"SSW",zh:"SSW"}, color:"#EA580C", children:[]},

    // Star-local micro compass labels (these are where NN/SN/EN/WN concept can be layered later)
    "N★:N":{label:{en:"N",zh:"N"}, color:"#1F3A8A", children:[]},
    "N★:E":{label:{en:"E",zh:"E"}, color:"#0EA5E9", children:[]},
    "N★:S":{label:{en:"S",zh:"S"}, color:"#F59E0B", children:[]},
    "N★:W":{label:{en:"W",zh:"W"}, color:"#7F1D1D", children:[]},

    "E★:N":{label:{en:"N",zh:"N"}, color:"#1F3A8A", children:[]},
    "E★:E":{label:{en:"E",zh:"E"}, color:"#0EA5E9", children:[]},
    "E★:S":{label:{en:"S",zh:"S"}, color:"#F59E0B", children:[]},
    "E★:W":{label:{en:"W",zh:"W"}, color:"#7F1D1D", children:[]},

    "S★:N":{label:{en:"N",zh:"N"}, color:"#1F3A8A", children:[]},
    "S★:E":{label:{en:"E",zh:"E"}, color:"#0EA5E9", children:[]},
    "S★:S":{label:{en:"S",zh:"S"}, color:"#F59E0B", children:[]},
    "S★:W":{label:{en:"W",zh:"W"}, color:"#7F1D1D", children:[]},

    "W★:N":{label:{en:"N",zh:"N"}, color:"#1F3A8A", children:[]},
    "W★:E":{label:{en:"E",zh:"E"}, color:"#0EA5E9", children:[]},
    "W★:S":{label:{en:"S",zh:"S"}, color:"#F59E0B", children:[]},
    "W★:W":{label:{en:"W",zh:"W"}, color:"#7F1D1D", children:[]}
  };

  // ---- JUMPS (fill real routes later) ----
  const JUMPS = {}; // key: node id -> route string

  // ---- copy: minimal (kept short; you can expand) ----
  function copyFor(id, lens){
    // lens: "informal" | "formal"
    // If you want, you can replace this with per-node text tables later.
    if(lang==="zh"){
      return lens==="formal"
        ? "（正式）该节点定义边界并约束解释，使扩张不漂移。"
        : "（非正式）该节点把含义钉住，让扩张不乱跑。";
    }
    return lens==="formal"
      ? "(Formal) This node constrains meaning and enforces boundaries so growth cannot drift."
      : "(Informal) This node pins meaning so expansion stays disciplined instead of chaotic.";
  }

  function lensTitle(lens){
    return (lens==="formal")
      ? (lang==="zh" ? "正式" : "Formal")
      : (lang==="zh" ? "非正式" : "Informal");
  }

  function makeLensBlock(lens, txt){
    const b=document.createElement("div");
    b.className="lensBlock";
    b.setAttribute("data-lens", lens);
    const t=document.createElement("div");
    t.className="lensTitle";
    t.textContent=lensTitle(lens);
    const p=document.createElement("div");
    p.className="paragraph";
    p.textContent=txt;
    b.appendChild(t); b.appendChild(p);
    return b;
  }

  function makeIndexLine(id){
    const line=document.createElement("div");
    line.className="indexLine";
    const lbl = (lang==="zh") ? TREE[id].label.zh : TREE[id].label.en;
    line.append((lang==="zh") ? ("索引：跳转到 "+lbl+" 对应项目。 ") : ("Index: jump to the project for "+lbl+". "));
    const a=document.createElement("a");
    const target = JUMPS[id] || "#";
    a.href = (target==="#") ? "#" : (target + makeQS());
    a.textContent = (lang==="zh") ? "跳转" : "Jump";
    line.appendChild(a);
    return line;
  }

  function makeNode(id){
    const info = TREE[id];

    const s=document.createElement("section");
    s.className="node";
    s.style.setProperty("--c", info.color || "#93C5FD");
    s.setAttribute("data-id", id);

    const h=document.createElement("div");
    h.className="nHead";
    h.innerHTML="<div class='nLeft'><div class='diamond'></div><div class='nLabel'>"+((lang==="zh")?info.label.zh:info.label.en)+"</div></div><div>▸</div>";

    const b=document.createElement("div");
    b.className="nBody";

    b.appendChild(makeLensBlock("informal", copyFor(id,"informal")));
    b.appendChild(makeLensBlock("formal", copyFor(id,"formal")));
    b.appendChild(makeIndexLine(id));

    if(info.children && info.children.length){
      const stack=document.createElement("div");
      stack.className="childStack";
      info.children.forEach(child=>stack.appendChild(makeNode(child)));
      b.appendChild(stack);
    }

    h.addEventListener("click",()=>{
      s.classList.toggle("open");
      localStorage.setItem("hub_active_node", id);
      recomputeHeights();
    });

    s.appendChild(h);
    s.appendChild(b);
    return s;
  }

  function render(){
    root.innerHTML="";
    ["N","E","S","W"].forEach(k=>root.appendChild(makeNode(k)));
    recomputeHeights();
  }

  // Russian doll cap
  function recomputeHeights(){
    const dockEl=document.getElementById("dock");
    const dockH = dockEl ? dockEl.getBoundingClientRect().height : 92;
    document.documentElement.style.setProperty("--dockH", dockH + "px");

    const brandH = brand ? brand.getBoundingClientRect().height : 0;
    const viewportH = window.innerHeight || 800;
    const avail = Math.max(220, viewportH - brandH - dockH - 48);

    root.querySelectorAll(".node.open .nBody").forEach(el=>{
      el.style.maxHeight = avail + "px";
    });
  }
  window.addEventListener("resize", recomputeHeights);

  // Dock
  navBack.onclick=()=>history.back();
  navForward.onclick=()=>history.forward();
  navHub.onclick=()=>nav("/home/");
  navExplore.onclick=()=>nav("/explore/");
  navProducts.onclick=()=>nav("/products/");
  navLaws.onclick=()=>nav("/laws/");
  navGauges.onclick=()=>nav("/gauges/");
  navTop.onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
  navJump.onclick=()=>{
    const id = localStorage.getItem("hub_active_node") || "N";
    const target = JUMPS[id] || "#";
    if(target==="#") return;
    location.href = target + makeQS();
  };

  // Init
  render();

})();
</script>

</body>
</html>
