<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
  <style>
    .gauge-ring {
      --size: 220px;
      width: var(--size);
      height: var(--size);
      border-radius: 50%;
      display: grid;
      place-items: center;
      background:
        conic-gradient(
          var(--color) calc(var(--pct) * 1%),
          rgba(255,255,255,0.08) 0
        );
      box-shadow: inset 0 0 0 18px rgba(0,0,0,.35);
    }
    .gauge-core {
      width: 70%;
      height: 70%;
      border-radius: 50%;
      background: radial-gradient(circle at top, #0b1624, #02040a);
      display: grid;
      place-items: center;
      text-align: center;
    }
    .gauge-value {
      font-size: 2.4rem;
      font-weight: 700;
    }
    .gauge-label {
      opacity: .7;
      font-size: .9rem;
      margin-top: -.3rem;
    }
    .bar {
      height: 12px;
      border-radius: 8px;
      background: rgba(255,255,255,.12);
      overflow: hidden;
    }
    .bar > span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4da3ff, #42e6a4);
      transition: width .4s ease;
    }
    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: gold;
    }
  </style>
</head>

<body class="bg-gradient">
<main class="page">

  <section class="panel hero">
    <h1>Control</h1>
    <p class="subtitle">Live gauges. Truth first. Read-only by design.</p>
  </section>

  <section class="panel bubble">
    <h3>Truth source</h3>
    <code id="source"></code>

    <div class="meta-grid" style="margin-top:12px">
      <div>Polling</div><div><strong>10s</strong></div>
      <div>Last updated</div><div id="lastUpdated">—</div>
      <div>Age (sec)</div><div id="age">—</div>
    </div>

    <div style="margin-top:12px">
      <span class="pill">
        <span class="dot"></span>
        <strong id="status">DEGRADED</strong>
      </span>
    </div>
  </section>

  <section class="panel">
    <h3>Gauges</h3>

    <div class="gauge-ring" id="pvGauge" style="--pct:0;--color:#3ddc97">
      <div class="gauge-core">
        <div>
          <div class="gauge-value" id="pv">0</div>
          <div class="gauge-label">Pageviews</div>
        </div>
      </div>
    </div>

    <div class="gauge-ring" id="clickGauge" style="--pct:0;--color:#f4c430;margin-top:24px">
      <div class="gauge-core">
        <div>
          <div class="gauge-value" id="clicks">0</div>
          <div class="gauge-label">Clicks</div>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>Sources (to scale)</h3>

    <div>GitHub <span id="ghVal">0</span></div>
    <div class="bar"><span id="ghBar"></span></div>

    <div style="margin-top:8px">Direct <span id="dirVal">0</span></div>
    <div class="bar"><span id="dirBar"></span></div>

    <div style="margin-top:8px">OSF <span id="osfVal">0</span></div>
    <div class="bar"><span id="osfBar"></span></div>
  </section>

</main>

<script>
const URL = "https://geodiametrics-aggregator.smansfield635.workers.dev/metrics";
document.getElementById("source").textContent = URL;

function pct(val, max) {
  if (!max) return 0;
  return Math.min(100, Math.round((val / max) * 100));
}

async function refresh() {
  try {
    const res = await fetch(URL, { cache: "no-store" });
    const data = await res.json();

    const now = Date.now();
    const updated = data.meta?.now ?? null;

    document.getElementById("status").textContent = data.status ?? "UNKNOWN";

    if (updated) {
      const age = Math.floor((now - updated) / 1000);
      document.getElementById("lastUpdated").textContent =
        new Date(updated).toLocaleTimeString();
      document.getElementById("age").textContent = age;
    } else {
      document.getElementById("lastUpdated").textContent = "—";
      document.getElementById("age").textContent = "—";
    }

    const pv = data.metrics?.pageviews ?? 0;
    const clicks = data.metrics?.clicks ?? 0;

    document.getElementById("pv").textContent = pv;
    document.getElementById("clicks").textContent = clicks;

    document.getElementById("pvGauge").style.setProperty("--pct", Math.min(100, pv));
    document.getElementById("clickGauge").style.setProperty("--pct", Math.min(100, clicks));

    const sources = data.sources || {};
    const maxSrc = Math.max(...Object.values(sources), 1);

    const gh = sources.GitHub || 0;
    const dir = sources.Direct || 0;
    const osf = sources.OSF || 0;

    document.getElementById("ghVal").textContent = gh;
    document.getElementById("dirVal").textContent = dir;
    document.getElementById("osfVal").textContent = osf;

    document.getElementById("ghBar").style.width = pct(gh, maxSrc) + "%";
    document.getElementById("dirBar").style.width = pct(dir, maxSrc) + "%";
    document.getElementById("osfBar").style.width = pct(osf, maxSrc) + "%";

  } catch (e) {
    console.error(e);
  }
}

refresh();
setInterval(refresh, 10000);
</script>
</body>
</html>
