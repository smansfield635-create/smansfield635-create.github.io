<!-- FINAL IMPLEMENTATION — TNT #5 / STATE
     Full replace of /control/index.html
     Route stays /control/ (no renames). UI label = State.
     Gauges preserved, condensed, observer-only. -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>State · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
</head>

<body class="bg-gradient">

<main class="page">

  <!-- STATE = DIMENSIONAL EXPERIENCE / OBSERVATION -->
  <section class="panel hero">
    <h1>State</h1>
    <p class="subtitle">
      Live system condition. Read-only. No intervention.
    </p>
  </section>

  <!-- HEALTH / PRESENCE -->
  <section class="panel tight">
    <div class="kv">
      <div class="k">Health</div>
      <div class="v"><span id="healthBadge" class="badge">—</span></div>

      <div class="k">Last update</div>
      <div class="v" id="lastUpdated">—</div>

      <div class="k">Age (sec)</div>
      <div class="v" id="ageSec">—</div>
    </div>
  </section>

  <!-- GAUGES (CONDENSED, COLOR-LED) -->
  <section class="panel">
    <details class="drop" open>
      <summary>Gauges</summary>
      <div class="drop-body">

        <div class="kv">
          <div class="k">Sessions</div><div class="v" id="v_sessions">—</div>
        </div>
        <div class="bar"><i id="b_sessions"></i></div>

        <div class="spacer"></div>

        <div class="kv">
          <div class="k">Pageviews</div><div class="v" id="v_pageviews">—</div>
        </div>
        <div class="bar"><i id="b_pageviews"></i></div>

        <div class="spacer"></div>

        <div class="kv">
          <div class="k">Clicks</div><div class="v" id="v_clicks">—</div>
        </div>
        <div class="bar"><i id="b_clicks"></i></div>

        <div class="spacer"></div>

        <div class="kv">
          <div class="k">Writes</div><div class="v" id="v_writes">—</div>
        </div>
        <div class="bar"><i id="b_writes"></i></div>

        <p class="note">
          Color indicates intensity relative to the current maximum.
        </p>
      </div>
    </details>
  </section>

  <!-- SOURCES -->
  <section class="panel">
    <details class="drop">
      <summary>Sources</summary>
      <div class="drop-body">

        <div class="kv">
          <div class="k">GitHub</div><div class="v" id="s_github">—</div>
        </div>
        <div class="bar"><i id="b_github"></i></div>

        <div class="spacer"></div>

        <div class="kv">
          <div class="k">OSF</div><div class="v" id="s_osf">—</div>
        </div>
        <div class="bar"><i id="b_osf"></i></div>

        <div class="spacer"></div>

        <div class="kv">
          <div class="k">Direct</div><div class="v" id="s_direct">—</div>
        </div>
        <div class="bar"><i id="b_direct"></i></div>

        <div class="spacer"></div>

        <div class="kv">
          <div class="k">Other</div><div class="v" id="s_other">—</div>
        </div>
        <div class="bar"><i id="b_other"></i></div>

      </div>
    </details>
  </section>

  <!-- RAW (OPTIONAL) -->
  <section class="panel tight">
    <details class="drop">
      <summary>Raw payload</summary>
      <div class="drop-body">
        <pre id="raw" class="mono">{}</pre>
      </div>
    </details>
  </section>

  <!-- CHOICES -->
  <section class="panel">
    <div class="nav-grid">
      <a class="btn" href="/">Home</a>
      <a class="btn" href="/laws/">Laws</a>
      <a class="btn" href="/principles/">Principles</a>
      <a class="btn" href="/geodynamics/">Geodynamics</a>
      <a class="btn" href="/engine/">Engine</a>
      <a class="btn" href="/reference/">Reference</a>
      <a class="btn" href="/about/">About</a>
    </div>
  </section>

  <!-- FOOTER -->
  <div class="footer">
    <span>© Geodiametrics</span>
    <span>·</span>
    <span>Canonical</span>
  </div>

</main>

<script>
  // Observer-only poll (no writes)
  const POLL_MS = 10000;
  const TRUTH_BASE = "https://geodiametrics-aggregator.smansfield635.workers.dev";
  const METRICS_URL = TRUTH_BASE + "/metrics";

  const el = (id)=>document.getElementById(id);
  const num = (v)=> (typeof v==="number" && isFinite(v)) ? v : 0;
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const pct=(v,m)=>m<=0?0:clamp((v/m)*100,0,100);

  function colorFor(p){
    if(p>=66) return "rgba(34,197,94,.85)";   // green
    if(p>=33) return "rgba(234,179,8,.85)";   // amber
    return "rgba(239,68,68,.85)";              // red
  }
  function setBar(id,p){
    const b=el(id); b.style.width=p.toFixed(1)+"%"; b.style.background=colorFor(p);
  }
  function fmt(ms){ const d=new Date(ms); return isNaN(d)? "—" : d.toLocaleString(); }

  async function tick(){
    try{
      const r=await fetch(METRICS_URL+"?t="+Date.now(),{cache:"no-store"});
      const j=await r.json();
      el("raw").textContent=JSON.stringify(j,null,2);

      const m=j.metrics||{};
      const s=m.sources||j.sources||{};

      const vals=[
        num(m.sessions), num(m.pageviews), num(m.clicks), num(m.writes),
        num(s.GitHub), num(s.OSF), num(s.Direct), num(s.Other)
      ];
      const max=Math.max(1,...vals);

      el("v_sessions").textContent=num(m.sessions);
      el("v_pageviews").textContent=num(m.pageviews);
      el("v_clicks").textContent=num(m.clicks);
      el("v_writes").textContent=num(m.writes);

      setBar("b_sessions",pct(num(m.sessions),max));
      setBar("b_pageviews",pct(num(m.pageviews),max));
      setBar("b_clicks",pct(num(m.clicks),max));
      setBar("b_writes",pct(num(m.writes),max));

      el("s_github").textContent=num(s.GitHub);
      el("s_osf").textContent=num(s.OSF);
      el("s_direct").textContent=num(s.Direct);
      el("s_other").textContent=num(s.Other);

      setBar("b_github",pct(num(s.GitHub),max));
      setBar("b_osf",pct(num(s.OSF),max));
      setBar("b_direct",pct(num(s.Direct),max));
      setBar("b_other",pct(num(s.Other),max));

      const lu=num(m.lastUpdated||j.lastUpdated);
      el("lastUpdated").textContent=fmt(lu);
      el("ageSec").textContent=lu? Math.max(0,Math.floor((Date.now()-lu)/1000)):"—";

      const status=(j.status||"").toUpperCase();
      const errors=num(m.errors);
      const stale=lu? (Date.now()-lu)>(POLL_MS*3):true;
      el("healthBadge").textContent = (status==="OPERATIONAL"&&!stale&&!errors)?"GREEN":(status==="DEGRADED"||stale||errors)?"AMBER":"RED";
    }catch(e){
      el("healthBadge").textContent="RED";
    }
  }
  tick(); setInterval(tick,POLL_MS);
</script>

</body>
</html>
