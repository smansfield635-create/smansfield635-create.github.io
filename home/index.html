<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Compass</title>

  <!-- CSS ORDER (CANON): ui.css FIRST, branch.css SECOND -->
  <link rel="stylesheet" href="/assets/ui.css" />
  <link rel="stylesheet" href="/assets/branch.css" />

  <!-- INSTRUMENT (state normalization) -->
  <script defer src="/assets/instrument.js"></script>
</head>

<body>
  <main class="crp-shell">
    <header class="crp-topbar" aria-label="Global controls">
      <div class="crp-topbar-left">
        <div class="crp-mark" aria-hidden="true">CRP</div>
        <h1 class="crp-title">Compass</h1>
      </div>

      <div class="crp-topbar-right">
        <!-- TIME tri-lens -->
        <div class="crp-lens" role="group" aria-label="Time lens">
          <button class="crp-chip" type="button" data-time="origin">Origin</button>
          <button class="crp-chip" type="button" data-time="now">Now</button>
          <button class="crp-chip" type="button" data-time="trajectory">Trajectory</button>
        </div>

        <!-- STYLE lens -->
        <div class="crp-lens" role="group" aria-label="Style lens">
          <button class="crp-chip" type="button" data-style="formal">Formal</button>
          <button class="crp-chip" type="button" data-style="informal">Informal</button>
        </div>
      </div>
    </header>

    <section class="crp-compass" aria-label="Quadrants">
      <!-- EXACTLY 4 QUADRANTS -->
      <article class="crp-quadrant" data-quadrant="NW" aria-label="Northwest">
        <h2 class="crp-quadrant-title">NW</h2>
        <div class="crp-vines" role="list">
          <!-- EXACTLY 4 VINES -->
          <button class="crp-vine" type="button" data-vine="NW-1" role="listitem">NW Vine 1</button>
          <button class="crp-vine" type="button" data-vine="NW-2" role="listitem">NW Vine 2</button>
          <button class="crp-vine" type="button" data-vine="NW-3" role="listitem">NW Vine 3</button>
          <button class="crp-vine" type="button" data-vine="NW-4" role="listitem">NW Vine 4</button>
        </div>
      </article>

      <article class="crp-quadrant" data-quadrant="NE" aria-label="Northeast">
        <h2 class="crp-quadrant-title">NE</h2>
        <div class="crp-vines" role="list">
          <button class="crp-vine" type="button" data-vine="NE-1" role="listitem">NE Vine 1</button>
          <button class="crp-vine" type="button" data-vine="NE-2" role="listitem">NE Vine 2</button>
          <button class="crp-vine" type="button" data-vine="NE-3" role="listitem">NE Vine 3</button>
          <button class="crp-vine" type="button" data-vine="NE-4" role="listitem">NE Vine 4</button>
        </div>
      </article>

      <article class="crp-quadrant" data-quadrant="SW" aria-label="Southwest">
        <h2 class="crp-quadrant-title">SW</h2>
        <div class="crp-vines" role="list">
          <button class="crp-vine" type="button" data-vine="SW-1" role="listitem">SW Vine 1</button>
          <button class="crp-vine" type="button" data-vine="SW-2" role="listitem">SW Vine 2</button>
          <button class="crp-vine" type="button" data-vine="SW-3" role="listitem">SW Vine 3</button>
          <button class="crp-vine" type="button" data-vine="SW-4" role="listitem">SW Vine 4</button>
        </div>
      </article>

      <article class="crp-quadrant" data-quadrant="SE" aria-label="Southeast">
        <h2 class="crp-quadrant-title">SE</h2>
        <div class="crp-vines" role="list">
          <button class="crp-vine" type="button" data-vine="SE-1" role="listitem">SE Vine 1</button>
          <button class="crp-vine" type="button" data-vine="SE-2" role="listitem">SE Vine 2</button>
          <button class="crp-vine" type="button" data-vine="SE-3" role="listitem">SE Vine 3</button>
          <button class="crp-vine" type="button" data-vine="SE-4" role="listitem">SE Vine 4</button>
        </div>
      </article>
    </section>
  </main>

  <!-- MODAL OVERLAY (owned/styled by /assets/branch.css; no page-level styles) -->
  <div id="crp-modal" class="crp-modal" hidden aria-hidden="true">
    <div class="crp-modal-backdrop" data-modal-close="1"></div>

    <div class="crp-modal-panel" role="dialog" aria-modal="true" aria-label="Detail">
      <header class="crp-modal-header">
        <div class="crp-modal-titlewrap">
          <div class="crp-modal-kicker" id="modal-kicker">Vine</div>
          <h3 class="crp-modal-title" id="modal-title">Select a fruit</h3>
        </div>

        <button class="crp-modal-close" type="button" aria-label="Close" data-modal-close="1">✕</button>
      </header>

      <!-- FRUIT LIST VIEW -->
      <section id="modal-fruits-view" class="crp-modal-body" aria-label="Fruits">
        <p class="crp-modal-hint" id="modal-hint">Choose one.</p>

        <div class="crp-fruits" role="list" aria-label="Fruit options">
          <!-- EXACTLY 4 FRUITS (buttons) -->
          <button class="crp-fruit" type="button" data-fruit="F1" role="listitem">Fruit 1</button>
          <button class="crp-fruit" type="button" data-fruit="F2" role="listitem">Fruit 2</button>
          <button class="crp-fruit" type="button" data-fruit="F3" role="listitem">Fruit 3</button>
          <button class="crp-fruit" type="button" data-fruit="F4" role="listitem">Fruit 4</button>
        </div>
      </section>

      <!-- RESOLUTION VIEW -->
      <section id="modal-resolution-view" class="crp-modal-body" aria-label="Resolution" hidden>
        <div class="crp-resolution">
          <p id="res-paragraph" class="crp-resolution-paragraph"></p>
          <ul id="res-bullets" class="crp-resolution-bullets"></ul>
          <div class="crp-resolution-implication">
            <div class="crp-resolution-implication-label">Implication</div>
            <p id="res-implication" class="crp-resolution-implication-text"></p>
          </div>

          <div class="crp-resolution-actions">
            <button id="res-back" class="crp-btn" type="button">Back</button>
          </div>
        </div>
      </section>

      <footer class="crp-modal-footer">
        <small class="crp-footnote">
          Depth: <span id="ui-depth">explore</span> · Time: <span id="ui-time">origin</span> · Style: <span id="ui-style">formal</span>
        </small>
      </footer>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      // CANONICAL STATE KEYS ONLY
      var KEY_LANG  = "gd_lang";
      var KEY_DEPTH = "gd_depth";
      var KEY_TIME  = "gd_time";
      var KEY_STYLE = "gd_style";

      var ALLOWED_LANG  = { en: 1, zh: 1 };
      var ALLOWED_DEPTH = { explore: 1, learn: 1 };
      var ALLOWED_TIME  = { origin: 1, now: 1, trajectory: 1 };
      var ALLOWED_STYLE = { formal: 1, informal: 1 };

      function qp(name) {
        try { return new URLSearchParams(window.location.search).get(name); }
        catch (e) { return null; }
      }

      function lsGet(k) {
        try { return localStorage.getItem(k); } catch (e) { return null; }
      }

      function lsSet(k, v) {
        try { localStorage.setItem(k, v); } catch (e) {}
      }

      function normalize() {
        // Language must exist (inherited from Index). If missing, force back to start.
        var lang = qp("lang") || lsGet(KEY_LANG);
        if (!ALLOWED_LANG[lang]) {
          window.location.href = "/";
          return null;
        }
        lsSet(KEY_LANG, lang);

        var depth = qp("depth") || lsGet(KEY_DEPTH);
        if (!ALLOWED_DEPTH[depth]) depth = "explore";
        lsSet(KEY_DEPTH, depth);

        var time = qp("time") || lsGet(KEY_TIME);
        if (!ALLOWED_TIME[time]) time = "origin";
        lsSet(KEY_TIME, time);

        var style = qp("style") || lsGet(KEY_STYLE);
        if (!ALLOWED_STYLE[style]) style = "formal";
        lsSet(KEY_STYLE, style);

        return { lang: lang, depth: depth, time: time, style: style };
      }

      var state = normalize();
      if (!state) return;

      // UI refs
      var modal = document.getElementById("crp-modal");
      var modalKicker = document.getElementById("modal-kicker");
      var modalTitle = document.getElementById("modal-title");
      var modalHint = document.getElementById("modal-hint");

      var fruitsView = document.getElementById("modal-fruits-view");
      var resView = document.getElementById("modal-resolution-view");

      var resP = document.getElementById("res-paragraph");
      var resBullets = document.getElementById("res-bullets");
      var resImp = document.getElementById("res-implication");
      var resBack = document.getElementById("res-back");

      var uiDepth = document.getElementById("ui-depth");
      var uiTime = document.getElementById("ui-time");
      var uiStyle = document.getElementById("ui-style");

      function syncFooter() {
        if (uiDepth) uiDepth.textContent = state.depth;
        if (uiTime) uiTime.textContent = state.time;
        if (uiStyle) uiStyle.textContent = state.style;
      }

      syncFooter();

      // Content model (placeholder, deterministic; will be expanded later without structure changes)
      // Each vine has exactly 4 fruits; each fruit yields a resolution payload.
      var VINES = {
        "NW-1": { label: "NW Vine 1" },
        "NW-2": { label: "NW Vine 2" },
        "NW-3": { label: "NW Vine 3" },
        "NW-4": { label: "NW Vine 4" },

        "NE-1": { label: "NE Vine 1" },
        "NE-2": { label: "NE Vine 2" },
        "NE-3": { label: "NE Vine 3" },
        "NE-4": { label: "NE Vine 4" },

        "SW-1": { label: "SW Vine 1" },
        "SW-2": { label: "SW Vine 2" },
        "SW-3": { label: "SW Vine 3" },
        "SW-4": { label: "SW Vine 4" },

        "SE-1": { label: "SE Vine 1" },
        "SE-2": { label: "SE Vine 2" },
        "SE-3": { label: "SE Vine 3" },
        "SE-4": { label: "SE Vine 4" }
      };

      var FRUITS = [
        { id: "F1", label: "Fruit 1" },
        { id: "F2", label: "Fruit 2" },
        { id: "F3", label: "Fruit 3" },
        { id: "F4", label: "Fruit 4" }
      ];

      function densityText(vineId, fruitId) {
        // Explore vs Learn density spec:
        // Explore = short summary
        // Learn = full paragraph + bullets
        var base = vineId + " · " + fruitId + " · " + state.time + " · " + state.style;

        if (state.depth === "explore") {
          return {
            paragraph: "Summary: " + base + ".",
            bullets: [],
            implication: "Implication: move to Learn for full detail."
          };
        }

        // learn
        return {
          paragraph: "Full: " + base + ". This block expresses a stable resolution statement under the current lenses.",
          bullets: [
            "Bullet 1: deterministic point tied to the selected fruit.",
            "Bullet 2: bounded claim with no drift.",
            "Bullet 3: compatible with canonical state keys only."
          ],
          implication: "Implication: apply the resolution to the current traversal without changing structure."
        };
      }

      // Modal state
      var currentVineId = null;

      function openModal(vineId) {
        currentVineId = vineId;

        // Reset views
        if (fruitsView) fruitsView.hidden = false;
        if (resView) resView.hidden = true;

        // Update header
        var vineLabel = (VINES[vineId] && VINES[vineId].label) ? VINES[vineId].label : vineId;
        if (modalKicker) modalKicker.textContent = vineLabel;
        if (modalTitle) modalTitle.textContent = "Select a fruit";
        if (modalHint) modalHint.textContent = "Choose one.";

        // Update fruit labels (always exactly 4)
        var fruitBtns = modal ? modal.querySelectorAll(".crp-fruit") : null;
        if (fruitBtns && fruitBtns.length === 4) {
          for (var i = 0; i < 4; i++) {
            fruitBtns[i].textContent = FRUITS[i].label;
            fruitBtns[i].setAttribute("data-fruit", FRUITS[i].id);
          }
        }

        // Show modal
        if (modal) {
          modal.hidden = false;
          modal.setAttribute("aria-hidden", "false");
        }

        syncFooter();
      }

      function closeModal() {
        currentVineId = null;
        if (modal) {
          modal.hidden = true;
          modal.setAttribute("aria-hidden", "true");
        }
      }

      function showResolution(fruitId) {
        if (!currentVineId) return;

        var payload = densityText(currentVineId, fruitId);

        if (resP) resP.textContent = payload.paragraph;

        if (resBullets) {
          resBullets.innerHTML = "";
          for (var i = 0; i < payload.bullets.length; i++) {
            var li = document.createElement("li");
            li.textContent = payload.bullets[i];
            resBullets.appendChild(li);
          }
        }

        if (resImp) resImp.textContent = payload.implication;

        if (fruitsView) fruitsView.hidden = true;
        if (resView) resView.hidden = false;

        if (modalTitle) modalTitle.textContent = "Resolution";
        if (modalHint) modalHint.textContent = "";

        syncFooter();
      }

      function backToFruits() {
        if (fruitsView) fruitsView.hidden = false;
        if (resView) resView.hidden = true;

        if (modalTitle) modalTitle.textContent = "Select a fruit";
        if (modalHint) modalHint.textContent = "Choose one.";
      }

      // Wire vines (click opens modal; no scroll-jump because modal is overlay)
      var vineBtns = document.querySelectorAll(".crp-vine[data-vine]");
      for (var v = 0; v < vineBtns.length; v++) {
        vineBtns[v].addEventListener("click", function (e) {
          var id = e.currentTarget.getAttribute("data-vine");
          openModal(id);
        });
      }

      // Wire fruit clicks
      var fruitBtns2 = document.querySelectorAll(".crp-fruit[data-fruit]");
      for (var f = 0; f < fruitBtns2.length; f++) {
        fruitBtns2[f].addEventListener("click", function (e) {
          var fruitId = e.currentTarget.getAttribute("data-fruit");
          showResolution(fruitId);
        });
      }

      // Back button in Resolution
      if (resBack) resBack.addEventListener("click", backToFruits);

      // Close controls (backdrop + close button)
      var closeEls = document.querySelectorAll("[data-modal-close='1']");
      for (var c = 0; c < closeEls.length; c++) {
        closeEls[c].addEventListener("click", closeModal);
      }

      // Lens controls (Time / Style)
      function setActiveChip(groupSelector, attr, value) {
        var chips = document.querySelectorAll(groupSelector + " .crp-chip[" + attr + "]");
        for (var i = 0; i < chips.length; i++) {
          var v = chips[i].getAttribute(attr);
          if (v === value) chips[i].setAttribute("aria-pressed", "true");
          else chips[i].setAttribute("aria-pressed", "false");
        }
      }

      function initChips() {
        setActiveChip("[aria-label='Time lens']", "data-time", state.time);
        setActiveChip("[aria-label='Style lens']", "data-style", state.style);
      }

      initChips();

      // Time chip handlers
      var timeChips = document.querySelectorAll(".crp-chip[data-time]");
      for (var t = 0; t < timeChips.length; t++) {
        timeChips[t].addEventListener("click", function (e) {
          var val = e.currentTarget.getAttribute("data-time");
          if (!ALLOWED_TIME[val]) return;
          state.time = val;
          lsSet(KEY_TIME, val);
          setActiveChip("[aria-label='Time lens']", "data-time", val);
          syncFooter();
        });
      }

      // Style chip handlers
      var styleChips = document.querySelectorAll(".crp-chip[data-style]");
      for (var s = 0; s < styleChips.length; s++) {
        styleChips[s].addEventListener("click", function (e) {
          var val = e.currentTarget.getAttribute("data-style");
          if (!ALLOWED_STYLE[val]) return;
          state.style = val;
          lsSet(KEY_STYLE, val);
          setActiveChip("[aria-label='Style lens']", "data-style", val);
          syncFooter();
        });
      }

      // Escape to close modal
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && modal && !modal.hidden) closeModal();
      });
    })();
  </script>
</body>
</html>
