<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
  <script defer src="/assets/telemetry.js"></script>
</head>

<body class="bg-gradient">
<main class="page">

  <section class="panel hero">
    <h1>Control</h1>
    <p class="subtitle">Live read-only gauges. Truth first. No actions forced.</p>
  </section>

  <section class="panel bubble">
    <details open>
      <summary>Live status</summary>
      <div class="bubble-body">
        <div id="liveText" class="mono note">Loading…</div>
      </div>
    </details>
  </section>

  <section class="panel bubble">
    <details open>
      <summary>Activity (what’s happening)</summary>
      <div class="bubble-body">
        <div class="tight">
          <div class="row"><span>Sessions</span><strong id="m_sessions">—</strong></div>
          <div class="row"><span>Pageviews</span><strong id="m_pageviews">—</strong></div>
          <div class="row"><span>Clicks</span><strong id="m_clicks">—</strong></div>
          <div class="row"><span>Writes</span><strong id="m_writes">—</strong></div>
          <div class="row"><span>Errors</span><strong id="m_errors">—</strong></div>
        </div>
      </div>
    </details>
  </section>

  <section class="panel bubble">
    <details>
      <summary>Raw payload (JSON)</summary>
      <div class="bubble-body">
        <pre id="raw" class="mono note">—</pre>
      </div>
    </details>
  </section>

  <section class="panel nav">
    <div class="nav-grid">
      <a class="btn primary" href="/home/">Home</a>
      <a class="btn" href="/">Landing</a>
      <a class="btn" href="/engine/">Engine</a>
      <a class="btn" href="/state/">State</a>
      <a class="btn" href="/reference/">Reference</a>
    </div>
  </section>

</main>

<script>
(() => {
  const METRICS = "https://geodiametrics-aggregator.smansfield635.workers.dev/metrics";
  const POLL_MS = 10000;

  const el = (id) => document.getElementById(id);

  function setText(id, v) {
    const n = el(id);
    if (n) n.textContent = String(v);
  }

  function fmt(ts) {
    if (!ts) return "—";
    try { return new Date(ts).toLocaleString(); } catch { return String(ts); }
  }

  async function tick() {
    try {
      const r = await fetch(METRICS, { cache: "no-store" });
      const j = await r.json();

      setText("raw", JSON.stringify(j, null, 2));

      const m = j.metrics || {};
      setText("m_sessions", m.sessions ?? 0);
      setText("m_pageviews", m.pageviews ?? 0);
      setText("m_clicks", m.clicks ?? 0);
      setText("m_writes", m.writes ?? 0);
      setText("m_errors", m.errors ?? 0);

      const meta = j.meta || {};
      const age = meta.ageSec;
      const health = (j.status || "DEGRADED");

      setText(
        "liveText",
        `Truth source — ${METRICS}\nPolling — ${Math.round(POLL_MS/1000)}s\nLast updated — ${fmt(m.lastUpdated)}\nAge (sec) — ${age === null ? "—" : age}\nHEALTH — ${health}`
      );
    } catch (e) {
      setText("liveText", "Live status unavailable (fetch failed).");
    }
  }

  tick();
  setInterval(tick, POLL_MS);
})();
</script>
</body>
</html>
