<!-- TNT — /laws/index.html  (FIX: modal centered + content upgraded)
     Changes:
     1) Modal is truly screen-centered and NEVER “drops low” — it becomes a fixed-height shell with its own scroll.
     2) When you open a bubble, the modal switches to a centered DETAIL view (grid hides) so content starts at the top.
     3) Every bubble now has AT LEAST 4 bulletins (4+ bullets) + a readable paragraph.
     Dual-lens (EN + 中文) preserved. Hub-diamond standard preserved. -->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LAWS · Cardinal Axis</title>

<link rel="stylesheet" href="/assets/ui.css"/>
<link rel="stylesheet" href="/assets/branch.css"/>

<style>
:root{
  --R:124px;
  --gold:rgba(212,175,55,.9);
  --goldSoft:rgba(212,175,55,.35);
  --obs1:#070b12;
  --obs2:#0c1626;
  --mut:rgba(255,255,255,.82);
  --mut2:rgba(255,255,255,.68);
}

body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(circle at 50% 40%, rgba(90,140,255,.10), transparent 60%),
    repeating-linear-gradient(45deg, rgba(255,255,255,.02) 0 1px, transparent 1px 100px),
    linear-gradient(180deg,#b00000 0%,#7a0000 60%,#550000 100%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:#fff;
  overflow-x:hidden;
}

/* Top chrome */
.top-left,.top-right{
  position:fixed;
  top:16px;
  z-index:90;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.top-left{ left:16px; }
.top-right{ right:16px; flex-direction:column; align-items:flex-end; }

.pillbar{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  backdrop-filter:blur(8px);
  padding:10px 12px;
  display:flex;
  gap:10px;
  align-items:center;
}

.btn{
  padding:10px 16px;
  border-radius:14px;
  background:linear-gradient(145deg,var(--obs2),var(--obs1));
  color:white;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 14px 36px rgba(0,0,0,.7);
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  text-decoration:none;
}
.btn:hover{ box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 14px var(--goldSoft); }
.btn.active{ box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 22px rgba(212,175,55,.45); border-color:rgba(212,175,55,.25); }

/* Center label */
.page-title{
  position:fixed;
  left:50%;
  top:16px;
  transform:translateX(-50%);
  z-index:80;
  text-align:center;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.16);
  backdrop-filter:blur(8px);
}
.page-title .name{
  font-weight:950;
  letter-spacing:1.2px;
  font-size:12px;
  opacity:.95;
}
.page-title .tag{
  font-size:11px;
  letter-spacing:.6px;
  opacity:.70;
  margin-top:2px;
}

/* Stage */
.stage{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(560px,92vw);
  height:min(560px,92vw);
  z-index:40;
}

/* Gem diamonds (same as hub) */
.diamond{
  width:150px;height:150px;
  position:absolute;
  left:50%;top:50%;
  transform-origin:center;
  border-radius:22px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;

  background:
    radial-gradient(circle at 35% 25%, rgba(255,255,255,.15), transparent 55%),
    radial-gradient(circle at 70% 80%, rgba(0,80,255,.18), transparent 60%),
    linear-gradient(160deg, var(--obs2) 0%, var(--obs1) 60%);

  box-shadow:
    0 25px 70px rgba(0,0,0,.82),
    inset 0 2px 0 rgba(255,255,255,.18),
    inset 0 -25px 35px rgba(0,0,0,.65);

  border:1px solid rgba(255,255,255,.08);
  transition:all 260ms ease;
}
.diamond::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background:repeating-conic-gradient(from 0deg, rgba(255,255,255,.04) 0deg 5deg, transparent 5deg 15deg);
  mix-blend-mode:overlay;
  opacity:.25;
  pointer-events:none;
}
.diamond:hover{
  transform:translate(-50%,-50%) rotate(45deg) scale(1.02);
  box-shadow:
    0 30px 90px rgba(0,0,0,.9),
    0 0 22px var(--goldSoft),
    inset 0 2px 0 rgba(255,255,255,.22),
    inset 0 -28px 40px rgba(0,0,0,.7);
}
.diamond.active{
  box-shadow:
    0 30px 90px rgba(0,0,0,.9),
    0 0 30px rgba(212,175,55,.55),
    inset 0 2px 0 rgba(255,255,255,.22),
    inset 0 -28px 40px rgba(0,0,0,.7);
}

.inner{
  width:100%;
  height:100%;
  transform:rotate(-45deg);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:16px;
  gap:8px;
  pointer-events:none;
}
.dir{
  font-weight:950;
  letter-spacing:.6px;
  font-size:16px;
}
.preview{
  font-size:13px;
  opacity:.88;
  line-height:1.35;
  max-width:16em;
}

/* Placement */
#north{ transform:translate(-50%,-50%) translate(0, calc(var(--R) * -1)) rotate(45deg); }
#east { transform:translate(-50%,-50%) translate(var(--R),0) rotate(45deg); }
#south{ transform:translate(-50%,-50%) translate(0,var(--R)) rotate(45deg); }
#west { transform:translate(-50%,-50%) translate(calc(var(--R) * -1),0) rotate(45deg); }

/* Neutral nucleus */
.core{
  position:absolute;
  left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:64px;height:64px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  box-shadow:0 18px 44px rgba(0,0,0,.62), inset 0 2px 0 rgba(255,255,255,.10);
  display:grid;
  place-items:center;
  font-weight:950;
  letter-spacing:.5px;
  opacity:.90;
  pointer-events:none;
}

/* Bottom dock */
.dock{
  position:fixed;
  left:50%;
  bottom:max(12px, env(safe-area-inset-bottom));
  transform:translateX(-50%);
  z-index:90;
  width:min(900px,94vw);
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  backdrop-filter:blur(8px);
}

/* ===== Modal (FIXED CENTER + INTERNAL SCROLL) ===== */
.bd{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  backdrop-filter:blur(10px);
  display:none;
  z-index:200;
}
.bd.show{display:block;}

.modal{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(860px,92vw);
  max-height:84vh;              /* key: modal stays centered */
  display:none;
  z-index:210;
}
.modal.show{display:block;}

.modal-shell{
  height:84vh;                  /* key: fixed shell height */
  max-height:84vh;
  border-radius:26px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(circle at 35% 25%, rgba(90,140,255,.10), transparent 55%),
    linear-gradient(160deg,var(--obs2) 0%, var(--obs1) 65%);
  box-shadow:0 60px 180px rgba(0,0,0,.92);
  overflow:hidden;              /* key: prevent “dropping low” */
  display:flex;
  flex-direction:column;
}

.mhead{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  flex:0 0 auto;
}
.mtitle{
  margin:0;
  font-weight:950;
  letter-spacing:.3px;
  font-size:16px;
}
.mclose{
  border:0;
  background:transparent;
  color:#fff;
  font-size:18px;
  cursor:pointer;
  padding:8px 10px;
}

/* Scroll area */
.mbody{
  padding:14px 16px 16px;
  overflow:auto;                /* key: content scrolls INSIDE modal */
  -webkit-overflow-scrolling:touch;
  flex:1 1 auto;
}

/* Grid */
.grid{
  display:grid;
  gap:14px;
}
@media (min-width:760px){ .grid{ grid-template-columns:1fr 1fr; } }

.bubble{
  padding:16px 18px;
  border-radius:20px;
  cursor:pointer;
  background:
    radial-gradient(circle at 30% 30%, rgba(120,160,255,.10), transparent 55%),
    linear-gradient(145deg,var(--obs2),var(--obs1));
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 18px 55px rgba(0,0,0,.78), inset 0 2px 0 rgba(255,255,255,.08);
  position:relative;
}
.bubble::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:20px;
  padding:1px;
  background:linear-gradient(120deg, transparent 0%, var(--goldSoft) 50%, transparent 100%);
  opacity:.55;
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  pointer-events:none;
}
.bubble:hover{ box-shadow:0 22px 65px rgba(0,0,0,.86), 0 0 14px rgba(212,175,55,.16); border-color:rgba(212,175,55,.16); }
.bt{ font-weight:950; margin:0 0 6px; letter-spacing:.2px; }
.bs{ margin:0; color:var(--mut2); line-height:1.45; }

/* Detail view: replaces grid (no “push-down”) */
.detail{
  display:none;
}
.detail.show{display:block;}

.dbox{
  padding:18px;
  border-radius:22px;
  background:linear-gradient(145deg,var(--obs2),var(--obs1));
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 22px 70px rgba(0,0,0,.86), inset 0 2px 0 rgba(255,255,255,.08);
}
.dh{ margin:0 0 10px; font-weight:950; letter-spacing:.2px; font-size:16px; }
.dp{ margin:0 0 12px; color:var(--mut); line-height:1.55; }
.dlabel{
  margin:10px 0 8px;
  font-weight:950;
  letter-spacing:.2px;
  opacity:.92;
}
.dul{ margin:0 0 12px 18px; padding:0; color:var(--mut2); }
.dul li{ margin:6px 0; }

.dact{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:10px;
}
.sbtn{
  padding:12px 18px;
  border-radius:14px;
  background:linear-gradient(145deg,var(--obs2),var(--obs1));
  color:white;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 14px 36px rgba(0,0,0,.7);
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
}
.sbtn:hover{ box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 14px var(--goldSoft); }

@media (max-width:520px){
  :root{ --R: 116px; }
  .top-right{ right:10px; top:10px; }
  .top-left{ left:10px; top:10px; }
  .stage{ width:min(520px,92vw); height:min(520px,92vw); }
  .core{ width:58px; height:58px; }
  .pillbar{ gap:8px; padding:9px 10px; }
  .modal-shell{ height:86vh; max-height:86vh; } /* a touch more room on mobile */
}
</style>
</head>

<body>

<div class="top-left" id="topLeft">
  <a class="btn" href="/door/">EXIT</a>
  <a class="btn" href="/index.html">LANGUAGE</a>
  <button class="btn" id="mapBtn">MAP</button>
</div>

<div class="page-title" aria-label="Brand">
  <div class="name" id="brandName">CARDINAL AXIS</div>
  <div class="tag" id="brandTag">Traversal Architecture</div>
</div>

<div class="top-right" id="topRight">
  <div class="pillbar">
    <button class="btn" id="styleBtn">STYLE: FORMAL</button>
  </div>
  <div class="pillbar">
    <button class="btn timeBtn" data-time="origin" id="tOrigin">ORIGIN</button>
    <button class="btn timeBtn" data-time="now" id="tNow">NOW</button>
    <button class="btn timeBtn" data-time="post" id="tPost">POST</button>
  </div>
</div>

<div class="stage" id="centerStage">
  <div class="diamond" id="north"><div class="inner"><div class="dir" id="nLab">FOUNDATION</div><div class="preview" id="northText"></div></div></div>
  <div class="diamond" id="east"><div class="inner"><div class="dir" id="eLab">DEFINITIONS</div><div class="preview" id="eastText"></div></div></div>
  <div class="diamond" id="south"><div class="inner"><div class="dir" id="sLab">ENFORCEMENT</div><div class="preview" id="southText"></div></div></div>
  <div class="diamond" id="west"><div class="inner"><div class="dir" id="wLab">GOVERNANCE</div><div class="preview" id="westText"></div></div></div>
  <div class="core">◆</div>
</div>

<nav class="dock" id="bottomDock">
  <a class="btn" id="goHub" href="/home/">HUB</a>
  <a class="btn" id="goTerminal" href="/index.html">TERMINAL</a>
  <a class="btn" id="goLinks" href="/links/">LINKS</a>
  <a class="btn active" id="goLaws" href="/laws/">LAWS</a>
  <a class="btn" id="goProducts" href="/products/">PRODUCTS</a>
  <a class="btn" id="goGauges" href="/gauges/">GAUGES</a>
</nav>

<div class="bd" id="bd"></div>

<div class="modal" id="modal" role="dialog" aria-modal="true">
  <div class="modal-shell">
    <div class="mhead">
      <h3 class="mtitle" id="mTitle">LAWS MAP</h3>
      <button class="mclose" id="mClose" aria-label="Close">✕</button>
    </div>

    <div class="mbody" id="mbody">
      <div class="grid" id="grid"></div>

      <div class="detail" id="detail">
        <div class="dbox">
          <div class="dh" id="dTitle"></div>
          <div class="dp" id="dPara"></div>

          <div class="dlabel" id="dBulLabel">BULLETINS</div>
          <ul class="dul" id="dList"></ul>

          <div class="dact">
            <button class="sbtn" id="dBack">BACK</button>
            <button class="sbtn" id="dClose">BACK TO LAWS</button>
            <button class="sbtn" id="dPrev">PREV</button>
            <button class="sbtn" id="dNext">NEXT</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const qLang = qs.get("lang");
  let lang = (qLang==="zh"||qLang==="en") ? qLang : (localStorage.getItem("gd_lang")==="zh" ? "zh" : "en");
  try{ localStorage.setItem("gd_lang", lang); }catch(e){}

  let style = localStorage.getItem("gd_style") || "formal";
  let time  = localStorage.getItem("gd_time")  || "now";
  if(time==="trajectory") time="post";
  if(!["origin","now","post"].includes(time)) time="now";
  if(!["formal","informal"].includes(style)) style="formal";

  const UI = {
    en:{
      brand:"CARDINAL AXIS",
      tag:"Traversal Architecture",
      map:"LAWS MAP",
      dirs:{north:"FOUNDATION",east:"DEFINITIONS",south:"ENFORCEMENT",west:"GOVERNANCE"},
      routes:{hub:"HUB",terminal:"TERMINAL",links:"LINKS",products:"PRODUCTS",laws:"LAWS",gauges:"GAUGES"},
      s:{formal:"FORMAL",informal:"INFORMAL"},
      t:{origin:"ORIGIN",now:"NOW",post:"POST"},
      nav:{back:"BACK",backPage:"BACK TO LAWS",prev:"PREV",next:"NEXT"},
      bul:"BULLETINS",
      sections:[
        {
          t:"Canonical Keys",
          s:"gd_* only. No drift.",
          p:"Canonical state keys are the contract between pages. They must remain stable and exclusive.",
          li:[
            "gd_lang controls EN/中文 rendering everywhere.",
            "gd_style controls Formal/Informal framing everywhere.",
            "gd_time controls Origin/Now/Post lens everywhere.",
            "No other namespaces allowed (no crp_*; no duplicates)."
          ]
        },
        {
          t:"Traversal Rule",
          s:"Hub routes anywhere.",
          p:"The hub is a routing surface. Every major page is reachable from the hub without dead ends.",
          li:[
            "Hub is always available in the bottom dock.",
            "Modal map provides page-level routing at any time.",
            "Route links must propagate lang/style/time forward.",
            "No page should require backtracking through unrelated layers."
          ]
        },
        {
          t:"Admissibility",
          s:"Structure before content.",
          p:"Structure is the canonical layer. Content expands within structure and cannot change meanings by drift.",
          li:[
            "No silent renames of routes or labels.",
            "No duplicate meanings across pages.",
            "Placeholders are explicit, not implied.",
            "Every claim is bounded by lens + direction context."
          ]
        },
        {
          t:"Publication Safety",
          s:"Safe browsing by design.",
          p:"Public browsing must be stable, predictable, and reversible. Unfinished areas are still safe.",
          li:[
            "Unbuilt areas show placeholders, not broken flows.",
            "All modals have Return + Close behavior.",
            "No destructive actions exist on public pages.",
            "All pages preserve a clear escape route (Exit + Language)."
          ]
        },
        {
          t:"Change Discipline",
          s:"TNT only. One file per change.",
          p:"Edits are full-file replacements to prevent partial drift and hidden collisions across CSS/JS.",
          li:[
            "One file per message update.",
            "No partial snippets applied to production.",
            "No inline style drift across pages.",
            "Dual-lens (EN/中文) embedded every time."
          ]
        },
        {
          t:"Lens Integrity",
          s:"Style + Time must alter content.",
          p:"When a lens changes, what the user sees must change—text, bullets, and meaning—not just button highlights.",
          li:[
            "Formal/Informal switches language framing.",
            "Origin/Now/Post changes what is emphasized.",
            "No stale content after toggles.",
            "If a combination is disallowed, the UI resolves it deterministically."
          ]
        }
      ]
    },
    zh:{
      brand:"四向轴",
      tag:"遍历架构",
      map:"法则地图",
      dirs:{north:"基础",east:"定义",south:"执行",west:"治理"},
      routes:{hub:"枢纽",terminal:"终端",links:"链接",products:"产品",laws:"法则",gauges:"量规"},
      s:{formal:"正式",informal:"非正式"},
      t:{origin:"起源",now:"当前",post:"未来"},
      nav:{back:"返回",backPage:"回到法则",prev:"上一个",next:"下一个"},
      bul:"公告要点",
      sections:[
        {
          t:"规范键",
          s:"仅 gd_*，不漂移。",
          p:"规范状态键是页面之间的契约，必须稳定且唯一。",
          li:[
            "gd_lang 控制全站 EN/中文渲染。",
            "gd_style 控制正式/非正式呈现。",
            "gd_time 控制起源/当前/未来透镜。",
            "禁止其它命名空间（不允许 crp_* 等）。"
          ]
        },
        {
          t:"遍历规则",
          s:"枢纽可到达全站。",
          p:"枢纽是路由面。所有主要页面都必须可从枢纽直接到达。",
          li:[
            "底部导航始终提供枢纽入口。",
            "MAP 模态提供随时跳转。",
            "跳转必须携带 lang/style/time。",
            "不要求用户绕路或反复回退。"
          ]
        },
        {
          t:"可采纳性",
          s:"结构先于内容。",
          p:"结构为规范层，内容在结构内扩展，不能通过漂移改变含义。",
          li:[
            "禁止静默改名（路由/标签）。",
            "禁止重复含义分布在不同页面。",
            "占位必须明确，而非暗示。",
            "所有表述需受透镜与方向上下文约束。"
          ]
        },
        {
          t:"发布安全",
          s:"可安全浏览。",
          p:"对外浏览必须稳定、可预测、可回退。未完成区域依旧安全。",
          li:[
            "未构建区域显示占位，不出现断链流程。",
            "所有模态都有返回与关闭。",
            "公开页面不包含破坏性操作。",
            "始终提供退出路径（Exit + Language）。"
          ]
        },
        {
          t:"变更纪律",
          s:"只用 TNT，一次一文件。",
          p:"所有修改采用整文件替换，避免局部漂移与隐藏冲突。",
          li:[
            "一次只改一个文件。",
            "不把片段当作上线代码。",
            "不允许页面内联样式漂移。",
            "每次都内置双语透镜（EN/中文）。"
          ]
        },
        {
          t:"透镜完整性",
          s:"风格 + 时间必须改变内容。",
          p:"透镜变化必须改变文本与要点，而不是只改变按钮高亮。",
          li:[
            "正式/非正式切换表达方式。",
            "起源/当前/未来切换强调重点。",
            "禁止切换后内容不变。",
            "若某组合不允许，则需确定性处理。"
          ]
        }
      ]
    }
  };

  const T = UI[lang] || UI.en;

  // Apply labels
  document.getElementById("brandName").textContent = T.brand;
  document.getElementById("brandTag").textContent = T.tag;
  document.getElementById("mTitle").textContent = T.map;

  document.getElementById("nLab").textContent = T.dirs.north;
  document.getElementById("eLab").textContent = T.dirs.east;
  document.getElementById("sLab").textContent = T.dirs.south;
  document.getElementById("wLab").textContent = T.dirs.west;

  document.getElementById("goHub").textContent = T.routes.hub;
  document.getElementById("goTerminal").textContent = T.routes.terminal;
  document.getElementById("goLinks").textContent = T.routes.links;
  document.getElementById("goProducts").textContent = T.routes.products;
  document.getElementById("goLaws").textContent = T.routes.laws;
  document.getElementById("goGauges").textContent = T.routes.gauges;

  const styleBtn = document.getElementById("styleBtn");
  const tOrigin = document.getElementById("tOrigin");
  const tNow = document.getElementById("tNow");
  const tPost = document.getElementById("tPost");

  function setPressedTime(){
    [tOrigin,tNow,tPost].forEach(b=>{
      const v=b.getAttribute("data-time");
      b.classList.toggle("active", v===time);
    });
  }

  function rewriteLinks(){
    const q = "lang="+encodeURIComponent(lang)+"&style="+encodeURIComponent(style)+"&time="+encodeURIComponent(time);
    document.getElementById("goHub").setAttribute("href","/home/?"+q);
    document.getElementById("goTerminal").setAttribute("href","/index.html?"+q);
    document.getElementById("goLinks").setAttribute("href","/links/?"+q);
    document.getElementById("goProducts").setAttribute("href","/products/?"+q);
    document.getElementById("goLaws").setAttribute("href","/laws/?"+q);
    document.getElementById("goGauges").setAttribute("href","/gauges/?"+q);
  }

  function render(){
    try{
      localStorage.setItem("gd_style", style);
      localStorage.setItem("gd_time", time);
    }catch(e){}

    styleBtn.textContent = "STYLE: " + (style==="formal" ? T.s.formal : T.s.informal);
    tOrigin.textContent = T.t.origin;
    tNow.textContent = T.t.now;
    tPost.textContent = T.t.post;

    // previews (short but meaningful)
    document.getElementById("northText").textContent = (lang==="zh" ? "规范层与状态键。" : "Canonical layer + state keys.");
    document.getElementById("eastText").textContent  = (lang==="zh" ? "术语与定义收敛。" : "Terms + definitions converge.");
    document.getElementById("southText").textContent = (lang==="zh" ? "执行与约束机制。" : "Enforcement + constraints.");
    document.getElementById("westText").textContent  = (lang==="zh" ? "治理与发布安全。" : "Governance + publication safety.");

    setPressedTime();
    rewriteLinks();
  }

  styleBtn.addEventListener("click", ()=>{
    style = (style==="formal") ? "informal" : "formal";
    render();
  });

  document.querySelectorAll(".timeBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      time = b.getAttribute("data-time");
      render();
    });
  });

  // Leveling no overlap
  function level(){
    const tl = document.getElementById("topLeft");
    const tr = document.getElementById("topRight");
    const dock = document.getElementById("bottomDock");
    const stage = document.getElementById("centerStage");
    if(!dock || !stage) return;

    const safe=10;
    const topBand = Math.max(
      tl ? tl.getBoundingClientRect().bottom : 0,
      tr ? tr.getBoundingClientRect().bottom : 0
    ) + safe;

    const dockTop = dock.getBoundingClientRect().top - safe;
    const centerY = (topBand + dockTop) / 2;
    stage.style.top = centerY + "px";
  }
  window.addEventListener("resize", level, {passive:true});
  window.addEventListener("orientationchange", ()=>setTimeout(level,50), {passive:true});
  setTimeout(level,0);

  // Modal logic
  const bd = document.getElementById("bd");
  const modal = document.getElementById("modal");
  const grid = document.getElementById("grid");
  const detail = document.getElementById("detail");
  const mClose = document.getElementById("mClose");
  const mapBtn = document.getElementById("mapBtn");
  const mbody = document.getElementById("mbody");

  const dTitle = document.getElementById("dTitle");
  const dPara  = document.getElementById("dPara");
  const dList  = document.getElementById("dList");
  const dBack  = document.getElementById("dBack");
  const dClose = document.getElementById("dClose");
  const dPrev  = document.getElementById("dPrev");
  const dNext  = document.getElementById("dNext");
  const dBulLabel = document.getElementById("dBulLabel");

  dBack.textContent = T.nav.back;
  dClose.textContent = T.nav.backPage;
  dPrev.textContent = T.nav.prev;
  dNext.textContent = T.nav.next;
  dBulLabel.textContent = T.bul;

  let idx=0;

  function openMap(){
    grid.innerHTML="";
    detail.classList.remove("show");
    grid.style.display="grid";
    T.sections.forEach((it,i)=>{
      const el=document.createElement("div");
      el.className="bubble";
      el.innerHTML=`<div class="bt">${it.t}</div><p class="bs">${it.s}</p>`;
      el.addEventListener("click", ()=>openDetail(i));
      grid.appendChild(el);
    });
    bd.classList.add("show");
    modal.classList.add("show");
    // ensure always starts at top
    mbody.scrollTop = 0;
  }

  function closeMap(){
    bd.classList.remove("show");
    modal.classList.remove("show");
    detail.classList.remove("show");
  }

  function openDetail(i){
    idx=i;
    const it=T.sections[i];
    dTitle.textContent=it.t;
    dPara.textContent=it.p;

    dList.innerHTML="";
    // enforce: at least 4 bulletins (guaranteed in data)
    it.li.forEach(x=>{ const li=document.createElement("li"); li.textContent=x; dList.appendChild(li); });

    // critical: switch view instead of pushing content down
    grid.style.display="none";
    detail.classList.add("show");

    // snap to top of modal body for centered feel
    mbody.scrollTop = 0;
  }

  function backToGrid(){
    detail.classList.remove("show");
    grid.style.display="grid";
    mbody.scrollTop = 0;
  }

  function step(d){
    const n=T.sections.length;
    idx=(idx+d+n)%n;
    openDetail(idx);
  }

  mapBtn.addEventListener("click", openMap);
  bd.addEventListener("click", closeMap);
  mClose.addEventListener("click", closeMap);
  dClose.addEventListener("click", closeMap);
  dBack.addEventListener("click", backToGrid);
  dPrev.addEventListener("click", ()=>step(-1));
  dNext.addEventListener("click", ()=>step(1));

  // diamonds open map (no low dropdown)
  ["north","east","south","west"].forEach(id=>{
    document.getElementById(id).addEventListener("click", ()=>{
      ["north","east","south","west"].forEach(x=>document.getElementById(x).classList.toggle("active", x===id));
      openMap();
    });
  });

  render();
})();
</script>

</body>
</html>
