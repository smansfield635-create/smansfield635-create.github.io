<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Home ¬∑ Coherent Resolution Platform</title>

<style>
:root{
  --red1:#8d0b0b;        /* lacquer */
  --red2:#4a0000;        /* deep */
  --ink:#070a0f;         /* black */
  --gold:#d4af37;        /* gold */
  --goldA:rgba(212,175,55,.45);
  --silver:#cfd3da;
  --line:rgba(255,255,255,.12);
  --soft:rgba(255,255,255,.06);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.72);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 720px at 50% 0%, rgba(141,11,11,.62) 0%, rgba(74,0,0,.52) 45%, rgba(7,10,15,1) 100%);
  overflow-x:hidden;
}

/* hard reset vs any inherited site CSS */
a,button{font:inherit}
button{border:0;background:none;color:inherit}
h1,p{margin:0}
img{max-width:100%}

/* layout */
.page{
  width:min(980px,94vw);
  margin:0 auto;
  padding:28px 14px 84px; /* extra bottom so NOTHING overlaps */
}

.hero{position:relative;z-index:2}
.hero h1{
  font-size:44px;
  font-weight:900;
  letter-spacing:.14em;
  text-transform:uppercase;
}
.hero p{
  margin-top:10px;
  font-size:16px;
  opacity:.78;
  line-height:1.45;
}

/* top controls */
.topbar{
  margin-top:16px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.pill{
  border-radius:999px;
  padding:10px 14px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.14);
  font-weight:900;
  letter-spacing:.12em;
  text-transform:uppercase;
  font-size:12px;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.pill.btn{cursor:pointer}
.pill.btn:hover{background:rgba(255,255,255,.08)}
.pill.active{
  border-color:rgba(212,175,55,.48);
  box-shadow:0 0 18px rgba(212,175,55,.18) inset;
}
.pill.gold{
  border-color:rgba(212,175,55,.50);
  box-shadow:0 0 20px rgba(212,175,55,.16) inset;
}

/* section */
.section-title{
  margin-top:18px;
  font-size:12px;
  letter-spacing:.22em;
  text-transform:uppercase;
  opacity:.70;
}

/* quadrant cards (no details/dropdowns = no competing UI) */
.quad{
  margin-top:12px;
  border-radius:22px;
  background:linear-gradient(180deg, rgba(0,0,0,.34), rgba(0,0,0,.18));
  border:1px solid var(--line);
  box-shadow:0 26px 80px rgba(0,0,0,.60);
  backdrop-filter:blur(12px);
  overflow:hidden;
}
.qhead{
  padding:16px 16px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.qleft{display:flex;align-items:center;gap:12px;min-width:0}
.qbadge{
  width:62px;height:42px;border-radius:16px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.12);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
  letter-spacing:.10em;
  flex:0 0 auto;
}
.qbadge.gold{border-color:rgba(212,175,55,.55); box-shadow:0 0 14px rgba(212,175,55,.18) inset}
.qbadge.sun{border-color:rgba(212,175,55,.28); box-shadow:0 0 12px rgba(212,175,55,.14) inset}
.qbadge.lantern{border-color:rgba(207,211,218,.22); box-shadow:0 0 12px rgba(207,211,218,.12) inset}
.qbadge.set{border-color:rgba(207,211,218,.18); box-shadow:0 0 12px rgba(207,211,218,.10) inset}

.qtxt{min-width:0}
.qtxt b{
  display:block;
  font-size:18px;
  letter-spacing:.12em;
  text-transform:uppercase;
}
.qtxt span{
  display:block;
  margin-top:2px;
  opacity:.72;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.qhint{
  font-size:12px;
  opacity:.68;
  letter-spacing:.16em;
  text-transform:uppercase;
  padding:10px 16px 0;
}

.qbody{padding:12px 16px 16px}
.grid2{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:760px){.grid2{grid-template-columns:1fr 1fr}}

.bubble{
  border-radius:18px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.10);
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.bubble:hover{background:rgba(255,255,255,.07)}
.bubble .t{min-width:0}
.bubble .t b{
  display:block;
  font-size:13px;
  letter-spacing:.14em;
  text-transform:uppercase;
}
.bubble .t i{
  display:block;
  font-style:normal;
  opacity:.72;
  font-size:12px;
  margin-top:2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.bubble .go{
  width:40px;height:40px;border-radius:999px;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.10);
  display:flex;align-items:center;justify-content:center;
  opacity:.9;
  flex:0 0 auto;
}

/* footer */
.brand{
  margin-top:22px;
  opacity:.26;
  letter-spacing:.35em;
  text-transform:uppercase;
  font-size:12px;
  text-align:center;
}
.footer{
  margin-top:8px;
  opacity:.32;
  font-size:12px;
  letter-spacing:.2em;
  text-align:center;
}

/* ===== MODAL (opaque pop-over, zero scroll-jump) ===== */
.backdrop{
  position:fixed;
  inset:0;
  z-index:999;
  display:none;
  align-items:center;
  justify-content:center;
  padding:14px;
  background:rgba(0,0,0,.62);
  backdrop-filter:blur(12px);
}
.backdrop.open{display:flex}
.modal{
  width:min(900px,96vw);
  max-height:min(84vh,900px);
  overflow:auto;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(30,0,0,.86), rgba(0,0,0,.62));
  box-shadow:0 34px 140px rgba(0,0,0,.75);
  position:relative;
}
.modal::before{
  content:"";
  position:absolute; inset:0;
  border-radius:22px;
  pointer-events:none;
  box-shadow:0 0 0 1px rgba(212,175,55,.10) inset;
}
.mtop{
  padding:14px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}
.mmeta{
  opacity:.70;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-size:12px;
}
.mclose{
  width:44px;height:44px;border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  user-select:none;
}
.mclose:hover{background:rgba(255,255,255,.10)}
.mtitle{
  padding:0 14px;
  font-weight:900;
  letter-spacing:.08em;
  font-size:20px;
}
.mdesc{
  padding:10px 14px 0;
  color:rgba(255,255,255,.80);
  line-height:1.6;
}

/* global lens chips */
.mchips{
  padding:12px 14px 0;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.chip{
  border-radius:999px;
  padding:8px 12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  letter-spacing:.14em;
  text-transform:uppercase;
  font-size:11px;
  user-select:none;
}
.chip.on{
  border-color:rgba(212,175,55,.48);
  box-shadow:0 0 16px rgba(212,175,55,.16) inset;
}

/* modal: level-1 sub bubbles */
.mgrid{
  padding:12px 14px 0;
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:760px){.mgrid{grid-template-columns:1fr 1fr}}
.subbubble{
  border-radius:18px;
  background:rgba(0,0,0,.24);
  border:1px solid rgba(255,255,255,.10);
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
}
.subbubble:hover{background:rgba(0,0,0,.30)}
.subbubble .t{min-width:0}
.subbubble .t b{
  display:block;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
}
.subbubble .t i{
  display:block;
  margin-top:3px;
  opacity:.72;
  font-style:normal;
  font-size:12px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.subbubble .go{
  width:40px;height:40px;border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  display:flex;align-items:center;justify-content:center;
  flex:0 0 auto;
}

/* modal: subpanel (deep) */
.subpanel{
  margin:12px 14px 14px;
  border-radius:18px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.12);
  padding:14px 14px;
  display:none;
}
.subpanel.open{display:block}
.subpanel h3{
  margin:0;
  font-size:13px;
  letter-spacing:.16em;
  text-transform:uppercase;
}
.subpanel .blurb{
  margin-top:10px;
  opacity:.82;
  line-height:1.6;
}
.subpanel ul{
  margin:10px 0 0 18px;
  padding:0;
  opacity:.78;
  line-height:1.6;
}
.subpanel .mini{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.minichip{
  border-radius:999px;
  padding:8px 12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  opacity:.9;
}

/* modal footer: single jump only */
.mfoot{
  padding:12px 14px 16px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.jump{
  border-radius:18px;
  padding:12px 14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  text-decoration:none;
  color:var(--text);
  font-weight:900;
  letter-spacing:.12em;
  text-transform:uppercase;
  font-size:12px;
}
.jump:hover{background:rgba(255,255,255,.08)}
.jump.gold{
  border-color:rgba(212,175,55,.50);
  box-shadow:0 0 16px rgba(212,175,55,.16) inset;
}
</style>
</head>

<body>
<div class="page">

  <div class="hero">
    <h1>HOME</h1>
    <p>Tap any bubble. Details pop over (no scroll jump). Origin / Now / Trajectory filters everything.</p>

    <div class="topbar">
      <span class="pill" id="langPill">LANG: EN</span>
      <span class="pill gold" id="depthPill">DEPTH: EXPLORE</span>

      <span class="pill btn" id="lensOrigin">ORIGIN</span>
      <span class="pill btn active" id="lensNow">NOW</span>
      <span class="pill btn" id="lensTrajectory">TRAJECTORY</span>

      <a class="pill btn" href="/door/">CHANGE DEPTH</a>
      <a class="pill btn" href="/">CHANGE LANGUAGE</a>
      <a class="pill btn gold" href="/door/">JUMP HOME</a>
    </div>

    <div class="section-title">Quadrant routes (NW / NE / SW / SE)</div>
  </div>

  <!-- NW -->
  <div class="quad">
    <div class="qhead">
      <div class="qleft">
        <div class="qbadge gold">‚≠ê NW</div>
        <div class="qtxt">
          <b>Northwest</b>
          <span>Definition ¬∑ language ¬∑ structure</span>
        </div>
      </div>
    </div>
    <div class="qhint">Tap a bubble ‚Üí pop-over details ‚Üí nested bubbles ‚Üí deep panel</div>
    <div class="qbody">
      <div class="grid2">
        <div class="bubble" data-block="ssg">
          <div class="t"><b>SSG</b><i>Resources ¬∑ Stores ¬∑ Constraints ¬∑ Goals ¬∑ Guards</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="grammar">
          <div class="t"><b>Diamond Grammar</b><i>Hub-first traversal ¬∑ receipt gating</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="dotgrid">
          <div class="t"><b>DOT.GRID</b><i>256-state indexing ¬∑ replay + audit</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="acronyms">
          <div class="t"><b>Acronyms</b><i>Pillars ¬∑ usage map ¬∑ examples</i></div>
          <div class="go">‚ñ∂</div>
        </div>
      </div>
    </div>
  </div>

  <!-- NE -->
  <div class="quad">
    <div class="qhead">
      <div class="qleft">
        <div class="qbadge sun">üåû NE</div>
        <div class="qtxt">
          <b>Northeast</b>
          <span>Execution ¬∑ surfaces ¬∑ examples</span>
        </div>
      </div>
    </div>
    <div class="qhint">Surfaces: apps, portals, workflows, outputs</div>
    <div class="qbody">
      <div class="grid2">
        <div class="bubble" data-block="surfaces">
          <div class="t"><b>Execution Surfaces</b><i>Apps ¬∑ portals ¬∑ interfaces</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="receipts">
          <div class="t"><b>Workflows & Receipts</b><i>Audit trails ¬∑ replay safety</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="examples">
          <div class="t"><b>Examples</b><i>How to use the system</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="packs">
          <div class="t"><b>Packs & Outputs</b><i>Downloadables ¬∑ packaged artifacts</i></div>
          <div class="go">‚ñ∂</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SW -->
  <div class="quad">
    <div class="qhead">
      <div class="qleft">
        <div class="qbadge lantern">üèÆ SW</div>
        <div class="qtxt">
          <b>Southwest</b>
          <span>Measurement ¬∑ diagnostics ¬∑ rules</span>
        </div>
      </div>
    </div>
    <div class="qhint">Gauges + diagnostics + rules + protocols</div>
    <div class="qbody">
      <div class="grid2">
        <div class="bubble" data-block="gauges">
          <div class="t"><b>Gauges</b><i>Instrument panels ¬∑ thresholds</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="diagnostics">
          <div class="t"><b>Diagnostics</b><i>Classification under constraint</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="rules">
          <div class="t"><b>Rules</b><i>Navigation + integrity</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="protocols">
          <div class="t"><b>Protocols</b><i>Return / replay / audit</i></div>
          <div class="go">‚ñ∂</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SE -->
  <div class="quad">
    <div class="qhead">
      <div class="qleft">
        <div class="qbadge set">üåá SE</div>
        <div class="qtxt">
          <b>Southeast</b>
          <span>Identity ¬∑ references ¬∑ links</span>
        </div>
      </div>
    </div>
    <div class="qhint">Anchors: ORCID, OSF, references, contact</div>
    <div class="qbody">
      <div class="grid2">
        <div class="bubble" data-block="orcid">
          <div class="t"><b>ORCID</b><i>Research identity anchor</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="osf">
          <div class="t"><b>OSF</b><i>Project registry / preprints</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="refs">
          <div class="t"><b>References</b><i>Core citations / anchors</i></div>
          <div class="go">‚ñ∂</div>
        </div>
        <div class="bubble" data-block="contact">
          <div class="t"><b>Contact</b><i>Direct channel</i></div>
          <div class="go">‚ñ∂</div>
        </div>
      </div>
    </div>
  </div>

  <div class="brand">GEODIAMETRICS</div>
  <div class="footer">CANONICAL ¬∑ STABLE ¬∑ ¬© GEODIAMETRICS</div>
</div>

<!-- MODAL -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mtitle">
    <div class="mtop">
      <div class="mmeta" id="mmeta">DETAIL</div>
      <div class="mclose" id="mclose" aria-label="Close">‚úï</div>
    </div>

    <div class="mtitle" id="mtitle">‚Äî</div>
    <div class="mdesc" id="mdesc">‚Äî</div>

    <div class="mchips">
      <span class="chip" data-chip="origin">Origin</span>
      <span class="chip on" data-chip="now">Now</span>
      <span class="chip" data-chip="trajectory">Trajectory</span>
    </div>

    <div class="mgrid" id="mgrid"></div>

    <div class="subpanel" id="subpanel">
      <h3 id="subTitle">‚Äî</h3>
      <div class="blurb" id="subBlurb">‚Äî</div>
      <ul id="subBullets"></ul>
      <div class="mini" id="subMini"></div>
    </div>

    <div class="mfoot">
      <a class="jump gold" href="/door/">JUMP HOME</a>
    </div>
  </div>
</div>

<script>
(function(){
  const lang = (localStorage.getItem('crp_lang') || 'en').toLowerCase();
  const depth = (localStorage.getItem('crp_depth') || 'explore').toLowerCase(); // explore | learn
  let lens = (localStorage.getItem('crp_lens') || 'now').toLowerCase(); // origin | now | trajectory

  const langPill = document.getElementById('langPill');
  const depthPill = document.getElementById('depthPill');

  langPill.textContent = 'LANG: ' + (lang === 'zh' ? '‰∏≠Êñá' : 'EN');
  depthPill.textContent = 'DEPTH: ' + (depth === 'learn' ? 'LEARN' : 'EXPLORE');

  const lensBtn = {
    origin: document.getElementById('lensOrigin'),
    now: document.getElementById('lensNow'),
    trajectory: document.getElementById('lensTrajectory')
  };

  function setLens(next){
    lens = next;
    localStorage.setItem('crp_lens', lens);
    Object.keys(lensBtn).forEach(k => lensBtn[k].classList.toggle('active', k === lens));
    updateChips();
    if(state.openKey) renderModal(state.openKey);
  }
  lensBtn.origin.addEventListener('click',()=>setLens('origin'));
  lensBtn.now.addEventListener('click',()=>setLens('now'));
  lensBtn.trajectory.addEventListener('click',()=>setLens('trajectory'));

  /* ====== DEEPER CONTENT (Explore vs Learn) ====== */
  const blocks = {
    ssg:{
      meta:'NW ¬∑ SSG',
      title:'SSG ‚Äî Simplified Syntax Geometry',
      origin_ex:'Compressed app behavior into a constraint-native vocabulary (minimum executable structure).',
      now_ex:'Use R/S/C/G/Guards to keep execution replay-safe and receipt-gated.',
      traj_ex:'Scale into portable execution contracts across domains.',
      origin_ln:'Origin: SSG formed to eliminate ambiguity in execution by expressing structure as constraints first‚Äîbefore code, before UI.',
      now_ln:'Now: SSG is the compact execution spec: Resources/Stores/Constraints/Goals/Guards, with receipts that verify progression and prevent drift.',
      traj_ln:'Trajectory: SSG becomes a portable contract layer‚Äîreplayable, auditable, and interoperable across products, orgs, and institutions.',
      subs:[
        {k:'primitives', t:'Primitives', s:'R / S / C / G / Guards',
          blurb:'This is the minimum set that makes ‚Äúexecution‚Äù formally expressible.',
          bullets:[
            'Resource: what is acted on (entity / target).',
            'Store: where state lives (memory / ledger).',
            'Constraint: invariants (must-hold).',
            'Goal: success condition (finish state).',
            'Guard: admissibility check (allowed / blocked).'
          ],
          mini:['MINIMUM SET','EXECUTABLE','OBSERVER-SAFE']
        },
        {k:'receipts', t:'Receipts', s:'Gated flow',
          blurb:'Receipts make progress verifiable and replay-safe.',
          bullets:[
            'Advance only after receipt (no invisible progress).',
            'Back-nav invalidates downstream receipts.',
            'Every step can be replayed and audited.'
          ],
          mini:['VERIFY','REPLAY','AUDIT']
        },
        {k:'invariants', t:'Invariants', s:'Navigation-first',
          blurb:'These keep the UI and engine from drifting as complexity grows.',
          bullets:[
            'No timers as gates (time never decides).',
            'Unified press primitives (consistent interaction).',
            'Atomic handoff with receipt (no partial states).'
          ],
          mini:['NO TIMERS','ATOMIC','CONSISTENT']
        },
        {k:'mapping', t:'Mapping', s:'How to read',
          blurb:'Explore vs Learn changes depth only (structure stays the same).',
          bullets:[
            'Explore: surface summary + where it lives in the system.',
            'Learn: nested bubbles + full breakdown in blocks.',
            'Lens (Origin/Now/Trajectory) filters meaning across the whole page.'
          ],
          mini:['EXPLORE','LEARN','LENS']
        }
      ]
    },

    grammar:{
      meta:'NW ¬∑ Grammar',
      title:'Diamond Grammar',
      origin_ex:'One choice at a time‚Äîso meaning can‚Äôt drift.',
      now_ex:'Hub-first traversal + receipt gating.',
      traj_ex:'Multi-portal routing without confusion.',
      origin_ln:'Origin: the grammar was designed to compress decision pathways into stable routes‚Äîso readers cannot ‚Äúhalf choose‚Äù and drift.',
      now_ln:'Now: it‚Äôs the navigation skeleton: hub-first traversal, one choice at a time, receipts verifying progression.',
      traj_ln:'Trajectory: scales to multi-portal access without adding friction, because structure stays invariant as depth expands.',
      subs:[
        {k:'one', t:'One choice', s:'Anti-drift',
          blurb:'A coherent system forbids simultaneous competing commitments.',
          bullets:[
            'Choose one route at a time.',
            'Finish or return‚Äîdon‚Äôt multi-tab inside a branch.',
            'Structure stays stable even as content evolves.'
          ],
          mini:['CHOICE','FINISH','RETURN']
        },
        {k:'hub', t:'Hub-first', s:'Return protocol',
          blurb:'When uncertain, return to the hub to re-orient.',
          bullets:[
            'Hub is the stable surface.',
            'Branches are exploration.',
            'Return prevents ‚Äúgetting lost‚Äù under depth.'
          ],
          mini:['HUB','ORIENT','STABLE']
        },
        {k:'gate', t:'Receipt gating', s:'Proof layer',
          blurb:'Receipts prevent false progress and enforce coherence.',
          bullets:[
            'Receipts are proof of completion.',
            'Backtracking invalidates downstream.',
            'Replay confirms consistency.'
          ],
          mini:['PROOF','INVALIDATE','REPLAY']
        },
        {k:'why', t:'Why it works', s:'Coherence',
          blurb:'Because external trust cannot exceed internal coherence.',
          bullets:[
            'Misalignment shows up immediately.',
            'Structure forces clarity.',
            'Clarity increases execution reliability.'
          ],
          mini:['ALIGN','CLARITY','RELIABLE']
        }
      ]
    },

    dotgrid:{
      meta:'NW ¬∑ DOT.GRID',
      title:'DOT.GRID',
      origin_ex:'Index decisions under constraint.',
      now_ex:'256-state lattice for replay + audit.',
      traj_ex:'Universal coordinate layer for stability.',
      origin_ln:'Origin: DOT.GRID created to classify evidence streams consistently under constraint‚Äîso different observers converge on the same output.',
      now_ln:'Now: a 256-state indexing lattice that supports replay, audit, and observer-consistent classification.',
      traj_ln:'Trajectory: becomes a universal coordinate layer for cross-domain stability measurement and calibration.',
      subs:[
        {k:'what', t:'What it is', s:'256 states',
          blurb:'A compact coordinate system for system-state classification.',
          bullets:[
            '256 states (discrete lattice).',
            'Supports consistent labeling.',
            'Pairs with replay and audit.'
          ],
          mini:['256','LATTICE','LABEL']
        },
        {k:'replay', t:'Replay', s:'Reproduce',
          blurb:'Same evidence ‚Üí same classification.',
          bullets:[
            'Replay evidence streams.',
            'Verify identical outputs.',
            'Detect drift when outputs diverge.'
          ],
          mini:['REPLAY','VERIFY','DRIFT']
        },
        {k:'audit', t:'Audit', s:'Accountable',
          blurb:'Auditability is structural, not ‚Äútrust me.‚Äù',
          bullets:[
            'Trace evidence to output.',
            'Expose threshold rules.',
            'Keep history of changes.'
          ],
          mini:['TRACE','THRESHOLD','HISTORY']
        },
        {k:'use', t:'Use cases', s:'When to use',
          blurb:'When you need consistent scoring and stability tracking.',
          bullets:[
            'Governance and compliance.',
            'Diagnostics under load.',
            'Network-scale calibration.'
          ],
          mini:['GOV','DIAG','SCALE']
        }
      ]
    },

    acronyms:{
      meta:'NW ¬∑ Glossary',
      title:'Acronyms & Glossary',
      origin_ex:'Prevent meaning collapse as the system scales.',
      now_ex:'Pillars + usage map.',
      traj_ex:'Shared vocabulary layer for teams.',
      origin_ln:'Origin: acronyms become dangerous without stable definitions‚Äîthis section locks meaning to prevent drift.',
      now_ln:'Now: acronyms are grouped by pillar (language, execution, measurement, identity) and tied to usage examples.',
      traj_ln:'Trajectory: becomes a shared vocabulary layer for teams, certifications, and institutional adoption.',
      subs:[
        {k:'pillar', t:'Pillars', s:'Group',
          blurb:'Acronyms are organized so you can find them fast.',
          bullets:[
            'Language pillar (SSG, Grammar, DOT).',
            'Execution pillar (surfaces, receipts, outputs).',
            'Measurement pillar (gauges, diagnostics, rules).',
            'Identity pillar (ORCID, OSF, references).'
          ],
          mini:['LANG','EXEC','MEASURE','ID']
        },
        {k:'usage', t:'Usage notes', s:'How to apply',
          blurb:'Each acronym includes ‚Äúwhat it is‚Äù and ‚Äúwhere it lives.‚Äù',
          bullets:[
            'One-line definition.',
            'Where in geometry it belongs.',
            'A simple example or typical use.'
          ],
          mini:['DEFINE','PLACE','EXAMPLE']
        },
        {k:'expand', t:'Expand lists', s:'Depth',
          blurb:'Learn mode expands deeper lists per pillar.',
          bullets:[
            'Explore: summaries only.',
            'Learn: nested lists + examples per acronym.'
          ],
          mini:['EXPLORE','LEARN']
        },
        {k:'lock', t:'Lock meaning', s:'Anti-drift',
          blurb:'Names are treated as stable interface contracts.',
          bullets:[
            'Avoid renaming without receipts.',
            'Keep canonical mapping.',
            'Document changes explicitly.'
          ],
          mini:['CANON','MAP','CHANGELOG']
        }
      ]
    },

    /* NE */
    surfaces:{
      meta:'NE ¬∑ Surfaces',
      title:'Execution Surfaces',
      origin_ex:'Expose the engine without exposing complexity.',
      now_ex:'Apps / portals / interfaces.',
      traj_ex:'Standard surfaces across products.',
      origin_ln:'Origin: surfaces exist to make the engine usable without forcing users to learn the internals first.',
      now_ln:'Now: apps, portals, and interfaces that route into receipt-gated workflows.',
      traj_ln:'Trajectory: standard surfaces that teams can share without losing coherence.',
      subs:[
        {k:'apps', t:'Apps & portals', s:'Entry points',
          blurb:'Surfaces are the ‚Äúhandles‚Äù on the engine.',
          bullets:[
            'Fast entry points.',
            'Stable navigation.',
            'Receipts behind the scenes.'
          ],
          mini:['HANDLE','STABLE','RECEIPT']
        },
        {k:'ux', t:'UX rule', s:'No jump-scroll',
          blurb:'Tap must produce local feedback immediately.',
          bullets:[
            'Modal pop-over (opaque).',
            'No hidden response far down the page.',
            'Same gesture = same behavior everywhere.'
          ],
          mini:['LOCAL','IMMEDIATE','CONSISTENT']
        },
        {k:'handoff', t:'Handoffs', s:'Atomic',
          blurb:'Handoffs move you between states without partial transitions.',
          bullets:[
            'Atomic step transitions.',
            'Receipt emitted.',
            'Back invalidates downstream.'
          ],
          mini:['ATOMIC','RECEIPT','INVALIDATE']
        },
        {k:'layers', t:'Explore vs Learn', s:'Depth only',
          blurb:'Explore/Learn changes depth, not structure.',
          bullets:[
            'Explore: surface map.',
            'Learn: nested bubbles + blocks.',
            'Same geometry either way.'
          ],
          mini:['DEPTH','SAME STRUCTURE']
        }
      ]
    },

    receipts:{
      meta:'NE ¬∑ Receipts',
      title:'Workflows & Receipts',
      origin_ex:'Make execution verifiable.',
      now_ex:'Audit trails + replay safety.',
      traj_ex:'Portable receipts across systems.',
      origin_ln:'Origin: receipts were introduced to eliminate ‚Äútrust me‚Äù execution and make progress provable.',
      now_ln:'Now: workflows emit receipts; audits replay them to verify consistency.',
      traj_ln:'Trajectory: receipts become portable across products, enabling cross-system resolution.',
      subs:[
        {k:'token', t:'Receipt tokens', s:'Proof',
          blurb:'A receipt is a verifiable record that a step occurred.',
          bullets:[
            'Proof of completion.',
            'Evidence link.',
            'Replay reference.'
          ],
          mini:['PROOF','EVIDENCE','REPLAY']
        },
        {k:'audit', t:'Audit trails', s:'Trace',
          blurb:'Audits follow receipts backward and forward.',
          bullets:[
            'Trace decisions.',
            'Verify constraints.',
            'Detect drift.'
          ],
          mini:['TRACE','VERIFY','DRIFT']
        },
        {k:'back', t:'Back-nav', s:'Invalidate',
          blurb:'Backtracking invalidates downstream receipts.',
          bullets:[
            'Prevents false continuity.',
            'Forces re-commitment.',
            'Keeps path coherent.'
          ],
          mini:['INVALIDATE','RECOMMIT','COHERENT']
        },
        {k:'why', t:'Why', s:'Integrity',
          blurb:'Receipts enforce coherence structurally.',
          bullets:[
            'External trust cannot exceed internal coherence.',
            'Verification beats narrative.',
            'Replay beats impression.'
          ],
          mini:['TRUST','VERIFY','REPLAY']
        }
      ]
    },

    examples:{
      meta:'NE ¬∑ Examples',
      title:'Examples',
      origin_ex:'Anchor abstract structure into action.',
      now_ex:'Templates and routes.',
      traj_ex:'Institution-ready playbooks.',
      origin_ln:'Origin: examples were built to make the system learnable without persuasion.',
      now_ln:'Now: examples mirror routes and end in receipts.',
      traj_ln:'Trajectory: examples become certified playbooks for adoption.',
      subs:[
        {k:'quick', t:'Explore examples', s:'Short',
          blurb:'Explore mode examples are short and concrete.',
          bullets:['One route. One outcome. One takeaway.'],
          mini:['SHORT','CONCRETE']
        },
        {k:'deep', t:'Learn examples', s:'Nested',
          blurb:'Learn mode expands into nested bubbles and blocks.',
          bullets:['Step-by-step', 'Receipts included', 'Replay-ready'],
          mini:['NESTED','RECEIPTS','REPLAY']
        },
        {k:'routes', t:'Routes', s:'NW/NE/SW/SE',
          blurb:'Each example maps to a quadrant route.',
          bullets:['NW defines', 'NE executes', 'SW measures', 'SE anchors'],
          mini:['MAP','ROUTES']
        },
        {k:'end', t:'Ends with receipt', s:'Always',
          blurb:'Every example ends in verification.',
          bullets:['Receipt emitted', 'Audit possible', 'Drift detectable'],
          mini:['VERIFY','AUDIT']
        }
      ]
    },

    packs:{
      meta:'NE ¬∑ Outputs',
      title:'Packs & Outputs',
      origin_ex:'Ship utility fast.',
      now_ex:'Downloadables + packaged artifacts.',
      traj_ex:'Reusable certified kits.',
      origin_ln:'Origin: outputs were packaged so people can use the system immediately.',
      now_ln:'Now: packs include materials, templates, and tools.',
      traj_ln:'Trajectory: outputs become certification kits and deployment bundles.',
      subs:[
        {k:'pdf', t:'PDFs', s:'Materials',
          blurb:'Printable guides and structured references.',
          bullets:['Guides', 'Checklists', 'Drills'],
          mini:['GUIDE','CHECKLIST','DRILL']
        },
        {k:'kits', t:'Kits', s:'Reusable',
          blurb:'Composable packs mapped to routes and receipts.',
          bullets:['Reusable templates', 'Route-mapped', 'Receipt-ready'],
          mini:['REUSE','ROUTE','RECEIPT']
        },
        {k:'release', t:'Releases', s:'What ships',
          blurb:'Explore shows what exists; Learn shows how it works.',
          bullets:['Explore = catalog', 'Learn = anatomy'],
          mini:['CATALOG','ANATOMY']
        },
        {k:'road', t:'Roadmap', s:'Trajectory',
          blurb:'Trajectory lens shows what expands next.',
          bullets:['Next surfaces', 'Next instruments', 'Next packs'],
          mini:['NEXT','EXPAND']
        }
      ]
    },

    /* SW */
    gauges:{
      meta:'SW ¬∑ Gauges',
      title:'Gauges',
      origin_ex:'Measure coherence under load.',
      now_ex:'Panels + thresholds.',
      traj_ex:'Real-time monitoring.',
      origin_ln:'Origin: gauges were created to make ‚Äúcoherence‚Äù measurable and operational.',
      now_ln:'Now: dashboards, consistency checks, and threshold rules.',
      traj_ln:'Trajectory: continuous stability monitoring across systems.',
      subs:[
        {k:'panel', t:'Panels', s:'Dashboards',
          blurb:'Panels show coherence and drift at a glance.',
          bullets:['Signal integrity', 'Consistency checks', 'Thresholds'],
          mini:['SIGNAL','CONSISTENT','THRESHOLD']
        },
        {k:'thresh', t:'Thresholds', s:'Rules',
          blurb:'Thresholds define pass/fail under constraint.',
          bullets:['Observer-consistent', 'Defined rules', 'Repeatable'],
          mini:['PASS/FAIL','RULED','REPEAT']
        },
        {k:'trend', t:'Trends', s:'Trajectory',
          blurb:'Trajectory lens focuses on where it‚Äôs going.',
          bullets:['Direction compounds', 'Small drift grows', 'Return protocols matter'],
          mini:['DIRECTION','DRIFT','RETURN']
        },
        {k:'use', t:'Use', s:'When',
          blurb:'Use gauges when performance must be verified under stress.',
          bullets:['Ops', 'Compliance', 'Safety'],
          mini:['OPS','COMPLIANCE','SAFETY']
        }
      ]
    },

    diagnostics:{
      meta:'SW ¬∑ Diagnostics',
      title:'Diagnostics',
      origin_ex:'Classify under constraint.',
      now_ex:'Coherence / drift / confusion.',
      traj_ex:'Universal early-warning.',
      origin_ln:'Origin: diagnostics were built to classify systems the same way from the same evidence.',
      now_ln:'Now: coherence/drift/confusion categories with replay-driven audits.',
      traj_ln:'Trajectory: early-warning systems across domains.',
      subs:[
        {k:'class', t:'Classification', s:'Observer-consistent',
          blurb:'Independent observers converge from the same evidence.',
          bullets:['Same evidence', 'Same class', 'Repeatable output'],
          mini:['OBSERVER','CONSISTENT']
        },
        {k:'drift', t:'Drift', s:'Direction',
          blurb:'Drift reveals structural truth.',
          bullets:['Stabilizing vs destabilizing', 'Compounding effects', 'Detect early'],
          mini:['DIRECTION','COMPOUND','EARLY']
        },
        {k:'conf', t:'Confusion', s:'Amplifier',
          blurb:'Confusion amplifies instability once present.',
          bullets:['Speeds collapse', 'Obscures signals', 'Increases variance'],
          mini:['AMPLIFY','OBSCURE','VARIANCE']
        },
        {k:'audit', t:'Audit', s:'Replay',
          blurb:'Replay evidence streams to verify classifications.',
          bullets:['Replay', 'Verify', 'Compare'],
          mini:['REPLAY','VERIFY','COMPARE']
        }
      ]
    },

    rules:{
      meta:'SW ¬∑ Rules',
      title:'Rules',
      origin_ex:'Keep traversal stable.',
      now_ex:'Navigation + integrity.',
      traj_ex:'Governance standard.',
      origin_ln:'Origin: rules were defined to prevent drift and preserve canonicity.',
      now_ln:'Now: navigation and integrity rules that constrain execution.',
      traj_ln:'Trajectory: governance standards for adoption.',
      subs:[
        {k:'nav', t:'Navigation', s:'Hub-first',
          blurb:'Return to hub when uncertain; one route at a time.',
          bullets:['Hub-first', 'One choice', 'Finish/return'],
          mini:['HUB','ONE CHOICE','RETURN']
        },
        {k:'guard', t:'Guards', s:'Admissibility',
          blurb:'Guards block inadmissible actions.',
          bullets:['Constraint checks', 'Receipt gating', 'Safety first'],
          mini:['CHECK','GATE','SAFE']
        },
        {k:'cons', t:'Consistency', s:'Integrity',
          blurb:'Values, actions, outcomes align.',
          bullets:['No fragmentation', 'Coherent execution', 'Stable outcomes'],
          mini:['ALIGN','COHERENT','STABLE']
        },
        {k:'scale', t:'Scale', s:'Correlation',
          blurb:'Scale-and-correlation governs projections.',
          bullets:['System-wide trajectory', 'Not attention-only', 'Correlation across network'],
          mini:['SCALE','CORRELATE']
        }
      ]
    },

    protocols:{
      meta:'SW ¬∑ Protocols',
      title:'Protocols',
      origin_ex:'Repeatable actions.',
      now_ex:'Return / replay / verification.',
      traj_ex:'Certified SOPs.',
      origin_ln:'Origin: protocols convert principles into repeatable execution.',
      now_ln:'Now: atomic handoffs, exits, returns, and receipts.',
      traj_ln:'Trajectory: certified operating procedures across orgs.',
      subs:[
        {k:'handoff', t:'Atomic handoff', s:'Receipt',
          blurb:'Atomic handoff with receipt; no partial transitions.',
          bullets:['Atomic', 'Verified', 'Replay-safe'],
          mini:['ATOMIC','VERIFY','REPLAY']
        },
        {k:'exit', t:'Exit', s:'Return token',
          blurb:'Exit emits terminal + return token.',
          bullets:['Terminal state', 'Return token', 'Re-entry safe'],
          mini:['EXIT','TOKEN','REENTER']
        },
        {k:'loop', t:'Continuation loop', s:'Memory token',
          blurb:'Continuation loops back after receipt with memory token.',
          bullets:['Receipt gate', 'Loop', 'Memory'],
          mini:['GATE','LOOP','MEMORY']
        },
        {k:'kill', t:'Kill conditions', s:'Stop',
          blurb:'Define stop conditions to prevent runaway drift.',
          bullets:['Stop', 'Reset', 'Recalibrate'],
          mini:['STOP','RESET','RECAL']
        }
      ]
    },

    /* SE */
    orcid:{
      meta:'SE ¬∑ ORCID',
      title:'ORCID',
      origin_ex:'Identity anchor.',
      now_ex:'Researcher iD reference.',
      traj_ex:'Long-term traceability.',
      origin_ln:'Origin: identity anchors keep attribution stable across time.',
      now_ln:'Now: ORCID ties work to a consistent researcher identity.',
      traj_ln:'Trajectory: long-term traceability and provenance.',
      subs:[
        {k:'id', t:'Identity', s:'Anchor',
          blurb:'Stable researcher identity reference.',
          bullets:['Persistent iD', 'Attribution', 'Continuity'],
          mini:['ID','ATTR','CONT']
        },
        {k:'cite', t:'Citations', s:'Provenance',
          blurb:'Tie outputs to identity for provenance stability.',
          bullets:['Cite', 'Link', 'Trace'],
          mini:['CITE','LINK','TRACE']
        },
        {k:'use', t:'When to use', s:'Anytime',
          blurb:'Use whenever formal attribution matters.',
          bullets:['Preprints', 'Reports', 'Datasets'],
          mini:['FORMAL','PUBLIC']
        },
        {k:'share', t:'Sharing', s:'Continuity',
          blurb:'Continuity across publications and archives.',
          bullets:['Archive', 'Reuse', 'Public reference'],
          mini:['ARCHIVE','REUSE']
        }
      ]
    },

    osf:{
      meta:'SE ¬∑ OSF',
      title:'OSF',
      origin_ex:'Public research spine.',
      now_ex:'Registry + canonical references.',
      traj_ex:'Continuity ledger.',
      origin_ln:'Origin: OSF provides persistent project registry and canonical linking.',
      now_ln:'Now: stable identifiers for projects, preprints, and artifacts.',
      traj_ln:'Trajectory: continuity ledger for system evolution.',
      subs:[
        {k:'reg', t:'Registry', s:'Canonical',
          blurb:'OSF organizes projects and keeps canonical references stable.',
          bullets:['Project IDs', 'Stable links', 'Public spine'],
          mini:['CANON','STABLE','PUBLIC']
        },
        {k:'pre', t:'Preprints', s:'Release',
          blurb:'Publish artifacts with stable identifiers.',
          bullets:['Preprint', 'Working paper', 'Supplement'],
          mini:['RELEASE','ID']
        },
        {k:'map', t:'Mapping', s:'Crosslinks',
          blurb:'Map branches to hubs without navigation drift.',
          bullets:['Crosslink', 'Anchor', 'Navigate'],
          mini:['MAP','ANCHOR']
        },
        {k:'use', t:'When', s:'Reference',
          blurb:'Use when you need persistent public reference.',
          bullets:['Public proof', 'Collab', 'Share'],
          mini:['PROOF','SHARE']
        }
      ]
    },

    refs:{
      meta:'SE ¬∑ References',
      title:'References',
      origin_ex:'Prevent semantic drift.',
      now_ex:'Core anchors + citations.',
      traj_ex:'Shared coordinates.',
      origin_ln:'Origin: references prevent meaning collapse when systems grow.',
      now_ln:'Now: core citations, anchors, and mapping for shared understanding.',
      traj_ln:'Trajectory: shared coordinates across audiences.',
      subs:[
        {k:'core', t:'Core anchors', s:'Stability',
          blurb:'Anchors keep meaning stable across time.',
          bullets:['Canonical terms', 'Stable mapping', 'Clear definitions'],
          mini:['STABLE','CLEAR']
        },
        {k:'link', t:'Links', s:'Identity',
          blurb:'Links connect evidence, identity, and outputs.',
          bullets:['Evidence', 'Identity', 'Outputs'],
          mini:['EVIDENCE','ID','OUTPUT']
        },
        {k:'scope', t:'Scope', s:'256',
          blurb:'References scale into the 256 geometry.',
          bullets:['State indexing', 'Auditability', 'Replay'],
          mini:['256','AUDIT','REPLAY']
        },
        {k:'use', t:'Use', s:'Alignment',
          blurb:'Use whenever you need alignment across audiences.',
          bullets:['Teams', 'Readers', 'Institutions'],
          mini:['ALIGN','SHARE']
        }
      ]
    },

    contact:{
      meta:'SE ¬∑ Contact',
      title:'Contact',
      origin_ex:'Restore alignment quickly.',
      now_ex:'Direct channel.',
      traj_ex:'Intake for adoption.',
      origin_ln:'Origin: direct communication reduces friction and speeds resolution.',
      now_ln:'Now: contact channel for access, questions, and collaboration.',
      traj_ln:'Trajectory: intake pipeline for certification and adoption.',
      subs:[
        {k:'in', t:'Intake', s:'Requests',
          blurb:'Use for collaboration, questions, and access.',
          bullets:['Question', 'Collab', 'Access'],
          mini:['ASK','COLLAB','ACCESS']
        },
        {k:'ops', t:'Ops', s:'Coordination',
          blurb:'Operational coordination and structure.',
          bullets:['Schedule', 'Scope', 'Delivery'],
          mini:['OPS','SCOPE','DELIVER']
        },
        {k:'cert', t:'Certification', s:'Tracks',
          blurb:'Training and certification coordination.',
          bullets:['Track', 'Verify', 'Certify'],
          mini:['TRAIN','VERIFY','CERT']
        },
        {k:'use', t:'When', s:'Resolution',
          blurb:'Use when you need resolution or alignment.',
          bullets:['Misalignment', 'Drift', 'Uncertainty'],
          mini:['RESOLVE','ALIGN']
        }
      ]
    }
  };

  /* ====== MODAL WIRING ====== */
  const backdrop = document.getElementById('backdrop');
  const mclose = document.getElementById('mclose');
  const mmeta = document.getElementById('mmeta');
  const mtitle = document.getElementById('mtitle');
  const mdesc = document.getElementById('mdesc');
  const mgrid = document.getElementById('mgrid');

  const subpanel = document.getElementById('subpanel');
  const subTitle = document.getElementById('subTitle');
  const subBlurb = document.getElementById('subBlurb');
  const subBullets = document.getElementById('subBullets');
  const subMini = document.getElementById('subMini');

  const state = { openKey:null };

  function openModal(){ backdrop.classList.add('open'); document.body.style.overflow='hidden'; }
  function closeModal(){
    backdrop.classList.remove('open');
    document.body.style.overflow='';
    state.openKey=null;
    subpanel.classList.remove('open');
  }
  mclose.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && backdrop.classList.contains('open')) closeModal(); });

  function chipText(){
    document.querySelectorAll('.chip').forEach(c=>{
      const k=c.getAttribute('data-chip');
      c.classList.toggle('on', k===lens);
    });
  }

  function renderModal(key){
    const b = blocks[key];
    if(!b) return;
    state.openKey = key;

    mmeta.textContent = b.meta || 'DETAIL';
    mtitle.textContent = b.title || '‚Äî';

    // Explore vs Learn changes which description is used (depth only)
    const descKey =
      (lens==='origin' ? (depth==='learn' ? 'origin_ln' : 'origin_ex')
      : lens==='trajectory' ? (depth==='learn' ? 'traj_ln' : 'traj_ex')
      : (depth==='learn' ? 'now_ln' : 'now_ex'));

    mdesc.textContent = (b[descKey] || '').trim();

    // build nested bubbles
    mgrid.innerHTML='';
    (b.subs||[]).forEach((s, idx)=>{
      const el=document.createElement('div');
      el.className='subbubble';
      el.innerHTML =
        '<div class="t"><b>'+esc(s.t)+'</b><i>'+esc(s.s||'')+'</i></div>' +
        '<div class="go">‚ñ∂</div>';
      el.addEventListener('click', ()=>{
        subTitle.textContent = s.t;
        subBlurb.textContent = s.blurb || '';
        subBullets.innerHTML = '';
        (s.bullets||[]).forEach(x=>{
          const li=document.createElement('li');
          li.textContent=x;
          subBullets.appendChild(li);
        });
        subMini.innerHTML='';
        (s.mini||[]).forEach(x=>{
          const d=document.createElement('div');
          d.className='minichip';
          d.textContent=x;
          subMini.appendChild(d);
        });
        subpanel.classList.add('open');
      });
      mgrid.appendChild(el);

      // Learn mode: auto-open first subpanel
      if(depth==='learn' && idx===0){
        setTimeout(()=>el.click(), 0);
      }
    });

    if(depth!=='learn'){
      subpanel.classList.remove('open');
    }

    chipText();
  }

  function esc(str){
    return String(str).replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }

  document.querySelectorAll('.bubble').forEach(b=>{
    b.addEventListener('click', ()=>{
      const key=b.getAttribute('data-block');
      renderModal(key);
      openModal();
    });
  });

  // lens handlers
  function setLens(next){
    lens = next;
    localStorage.setItem('crp_lens', lens);
    setActiveLensUI();
    if(state.openKey) renderModal(state.openKey);
  }
  function setActiveLensUI(){
    Object.keys(lensBtn).forEach(k=>lensBtn[k].classList.toggle('active', k===lens));
    chipText();
  }

  lensBtn.origin.addEventListener('click',()=>setLens('origin'));
  lensBtn.now.addEventListener('click',()=>setLens('now'));
  lensBtn.trajectory.addEventListener('click',()=>setLens('trajectory'));

  // init
  if(!lensBtn[lens]) lens='now';
  setActiveLensUI();
})();
</script>

</body>
</html>
