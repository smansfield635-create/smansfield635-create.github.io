<!-- TNT — /home/index.html  (HUB PAGE vNext)
     Fixes requested:
     1) MAP bubble page gets a subtle red undertone so it matches the site (no “different website” feel).
     2) MAP explanations upgraded: each item has a real sentence (subject + predicate), not one-word labels.
     3) Remove “LANGUAGE” from the HUB page (redundant). Keep EXIT + MAP only.
     4) Move “Traversal Architecture” tag to a visible stamp position (bottom-right).
     5) Lenses remain INSIDE direction bubbles (modal), not on the main page.
     Dual-lens (EN + 中文) preserved.
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HUB · Cardinal Axis</title>

<link rel="stylesheet" href="/assets/ui.css"/>
<link rel="stylesheet" href="/assets/branch.css"/>

<style>
:root{
  --R:124px;
  --gold:rgba(212,175,55,.9);
  --goldSoft:rgba(212,175,55,.35);
  --obs1:#070b12;
  --obs2:#0c1626;
  --mut:rgba(255,255,255,.82);
  --mut2:rgba(255,255,255,.68);
}

body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(circle at 50% 40%, rgba(90,140,255,.10), transparent 60%),
    repeating-linear-gradient(45deg, rgba(255,255,255,.02) 0 1px, transparent 1px 100px),
    linear-gradient(180deg,#b00000 0%,#7a0000 60%,#550000 100%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:#fff;
  overflow-x:hidden;
}

/* ===== TOP LEFT ONLY (clean page) ===== */
.top-left{
  position:fixed;left:16px;top:16px;z-index:90;
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
}
.btn{
  padding:10px 16px;
  border-radius:14px;
  background:linear-gradient(145deg,var(--obs2),var(--obs1));
  color:white;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 14px 36px rgba(0,0,0,.7);
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  text-decoration:none;
}
.btn:hover{ box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 14px var(--goldSoft); }
.btn.active{ box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 22px rgba(212,175,55,.45); border-color:rgba(212,175,55,.25); }

/* ===== STAGE ===== */
.stage{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(560px,92vw);
  height:min(560px,92vw);
  z-index:40;
}

/* ===== GEM DIAMONDS ===== */
.diamond{
  width:150px;height:150px;
  position:absolute;
  left:50%;top:50%;
  transform-origin:center;
  border-radius:22px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;

  background:
    radial-gradient(circle at 35% 25%, rgba(255,255,255,.15), transparent 55%),
    radial-gradient(circle at 70% 80%, rgba(0,80,255,.18), transparent 60%),
    linear-gradient(160deg, var(--obs2) 0%, var(--obs1) 60%);

  box-shadow:
    0 25px 70px rgba(0,0,0,.82),
    inset 0 2px 0 rgba(255,255,255,.18),
    inset 0 -25px 35px rgba(0,0,0,.65);

  border:1px solid rgba(255,255,255,.08);
  transition:all 260ms ease;
}
.diamond::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background:repeating-conic-gradient(from 0deg, rgba(255,255,255,.04) 0deg 5deg, transparent 5deg 15deg);
  mix-blend-mode:overlay;
  opacity:.25;
  pointer-events:none;
}
.diamond:hover{
  transform:translate(-50%,-50%) rotate(45deg) scale(1.02);
  box-shadow:
    0 30px 90px rgba(0,0,0,.9),
    0 0 22px var(--goldSoft),
    inset 0 2px 0 rgba(255,255,255,.22),
    inset 0 -28px 40px rgba(0,0,0,.7);
}
.diamond.active{
  box-shadow:
    0 30px 90px rgba(0,0,0,.9),
    0 0 30px rgba(212,175,55,.55),
    inset 0 2px 0 rgba(255,255,255,.22),
    inset 0 -28px 40px rgba(0,0,0,.7);
}

.inner{
  width:100%;
  height:100%;
  transform:rotate(-45deg);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:16px;
  gap:8px;
  pointer-events:none;
}
.dir{ font-weight:950; letter-spacing:.6px; font-size:16px; }
.preview{ font-size:13px; opacity:.88; line-height:1.35; max-width:16em; }

#north{ transform:translate(-50%,-50%) translate(0, calc(var(--R) * -1)) rotate(45deg); }
#east { transform:translate(-50%,-50%) translate(var(--R),0) rotate(45deg); }
#south{ transform:translate(-50%,-50%) translate(0,var(--R)) rotate(45deg); }
#west { transform:translate(-50%,-50%) translate(calc(var(--R) * -1),0) rotate(45deg); }

.core{
  position:absolute;
  left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:64px;height:64px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  box-shadow:0 18px 44px rgba(0,0,0,.62), inset 0 2px 0 rgba(255,255,255,.10);
  display:grid;
  place-items:center;
  font-weight:950;
  letter-spacing:.5px;
  opacity:.90;
  pointer-events:none;
}

/* ===== BOTTOM DOCK ===== */
.dock{
  position:fixed;
  left:50%;
  bottom:max(12px, env(safe-area-inset-bottom));
  transform:translateX(-50%);
  z-index:90;
  width:min(900px,94vw);
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  backdrop-filter:blur(8px);
}

/* ===== ARCHITECTURE STAMP (visible) ===== */
.stamp{
  position:fixed;
  right:16px;
  bottom:max(16px, env(safe-area-inset-bottom));
  z-index:85;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  backdrop-filter:blur(8px);
  font-weight:950;
  letter-spacing:.8px;
  font-size:11px;
  opacity:.90;
}

/* ===== MODAL (CENTERED, INTERNAL SCROLL) ===== */
.bd{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  backdrop-filter:blur(10px);
  display:none;
  z-index:200;
}
.bd.show{display:block;}

.modal{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(860px,92vw);
  max-height:84vh;
  display:none;
  z-index:210;
}
.modal.show{display:block;}

.shell{
  height:84vh;
  max-height:84vh;
  border-radius:26px;
  border:1px solid rgba(255,255,255,.10);
  /* subtle red undertone mixed into obsidian so it doesn't feel “different site” */
  background:
    radial-gradient(circle at 50% 20%, rgba(176,0,0,.18), transparent 55%),
    radial-gradient(circle at 35% 25%, rgba(90,140,255,.10), transparent 55%),
    linear-gradient(160deg,var(--obs2) 0%, var(--obs1) 65%);
  box-shadow:0 60px 180px rgba(0,0,0,.92);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.mhead{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  flex:0 0 auto;
}
.mtitle{ margin:0; font-weight:950; letter-spacing:.3px; font-size:16px; }
.mclose{ border:0; background:transparent; color:#fff; font-size:18px; cursor:pointer; padding:8px 10px; }

.mbody{
  padding:14px 16px 16px;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  flex:1 1 auto;
}

/* Lens controls INSIDE modal only */
.lensbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:center;
  padding:10px 10px 14px;
  border-bottom:1px solid rgba(255,255,255,.08);
  margin:-6px -6px 14px;
}
.chip{
  padding:10px 16px;
  border-radius:999px;
  background:linear-gradient(145deg,var(--obs2),var(--obs1));
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 14px 36px rgba(0,0,0,.65);
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  color:#fff;
}
.chip.active{
  border-color:rgba(212,175,55,.35);
  box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 16px rgba(212,175,55,.30);
}

.lead{
  font-weight:950;
  letter-spacing:.2px;
  margin:0 0 8px 0;
}
.p{
  margin:0 0 12px 0;
  color:var(--mut);
  line-height:1.55;
}
.ul{
  margin:0 0 0 18px;
  padding:0;
  color:var(--mut2);
}
.ul li{ margin:6px 0; }

/* Map bubbles (sentence-level explanations) */
.mapgrid{
  display:grid;
  gap:14px;
}
@media (min-width:760px){ .mapgrid{ grid-template-columns:1fr 1fr; } }

.mapbubble{
  padding:16px 18px;
  border-radius:20px;
  background:
    radial-gradient(circle at 30% 30%, rgba(120,160,255,.08), transparent 55%),
    linear-gradient(145deg,var(--obs2),var(--obs1));
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 18px 55px rgba(0,0,0,.78), inset 0 2px 0 rgba(255,255,255,.06);
  position:relative;
}
.mapbubble::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:20px;
  padding:1px;
  background:linear-gradient(120deg, transparent 0%, var(--goldSoft) 50%, transparent 100%);
  opacity:.55;
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  pointer-events:none;
}
.mapbubble .t{ font-weight:950; margin:0 0 6px; letter-spacing:.2px; }
.mapbubble .s{ margin:0; color:var(--mut2); line-height:1.45; }
.mapbubble .go{
  margin-top:10px;
  display:inline-block;
  padding:10px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  box-shadow:0 12px 30px rgba(0,0,0,.6);
  text-decoration:none;
  color:#fff;
  font-weight:900;
  letter-spacing:.2px;
}
.mapbubble .go:hover{ box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 14px var(--goldSoft); }

/* Small screens */
@media (max-width:520px){
  :root{ --R: 116px; }
  .stage{ width:min(520px,92vw); height:min(520px,92vw); }
  .core{ width:58px; height:58px; }
  .shell{ height:86vh; max-height:86vh; }
}
</style>
</head>

<body>

<div class="top-left" id="topLeft">
  <a class="btn" href="/door/">EXIT</a>
  <button class="btn" id="mapBtn">MAP</button>
</div>

<div class="stage" id="centerStage">
  <div class="diamond" id="north"><div class="inner"><div class="dir" id="nLab">NORTH</div><div class="preview" id="northText"></div></div></div>
  <div class="diamond" id="east"><div class="inner"><div class="dir" id="eLab">EAST</div><div class="preview" id="eastText"></div></div></div>
  <div class="diamond" id="south"><div class="inner"><div class="dir" id="sLab">SOUTH</div><div class="preview" id="southText"></div></div></div>
  <div class="diamond" id="west"><div class="inner"><div class="dir" id="wLab">WEST</div><div class="preview" id="westText"></div></div></div>
  <div class="core">◆</div>
</div>

<nav class="dock" id="bottomDock">
  <a class="btn" id="goTerminal" href="/index.html">TERMINAL</a>
  <a class="btn" id="goLinks" href="/links/">LINKS</a>
  <a class="btn" id="goProducts" href="/products/">PRODUCTS</a>
  <a class="btn" id="goLaws" href="/laws/">LAWS</a>
  <a class="btn" id="goGauges" href="/gauges/">GAUGES</a>
</nav>

<div class="stamp" id="stamp">TRAVERSAL ARCHITECTURE</div>

<div class="bd" id="bd"></div>

<div class="modal" id="modal" role="dialog" aria-modal="true">
  <div class="shell">
    <div class="mhead">
      <h3 class="mtitle" id="mTitle">NORTH</h3>
      <button class="mclose" id="mClose" aria-label="Close">✕</button>
    </div>

    <div class="mbody" id="mbody">
      <!-- Lens controls (only shown for direction content, hidden for MAP) -->
      <div class="lensbar" id="lensbar">
        <button class="chip" id="styleChip">STYLE: FORMAL</button>
        <button class="chip" data-time="origin" id="chipOrigin">ORIGIN</button>
        <button class="chip" data-time="now" id="chipNow">NOW</button>
        <button class="chip" data-time="post" id="chipPost">POST</button>
      </div>

      <!-- Direction content -->
      <div id="dirContent">
        <p class="lead" id="lead"></p>
        <p class="p" id="para"></p>
        <ul class="ul" id="bullets"></ul>
      </div>

      <!-- Map content -->
      <div id="mapContent" style="display:none;">
        <p class="lead" id="mapLead"></p>
        <p class="p" id="mapPara"></p>
        <div class="mapgrid" id="mapGrid"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Permanent dual lens
  const qs = new URLSearchParams(location.search);
  const qLang = qs.get("lang");
  let lang = (qLang==="zh"||qLang==="en") ? qLang : (localStorage.getItem("gd_lang")==="zh" ? "zh" : "en");
  try{ localStorage.setItem("gd_lang", lang); }catch(e){}

  // state (persisted, controls inside modal only)
  let style = localStorage.getItem("gd_style") || "formal";
  let time  = localStorage.getItem("gd_time")  || "now";
  if(time==="trajectory") time="post";
  if(!["origin","now","post"].includes(time)) time="now";
  if(!["formal","informal"].includes(style)) style="formal";

  // UI strings
  const UI = {
    en:{
      stamp:"TRAVERSAL ARCHITECTURE",
      dirs:{north:"NORTH",east:"EAST",south:"SOUTH",west:"WEST"},
      s:{formal:"FORMAL",informal:"INFORMAL"},
      t:{origin:"ORIGIN",now:"NOW",post:"POST"},
      mapTitle:"HUB MAP",
      mapLead:"Jump anywhere from the hub.",
      mapPara:"Every link carries your current language and lens state forward so the site stays coherent.",
      mapItems:[
        {t:"Terminal", s:"Terminal explains how the system works and what is safe to explore right now.", href:"/index.html"},
        {t:"Links", s:"Links collect identity anchors, references, and external entry points.", href:"/links/"},
        {t:"Products", s:"Products show execution surfaces and applied systems built from the architecture.", href:"/products/"},
        {t:"Laws", s:"Laws publish standards, rules, and governance constraints in a readable form.", href:"/laws/"},
        {t:"Gauges", s:"Gauges provide dashboards and metrics for operational monitoring.", href:"/gauges/"}
      ]
    },
    zh:{
      stamp:"遍历架构",
      dirs:{north:"北",east:"东",south:"南",west:"西"},
      s:{formal:"正式",informal:"非正式"},
      t:{origin:"起源",now:"当前",post:"未来"},
      mapTitle:"枢纽地图",
      mapLead:"从枢纽跳转到任意页面。",
      mapPara:"所有链接都会携带当前语言与透镜状态，从而保持结构一致与含义稳定。",
      mapItems:[
        {t:"终端", s:"终端说明系统如何运作，以及当前可安全浏览的范围。", href:"/index.html"},
        {t:"链接", s:"链接汇集身份锚点、参考资料与外部入口。", href:"/links/"},
        {t:"产品", s:"产品展示由架构衍生的执行界面与应用系统。", href:"/products/"},
        {t:"法则", s:"法则以可读形式发布标准、规则与治理约束。", href:"/laws/"},
        {t:"量规", s:"量规提供仪表盘与指标用于运行监控。", href:"/gauges/"}
      ]
    }
  };
  const T = UI[lang] || UI.en;

  // Content (lead + paragraph + 4 bullets) — direction modal
  const C = {
    north:{
      en:{
        formal:{
          origin:{lead:"North establishes invariant structure.",para:"North is the reference frame. It keeps meaning stable under constraint.",bul:["Defines the baseline.","Prevents drift.","Locks structure.","Anchors truth."]},
          now:{lead:"North stabilizes position.",para:"North maintains alignment in the present window.",bul:["Detects deviation.","Re-centers choices.","Keeps coherence.","Reduces noise."]},
          post:{lead:"North preserves long-term coherence.",para:"North protects integrity across cycles and time pressure.",bul:["Stops slow corruption.","Keeps direction.","Sustains truth.","Holds the future constant."]}
        },
        informal:{
          origin:{lead:"North is your anchor.",para:"North keeps you grounded so you don’t drift.",bul:["Keeps you honest.","Keeps you steady.","Gives a baseline.","Stops drift early."]},
          now:{lead:"North keeps you steady.",para:"North clears the fog and holds you in alignment.",bul:["Less confusion.","More consistency.","Cleaner choices.","Better direction."]},
          post:{lead:"North preserves long-term coherence.",para:"Post is formal-only; switching you to formal to keep it rigorous.",bul:["Formal lens applied.","Future stability.","Integrity preserved.","Coherence maintained."]}
        }
      },
      zh:{
        formal:{
          origin:{lead:"北：建立不变结构。",para:"北是参考系，确保含义在约束下保持稳定。",bul:["定义基线。","防止漂移。","锁定结构。","锚定真理。"]},
          now:{lead:"北：稳定当前位置。",para:"北在当前窗口保持对齐与清晰。",bul:["发现偏差。","重置选择。","保持一致。","降低噪声。"]},
          post:{lead:"北：保持长期一致性。",para:"北在时间压力下保护长期完整性。",bul:["阻止慢性腐蚀。","保持方向。","维持真理。","锚定未来。"]}
        },
        informal:{
          origin:{lead:"北：你的锚点。",para:"北让你不漂移，保持脚下稳定。",bul:["保持诚实。","保持稳定。","提供基线。","提前止漂。"]},
          now:{lead:"北：让你稳住。",para:"北清除迷雾，让你保持对齐。",bul:["更少混乱。","更一致。","更清晰选择。","更好方向。"]},
          post:{lead:"北：保持长期一致性。",para:"未来透镜为正式优先；已切换到正式以保持严谨。",bul:["已启用正式。","未来稳定。","完整性保护。","一致性维持。"]}
        }
      }
    },
    east:{
      en:{
        formal:{
          origin:{lead:"East maps execution pathways.",para:"East turns structure into motion by defining how execution flows.",bul:["Defines routes.","Enables action.","Starts motion.","Creates throughput."]},
          now:{lead:"East expresses flow.",para:"East is execution in the present window—movement, output, throughput.",bul:["Runs operations.","Ships output.","Moves forward.","Maintains velocity."]},
          post:{lead:"East scales forward.",para:"East projects capability forward without collapsing structure.",bul:["Expands reach.","Scales safely.","Sustains growth.","Protects throughput."]}
        },
        informal:{
          origin:{lead:"East starts motion.",para:"East gets things moving.",bul:["Turn it on.","Start the process.","Build momentum.","Move."]},
          now:{lead:"East is doing.",para:"East is the doing part.",bul:["Execute.","Move it.","Ship it.","Keep going."]},
          post:{lead:"East scales forward.",para:"Post is formal-only; switching you to formal to keep it rigorous.",bul:["Formal lens applied.","Scale safely.","Protect structure.","Project forward."]}
        }
      },
      zh:{
        formal:{
          origin:{lead:"东：映射执行路径。",para:"东把结构转成运动，定义执行如何流动。",bul:["定义路径。","开启行动。","启动运动。","形成吞吐。"]},
          now:{lead:"东：表达流程。",para:"东是当前窗口的执行：运动、产出、吞吐。",bul:["运行运作。","交付产出。","推进前行。","维持速度。"]},
          post:{lead:"东：向前扩展。",para:"东将能力投射到未来，同时不让结构崩塌。",bul:["扩大范围。","安全扩展。","持续增长。","保护吞吐。"]}
        },
        informal:{
          origin:{lead:"东：启动运动。",para:"东让事情动起来。",bul:["点火。","开始流程。","积累动量。","前进。"]},
          now:{lead:"东：正在做。",para:"东就是“做”。",bul:["执行。","推进。","交付。","持续。"]},
          post:{lead:"东：向前扩展。",para:"未来透镜为正式优先；已切换到正式以保持严谨。",bul:["已启用正式。","安全扩展。","保护结构。","向前投射。"]}
        }
      }
    },
    south:{
      en:{
        formal:{
          origin:{lead:"South defines convergence pressure.",para:"South compacts ambiguity and forces commitment.",bul:["Creates focus.","Forces decisions.","Compacts uncertainty.","Raises stakes."]},
          now:{lead:"South applies constraint.",para:"South adds pressure that turns intent into proof.",bul:["Adds accountability.","Creates traction.","Turns talk to proof.","Amplifies force."]},
          post:{lead:"South compounds momentum.",para:"South ensures pressure compounds rather than dissipates.",bul:["Builds compounding returns.","Accelerates outcomes.","Sustains force.","Creates convergence."]}
        },
        informal:{
          origin:{lead:"South is where force happens.",para:"South is pressure time.",bul:["Get real.","Stop excuses.","Add pressure.","Move."]},
          now:{lead:"South pushes.",para:"South pushes you forward.",bul:["Drive action.","Create urgency.","Force clarity.","Break stagnation."]},
          post:{lead:"South compounds momentum.",para:"Post is formal-only; switching you to formal to keep it rigorous.",bul:["Formal lens applied.","Compound returns.","Sustain force.","Converge."]}
        }
      },
      zh:{
        formal:{
          origin:{lead:"南：定义汇聚压力。",para:"南压缩模糊，迫使承诺。",bul:["形成焦点。","迫使决策。","压缩不确定。","提升压力。"]},
          now:{lead:"南：施加约束。",para:"南把意图变成证据。",bul:["增加问责。","形成牵引。","把话变证据。","放大力量。"]},
          post:{lead:"南：增强动量。",para:"南确保压力复利，而非消散。",bul:["复利增长。","加速结果。","持续施力。","产生汇聚。"]}
        },
        informal:{
          origin:{lead:"南：力量发生处。",para:"南就是压力时间。",bul:["直面现实。","停止借口。","加压。","前进。"]},
          now:{lead:"南：推动。",para:"南把你推向前。",bul:["驱动行动。","制造紧迫。","迫使清晰。","打破停滞。"]},
          post:{lead:"南：增强动量。",para:"未来透镜为正式优先；已切换到正式以保持严谨。",bul:["已启用正式。","复利增长。","持续施力。","汇聚。"]}
        }
      }
    },
    west:{
      en:{
        formal:{
          origin:{lead:"West defines containment.",para:"West sets boundary conditions so the system stays safe.",bul:["Sets limits.","Defines edges.","Prevents leakage.","Keeps scope tight."]},
          now:{lead:"West enforces the edge.",para:"West protects the perimeter in the present window.",bul:["Stops spillover.","Guards boundary.","Maintains control.","Contains risk."]},
          post:{lead:"West protects integrity.",para:"West prevents slow decay and governance capture over time.",bul:["Prevents drift.","Stops exploit paths.","Secures governance.","Preserves stability."]}
        },
        informal:{
          origin:{lead:"West keeps things tight.",para:"West keeps it contained.",bul:["Keep it safe.","Keep it clean.","Keep it simple.","Keep it bounded."]},
          now:{lead:"West guards the edge.",para:"West holds the line.",bul:["Stop overflow.","Protect boundary.","Maintain control.","Prevent chaos."]},
          post:{lead:"West protects integrity.",para:"Post is formal-only; switching you to formal to keep it rigorous.",bul:["Formal lens applied.","Prevent decay.","Secure governance.","Preserve stability."]}
        }
      },
      zh:{
        formal:{
          origin:{lead:"西：管理边界。",para:"西设置边界条件，确保系统安全。",bul:["设定限制。","定义边缘。","防止泄漏。","保持范围紧凑。"]},
          now:{lead:"西：强化边缘。",para:"西在当前窗口守住边界。",bul:["阻止外溢。","守护边界。","保持控制。","约束风险。"]},
          post:{lead:"西：保护完整性。",para:"西防止长期衰减与治理被俘获。",bul:["防止漂移。","阻断利用路径。","巩固治理。","保持稳定。"]}
        },
        informal:{
          origin:{lead:"西：让一切紧凑。",para:"西让它被控制住。",bul:["保持安全。","保持干净。","保持简单。","保持有界。"]},
          now:{lead:"西：守住边界。",para:"西守住底线。",bul:["阻止外溢。","保护边界。","保持控制。","防止混乱。"]},
          post:{lead:"西：保护完整性。",para:"未来透镜为正式优先；已切换到正式以保持严谨。",bul:["已启用正式。","防止衰减。","巩固治理。","保持稳定。"]}
        }
      }
    }
  };

  // Apply labels and stamp
  document.getElementById("nLab").textContent = T.dirs.north;
  document.getElementById("eLab").textContent = T.dirs.east;
  document.getElementById("sLab").textContent = T.dirs.south;
  document.getElementById("wLab").textContent = T.dirs.west;
  document.getElementById("stamp").textContent = T.stamp;

  // Links propagate lang/style/time
  function rewriteLinks(){
    const q = "lang="+encodeURIComponent(lang)+"&style="+encodeURIComponent(style)+"&time="+encodeURIComponent(time);
    document.getElementById("goTerminal").setAttribute("href","/index.html?"+q);
    document.getElementById("goLinks").setAttribute("href","/links/?"+q);
    document.getElementById("goProducts").setAttribute("href","/products/?"+q);
    document.getElementById("goLaws").setAttribute("href","/laws/?"+q);
    document.getElementById("goGauges").setAttribute("href","/gauges/?"+q);
  }

  function persist(){
    try{
      localStorage.setItem("gd_style", style);
      localStorage.setItem("gd_time", time);
    }catch(e){}
  }

  function renderPreviews(){
    document.getElementById("northText").textContent = C.north[lang][style][time].lead;
    document.getElementById("eastText").textContent  = C.east[lang][style][time].lead;
    document.getElementById("southText").textContent = C.south[lang][style][time].lead;
    document.getElementById("westText").textContent  = C.west[lang][style][time].lead;
  }

  // Modal wiring
  const bd = document.getElementById("bd");
  const modal = document.getElementById("modal");
  const mClose = document.getElementById("mClose");
  const mbody = document.getElementById("mbody");

  const mTitle = document.getElementById("mTitle");
  const lead = document.getElementById("lead");
  const para = document.getElementById("para");
  const bullets = document.getElementById("bullets");

  const styleChip = document.getElementById("styleChip");
  const chipOrigin = document.getElementById("chipOrigin");
  const chipNow = document.getElementById("chipNow");
  const chipPost = document.getElementById("chipPost");

  const lensbar = document.getElementById("lensbar");
  const dirContent = document.getElementById("dirContent");
  const mapContent = document.getElementById("mapContent");
  const mapLead = document.getElementById("mapLead");
  const mapPara = document.getElementById("mapPara");
  const mapGrid = document.getElementById("mapGrid");

  let activeDir = null;
  let mode = "dir"; // dir | map

  function setLensLabels(){
    styleChip.textContent = "STYLE: " + (style==="formal" ? T.s.formal : T.s.informal);
    chipOrigin.textContent = T.t.origin;
    chipNow.textContent = T.t.now;
    chipPost.textContent = T.t.post;

    chipOrigin.classList.toggle("active", time==="origin");
    chipNow.classList.toggle("active", time==="now");
    chipPost.classList.toggle("active", time==="post");
  }

  function showDirMode(){
    mode = "dir";
    lensbar.style.display = "flex";
    dirContent.style.display = "block";
    mapContent.style.display = "none";
  }

  function showMapMode(){
    mode = "map";
    lensbar.style.display = "none";
    dirContent.style.display = "none";
    mapContent.style.display = "block";
  }

  function renderModal(){
    if(mode !== "dir" || !activeDir) return;
    if(time==="post" && style==="informal") style="formal";

    const pack = C[activeDir][lang][style][time];

    mTitle.textContent = (activeDir==="north"?T.dirs.north:activeDir==="east"?T.dirs.east:activeDir==="south"?T.dirs.south:T.dirs.west);
    lead.textContent = pack.lead;
    para.textContent = pack.para;

    bullets.innerHTML = "";
    pack.bul.forEach(x=>{
      const li = document.createElement("li");
      li.textContent = x;
      bullets.appendChild(li);
    });

    setLensLabels();
    persist();
    renderPreviews();
    rewriteLinks();
    mbody.scrollTop = 0;
  }

  function openDir(dir){
    activeDir = dir;
    ["north","east","south","west"].forEach(x=>document.getElementById(x).classList.toggle("active", x===dir));
    bd.classList.add("show");
    modal.classList.add("show");
    showDirMode();
    renderModal();
  }

  function openMap(){
    activeDir = null;
    ["north","east","south","west"].forEach(x=>document.getElementById(x).classList.remove("active"));
    bd.classList.add("show");
    modal.classList.add("show");
    showMapMode();

    mTitle.textContent = T.mapTitle;
    mapLead.textContent = T.mapLead;
    mapPara.textContent = T.mapPara;

    mapGrid.innerHTML = "";
    const q = "lang="+encodeURIComponent(lang)+"&style="+encodeURIComponent(style)+"&time="+encodeURIComponent(time);

    (T.mapItems || []).forEach(it=>{
      const box = document.createElement("div");
      box.className = "mapbubble";
      box.innerHTML =
        `<div class="t">${it.t}</div>
         <p class="s">${it.s}</p>
         <a class="go" href="${it.href}?${q}">OPEN →</a>`;
      mapGrid.appendChild(box);
    });

    rewriteLinks();
    mbody.scrollTop = 0;
  }

  function closeModal(){
    bd.classList.remove("show");
    modal.classList.remove("show");
    ["north","east","south","west"].forEach(x=>document.getElementById(x).classList.remove("active"));
    activeDir = null;
  }

  bd.addEventListener("click", closeModal);
  mClose.addEventListener("click", closeModal);

  // Lens interactions (INSIDE modal only)
  styleChip.addEventListener("click", ()=>{
    style = (style==="formal") ? "informal" : "formal";
    if(mode==="dir") renderModal(); else openMap();
  });
  chipOrigin.addEventListener("click", ()=>{ time="origin"; if(mode==="dir") renderModal(); else openMap(); });
  chipNow.addEventListener("click", ()=>{ time="now"; if(mode==="dir") renderModal(); else openMap(); });
  chipPost.addEventListener("click", ()=>{ time="post"; if(mode==="dir") renderModal(); else openMap(); });

  // diamonds
  ["north","east","south","west"].forEach(id=>{
    document.getElementById(id).addEventListener("click", ()=>openDir(id));
  });

  // map button
  document.getElementById("mapBtn").addEventListener("click", openMap);

  // Leveling no overlap
  function level(){
    const tl = document.getElementById("topLeft");
    const dock = document.getElementById("bottomDock");
    const stage = document.getElementById("centerStage");
    if(!dock || !stage) return;

    const safe=10;
    const topBand = (tl ? tl.getBoundingClientRect().bottom : 0) + safe;
    const dockTop = dock.getBoundingClientRect().top - safe;
    const centerY = (topBand + dockTop) / 2;
    stage.style.top = centerY + "px";
  }
  window.addEventListener("resize", level, {passive:true});
  window.addEventListener("orientationchange", ()=>setTimeout(level,50), {passive:true});
  setTimeout(level,0);

  // initial render
  renderPreviews();
  rewriteLinks();
  persist();
})();
</script>

</body>
</html>
