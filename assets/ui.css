(function(){
  if(window.__GEO_UI__) return; window.__GEO_UI__=1;

  function $all(sel,root){ return Array.from((root||document).querySelectorAll(sel)); }

  function setRoom(){
    var p=(location.pathname||"/").toLowerCase();
    var room="sayings";
    if(p.startsWith("/laws")) room="laws";
    else if(p.startsWith("/products")) room="products";
    else if(p.startsWith("/gauges")) room="gauges";
    else if(p.startsWith("/links")) room="links";
    else if(p.startsWith("/uca")) room="uca";
    else if(p.startsWith("/m256")) room="m256";
    else if(p.startsWith("/eai")) room="eai";
    document.body.setAttribute("data-room",room);
  }

  function toggleDrop(id){
    if(!id) return;
    var el=document.getElementById(id);
    if(!el) return;
    el.classList.add("drop");
    el.classList.toggle("open");
  }

  function setToggle(groupId,mode){
    if(!groupId||!mode) return;
    var buttons=$all('[data-toggle="'+groupId+'"]');
    var panes=$all('[data-pane="'+groupId+'"]');
    buttons.forEach(function(b){
      var on=(b.getAttribute("data-mode")||"")===mode;
      b.classList.toggle("active",on);
      b.setAttribute("aria-pressed",on?"true":"false");
    });
    panes.forEach(function(p){
      var on=(p.getAttribute("data-mode")||"")===mode;
      p.classList.toggle("show",on);
      p.style.display=on?"block":"none";
    });
    try{ sessionStorage.setItem("GEO_TOGGLE_"+groupId,mode); }catch(e){}
  }

  function initToggleDefaults(){
    $all("[data-toggle-group]").forEach(function(g){
      var gid=g.getAttribute("data-toggle-group");
      if(!gid) return;
      var saved=null; try{ saved=sessionStorage.getItem("GEO_TOGGLE_"+gid); }catch(e){}
      setToggle(gid,saved||"human");
    });
  }

  function onClick(e){
    var t=e.target;
    var drop=t.closest && t.closest("[data-drop]");
    if(drop){ toggleDrop(drop.getAttribute("data-drop")); return; }
    var tog=t.closest && t.closest("[data-toggle]");
    if(tog){ setToggle(tog.getAttribute("data-toggle"), tog.getAttribute("data-mode")||"human"); return; }
  }

  function boot(){
    setRoom();
    document.addEventListener("click",onClick,true);
    initToggleDefaults();
    setTimeout(initToggleDefaults,40);
    setTimeout(initToggleDefaults,200);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded",boot);
  else boot();
})();
