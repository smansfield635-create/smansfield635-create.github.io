<!-- TNT — /products/software/index.html
     PRODUCTS · SOFTWARE (FROM SCRATCH · MOBILE-SAFE · LONG BUBBLES · NO MODALS)
     LENSES (4):
       - SIDE: ENGINE / PLATFORM
       - TONE: INFORMAL / FORMAL  (gd_style)
       - LANGUAGE: EN / 中文 (gd_lang)
     BEHAVIOR:
       - Single-open accordion (only one domain open at a time)
       - Inside each domain: Concept/Live/Roadmap sub-bubbles are single-open
       - Optional focus routing: ?focus=<id> opens and scrolls (works from any inbound route)
     ROUTES:
       - BACK → /products/
       - DOOR → /door/
       - EXIT → /index.html
       - Dock → HOME / PRODUCTS / LAWS / GAUGES
     STATE:
       - URL + LS: gd_lang/gd_style/gd_time/gd_depth (preserved on every jump)
       - NO new keys introduced
     STYLE:
       - Dark opal + red (NO washed-out blue)
       - Diamond + bar color markers per row
       - No overlay traps; no fixed modal; no inline onclick
     LOCKS:
       - Uses /assets/ui.css + /assets/branch.css + /assets/instruments.js only
       - ui.css owns html/body background (NO overrides)
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PRODUCTS · SOFTWARE</title>

<link rel="stylesheet" href="/assets/ui.css"/>
<link rel="stylesheet" href="/assets/branch.css"/>
<script defer src="/assets/instruments.js"></script>

<style>
a{color:inherit;text-decoration:none}
body{margin:0;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
body::before,body::after{pointer-events:none!important}

:root{
  --dockH:92px;

  /* dark opal + red */
  --opalA:rgba(210,190,255,.14);
  --opalB:rgba(120,70,255,.10);
  --opalR:rgba(255,70,70,.12);

  --stroke:rgba(255,255,255,.12);
  --stroke2:rgba(255,255,255,.10);
  --txt:rgba(255,255,255,.90);
  --mut:rgba(255,255,255,.78);

  --goldSoft:rgba(212,175,55,.35);
  --redSoft:rgba(255,70,70,.22);
}

/* ===== TOP CONTROLS (FIXED, NO OVERLAY) ===== */
.top{
  position:fixed;top:16px;left:0;right:0;
  padding:0 16px;
  z-index:240;
  display:flex;justify-content:space-between;gap:12px;
  pointer-events:none;
}
.top .left,.top .right{
  display:flex;gap:10px;align-items:center;
  flex-wrap:nowrap;white-space:nowrap;
  pointer-events:auto;
}
.top .btn{white-space:nowrap}

/* ===== PAGE WRAP ===== */
.page{
  width:min(1100px,94vw);
  margin:0 auto;
  padding:86px 0 calc(var(--dockH) + 18px);
  display:flex;flex-direction:column;gap:12px;
  position:relative;z-index:10;
}

/* ===== HEADER ===== */
.header{
  border:1px solid var(--stroke);
  border-radius:22px;
  background:
    radial-gradient(circle at 22% 18%, var(--opalA), transparent 62%),
    radial-gradient(circle at 78% 30%, var(--opalB), transparent 66%),
    radial-gradient(circle at 60% 92%, var(--opalR), transparent 62%),
    rgba(0,0,0,.14);
  backdrop-filter:blur(10px);
  box-shadow:0 24px 80px rgba(0,0,0,.55);
  padding:14px 16px 12px;
}
.k{margin:0 0 6px;font-size:11px;letter-spacing:4px;text-transform:uppercase;opacity:.74}
.t{margin:0;font-weight:950;font-size:26px;letter-spacing:.7px}
.s{margin:10px 0 0;font-size:13.75px;opacity:.90;line-height:1.55;max-width:980px;color:var(--txt)}
.fine{margin-top:10px;font-size:12.25px;opacity:.72;line-height:1.45;color:var(--mut)}

/* red signal strip */
.signal{
  margin-top:12px;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(circle at 18% 50%, rgba(255,70,70,.55), transparent 55%),
    radial-gradient(circle at 52% 50%, rgba(255,70,70,.35), transparent 58%),
    radial-gradient(circle at 86% 50%, rgba(255,70,70,.45), transparent 58%),
    linear-gradient(90deg, rgba(255,70,70,.14), rgba(0,0,0,0), rgba(255,70,70,.12));
  box-shadow:0 10px 40px rgba(0,0,0,.35), 0 0 18px rgba(255,70,70,.16);
  opacity:.92;
  overflow:hidden;
  position:relative;
}
@media (prefers-reduced-motion: no-preference){
  .signal::after{
    content:"";
    position:absolute;inset:-40% -50%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
    transform:translateX(-40%);
    animation:scan 2.2s linear infinite;
    opacity:.55;
  }
  @keyframes scan{0%{transform:translateX(-55%)}100%{transform:translateX(55%)}}
}

/* ===== SELECTORS ===== */
.selector{
  margin-top:12px;
  display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
}
.pills{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{
  padding:10px 14px;
  border-radius:999px;
  background:linear-gradient(145deg, rgba(17,22,28,.92), rgba(11,15,20,.96));
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 14px 36px rgba(0,0,0,.65);
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  color:#fff;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.pill.active{
  border-color:rgba(212,175,55,.55);
  box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 14px rgba(212,175,55,.16);
}
.pill.red.active{
  border-color:rgba(255,90,90,.55);
  box-shadow:0 18px 50px rgba(0,0,0,.9), 0 0 16px var(--redSoft);
}

/* ===== BAND ===== */
.band{
  padding:10px 12px;
  border-radius:18px;
  border:1px solid var(--stroke2);
  background:rgba(0,0,0,.12);
  font-weight:950;
  letter-spacing:.2px;
  color:rgba(255,255,255,.88);
}

/* ===== ACCORDION ===== */
.list{display:flex;flex-direction:column;gap:12px}

.row{
  border:1px solid rgba(255,255,255,.10);
  border-radius:22px;
  background:linear-gradient(145deg, rgba(17,22,28,.86), rgba(11,15,20,.92));
  box-shadow:0 16px 52px rgba(0,0,0,.60);
  overflow:hidden;
}
.head{
  display:flex;align-items:flex-start;justify-content:space-between;
  gap:10px;
  padding:14px 16px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.leftRow{
  display:flex;align-items:flex-start;gap:12px;min-width:0;
}
.marker{
  display:flex;align-items:flex-start;gap:10px;flex:0 0 auto;margin-top:2px;
}
.diamond{
  width:10px;height:10px;transform:rotate(45deg);
  border-radius:3px;background:var(--c);
  box-shadow:0 0 0 1px rgba(255,255,255,.14), 0 0 14px rgba(0,0,0,.35);
}
.bar{
  width:6px;height:22px;border-radius:99px;background:var(--c);
  box-shadow:0 0 18px rgba(0,0,0,.25);
}
.titleBlock{min-width:0}
.title{
  font-weight:950;letter-spacing:.2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.sub{
  margin-top:6px;font-size:12.75px;opacity:.80;line-height:1.35;max-width:92ch;
}
.chev{font-size:16px;opacity:.75;flex:0 0 auto;margin-top:2px}

.body{
  display:none;
  padding:14px 16px 16px;
  border-top:1px solid rgba(255,255,255,.08);
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), transparent 55%),
    linear-gradient(145deg, rgba(12,22,38,.86), rgba(7,11,18,.92));
}
.row.open .body{display:block}

.pdesc{margin:0;color:rgba(255,255,255,.86);line-height:1.55;font-size:13.25px}

/* Sub-bubbles: single-open */
.subBubbles{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.bubble{
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:rgba(255,255,255,.05);
  padding:14px 14px 12px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
}
.bubble h4{margin:0 0 8px;font-weight:950;letter-spacing:.15px}
.bubble p{margin:0;color:rgba(255,255,255,.78);line-height:1.65;display:none}
.bubble.open p{display:block}

/* Actions */
.actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
.actions .btn{padding:10px 12px;border-radius:999px;white-space:nowrap}

/* ===== DOCK ===== */
.dock{
  position:fixed;left:50%;
  bottom:max(10px, env(safe-area-inset-bottom));
  transform:translateX(-50%);
  z-index:220;
  width:min(980px,94vw);
  padding:10px 12px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(10px);
  box-shadow:0 18px 60px rgba(0,0,0,.55);
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:10px;
}
.dock .btn{width:100%;padding:10px 10px;border-radius:999px;white-space:nowrap}
@media (max-width:520px){
  :root{--dockH:104px}
  .dock{grid-template-columns:repeat(3, minmax(0,1fr))}
}
</style>
</head>

<body>

<div class="top" aria-label="Top controls">
  <div class="left">
    <a class="btn" id="btnBack" href="/products/">BACK</a>
    <a class="btn" id="btnDoor" href="/door/">DOOR</a>
    <a class="btn" id="btnExit" href="/index.html">EXIT</a>
  </div>
  <div class="right" aria-label="Language">
    <button class="btn" id="btnEN" type="button">EN</button>
    <button class="btn" id="btnZH" type="button">中文</button>
  </div>
</div>

<div class="page">

  <div class="header" aria-label="Header">
    <p class="k" id="hk">SOFTWARE</p>
    <h1 class="t" id="ht">THE MACHINE BEHIND THE PAGES</h1>
    <p class="s" id="hs"></p>
    <div class="fine" id="fine"></div>
    <div class="signal" aria-hidden="true"></div>

    <div class="selector" aria-label="Selectors">
      <div class="pills" aria-label="Side">
        <button class="pill red active" id="pillEngine" type="button">ENGINE</button>
        <button class="pill red" id="pillPlatform" type="button">PLATFORM</button>
      </div>
      <div class="pills" aria-label="Tone">
        <button class="pill active" id="pillInformal" type="button">INFORMAL</button>
        <button class="pill" id="pillFormal" type="button">FORMAL</button>
      </div>
    </div>
  </div>

  <div class="band" id="band">ENGINE DOMAINS</div>
  <div class="list" id="list"></div>

</div>

<nav class="dock" aria-label="Bottom navigation">
  <a class="btn" id="dockHome" href="/home/">HOME</a>
  <a class="btn" id="dockProducts" href="/products/">PRODUCTS</a>
  <a class="btn" id="dockLaws" href="/laws/">LAWS</a>
  <a class="btn" id="dockGauges" href="/gauges/">GAUGES</a>
</nav>

<script>
(function(){
  // ===== canonical state =====
  var qs=new URLSearchParams(location.search);
  var focus=(qs.get("focus")||"").trim();

  var lang  = qs.get("lang")  || localStorage.getItem("gd_lang")  || "en";
  var style = qs.get("style") || localStorage.getItem("gd_style") || "informal";
  var time  = qs.get("time")  || localStorage.getItem("gd_time")  || "now";
  var depth = qs.get("depth") || localStorage.getItem("gd_depth") || "explore";

  if(lang!=="en" && lang!=="zh") lang="en";
  if(style!=="formal" && style!=="informal") style="informal";
  if(time==="trajectory") time="post";
  if(time!=="origin" && time!=="now" && time!=="post") time="now";
  if(depth!=="explore" && depth!=="learn") depth="explore";

  try{
    localStorage.setItem("gd_lang",lang);
    localStorage.setItem("gd_style",style);
    localStorage.setItem("gd_time",time);
    localStorage.setItem("gd_depth",depth);
  }catch(e){}

  document.documentElement.lang=(lang==="zh")?"zh":"en";

  function q(over){
    var L=(over&&over.lang)?over.lang:lang;
    var S=(over&&over.style)?over.style:style;
    var T=(over&&over.time)?over.time:time;
    var D=(over&&over.depth)?over.depth:depth;
    var p="?lang="+encodeURIComponent(L)+"&style="+encodeURIComponent(S)+"&time="+encodeURIComponent(T)+"&depth="+encodeURIComponent(D);
    if(over && over.focus){ p += "&focus="+encodeURIComponent(over.focus); }
    return p;
  }

  // ===== wire nav =====
  function wire(id, path){
    var el=document.getElementById(id);
    if(el) el.href = path + q();
  }
  wire("btnBack","/products/");
  wire("btnDoor","/door/");
  wire("btnExit","/index.html");
  wire("dockHome","/home/");
  wire("dockProducts","/products/");
  wire("dockLaws","/laws/");
  wire("dockGauges","/gauges/");

  // ===== language toggle =====
  var btnEN=document.getElementById("btnEN");
  var btnZH=document.getElementById("btnZH");
  function paintLang(){
    btnEN.classList.toggle("active", lang==="en");
    btnZH.classList.toggle("active", lang==="zh");
  }
  paintLang();
  function setLang(next){
    if(next!=="en" && next!=="zh") next="en";
    lang=next;
    try{ localStorage.setItem("gd_lang",lang); }catch(e){}
    window.location.href = window.location.pathname + q({lang:lang, focus:focus||""});
  }
  btnEN.addEventListener("click", function(){ setLang("en"); });
  btnZH.addEventListener("click", function(){ setLang("zh"); });

  // ===== selectors =====
  var side="engine"; // engine|platform
  var tone=(style==="formal")?"formal":"informal";

  var pillEngine=document.getElementById("pillEngine");
  var pillPlatform=document.getElementById("pillPlatform");
  var pillInformal=document.getElementById("pillInformal");
  var pillFormal=document.getElementById("pillFormal");

  function paintPills(){
    pillEngine.classList.toggle("active", side==="engine");
    pillPlatform.classList.toggle("active", side==="platform");
    pillInformal.classList.toggle("active", tone==="informal");
    pillFormal.classList.toggle("active", tone==="formal");
  }

  pillEngine.addEventListener("click", function(){ side="engine"; paintPills(); render(); });
  pillPlatform.addEventListener("click", function(){ side="platform"; paintPills(); render(); });
  pillInformal.addEventListener("click", function(){
    tone="informal"; style="informal";
    try{ localStorage.setItem("gd_style","informal"); }catch(e){}
    paintPills(); render();
  });
  pillFormal.addEventListener("click", function(){
    tone="formal"; style="formal";
    try{ localStorage.setItem("gd_style","formal"); }catch(e){}
    paintPills(); render();
  });

  // ===== i18n header =====
  function setText(id, v){ var el=document.getElementById(id); if(el) el.textContent=v; }
  function bubbleLabel(which){
    if(lang==="zh") return (which==="concept")?"概念":(which==="live")?"上线":"路线图";
    return (which==="concept")?"Concept":(which==="live")?"Live":"Roadmap";
  }
  function openLabel(){ return (lang==="zh")?"打开":"OPEN"; }

  function applyHeaderText(){
    if(lang==="zh"){
      setText("hk","软件");
      setText("ht","页面背后的机器");
      setText("hs","先选 引擎/平台，再选 通俗/正式。打开一个域，然后打开：概念 / 上线 / 路线图。");
      setText("fine","边界：允许大想法，但任何主张必须被收据约束。缺证据，就不升级。");
      setText("btnBack","返回");
      setText("btnDoor","门");
      setText("btnExit","退出");
      setText("dockHome","主页");
      setText("dockProducts","产品");
      setText("dockLaws","法则");
      setText("dockGauges","量规");
      setText("pillEngine","引擎");
      setText("pillPlatform","平台");
      setText("pillInformal","通俗");
      setText("pillFormal","正式");
    }else{
      setText("hk","SOFTWARE");
      setText("ht","THE MACHINE BEHIND THE PAGES");
      setText("hs","Pick ENGINE/PLATFORM, then INFORMAL/FORMAL. Open one domain, then open: Concept / Live / Roadmap.");
      setText("fine","Boundary: big ideas are allowed, but every claim stays receipt-bounded. Missing evidence means no escalation.");
      setText("pillEngine","ENGINE");
      setText("pillPlatform","PLATFORM");
      setText("pillInformal","INFORMAL");
      setText("pillFormal","FORMAL");
    }
  }
  applyHeaderText();

  // ===== content helpers =====
  function P(en,zh){ return {en:en, zh:zh}; }
  function pick(o){ return (lang==="zh")?o.zh:o.en; }

  // ===== domains =====
  var DOM = {
    // ENGINE
    state_runtime:{c:"#60A5FA", t:P("State Runtime","状态运行时"), s:P("The app’s ‘physics’: what is true right now.","应用的“物理学”：现在什么是真的。")},
    deterministic_gates:{c:"#F59E0B", t:P("Deterministic Gates","确定性闸门"), s:P("Pass/fail rules that don’t change with mood.","不会随情绪变化的通过/失败规则。")},
    receipt_progression:{c:"#93C5FD", t:P("Receipt Progression","收据式推进"), s:P("Advance because you proved it.","你前进是因为你证明了。")},
    audit_discipline:{c:"#34D399", t:P("Audit Discipline","审计纪律"), s:P("Receipts over intent—clean truth.","收据胜过意图——真相更干净。")},
    change_control:{c:"#A3A3A3", t:P("Change Control","变更控制"), s:P("Upgrade without rewriting history.","升级但不改写历史。")},
    admissibility_doctrine:{c:"#EF4444", t:P("Admissibility Doctrine","可采信教义"), s:P("Don’t claim more than receipts allow.","别说超过收据允许的东西。")},

    // PLATFORM
    navigation_surfaces:{c:"#60A5FA", t:P("Navigation Surfaces","导航界面"), s:P("One tap → one outcome.","一次点击→一个结果。")},
    product_packaging:{c:"#F59E0B", t:P("Product Packaging","产品封装"), s:P("Usable tools, bounded claims.","工具可用，主张有界。")},
    enterprise_deployment:{c:"#93C5FD", t:P("Enterprise Deployment","企业部署"), s:P("Scale in waves; rollback ready.","分波次扩张；随时回滚。")},
    dotgrid_sweeps:{c:"#34D399", t:P("Dot.Grid Sweeps","Dot.Grid 扫掠"), s:P("Fair comparisons across windows.","跨窗口公平比较。")},
    scoring_outputs:{c:"#A3A3A3", t:P("Scoring Outputs","评分输出"), s:P("Readable signals with reasons.","可读信号+原因码。")},
    registry_lookups:{c:"#EF4444", t:P("Registry Lookups","登记查询"), s:P("Status you can check.","可核查状态。")}
  };

  var ENGINE = ["state_runtime","deterministic_gates","receipt_progression","audit_discipline","change_control","admissibility_doctrine"];
  var PLATFORM = ["navigation_surfaces","product_packaging","enterprise_deployment","dotgrid_sweeps","scoring_outputs","registry_lookups"];

  // ===== dense copy (EN/中文 × informal/formal × concept/live/roadmap) =====
  // Each string ends with a Next sentence.
  var TEXT = {
    state_runtime:{
      concept:{
        informal:P(
          "Runtime is the gravity of the system. It decides what counts as “now,” what your tap means, and what the next state is allowed to be. If runtime is fuzzy, every page becomes an argument. If runtime is crisp, the experience feels calm because the rules are doing the thinking. Next: lock the smallest set of state keys and treat every move as an atomic handoff.",
          "运行时是系统的重力：它决定什么算“现在”、一次点击意味着什么、以及下一状态允许是什么。运行时模糊，页面就会变成争论；运行时清晰，体验就会安静稳定。Next：锁定最小状态键，并把每一步当作原子交接。"
        ),
        formal:P(
          "Runtime is a constrained state machine under declared keys and scope. Atomic transitions yield reproducible next states from identical evidence and rules, preventing semantic drift under navigation and refresh. Next: require receipts for every outcome-affecting transition and refuse bypass paths.",
          "运行时是受约束的状态机：在声明键与范围下，原子转移从同证据与同规则得到可复现下一状态，阻断导航/刷新下的语义漂移。Next：对每个影响结果的转移要求收据，并拒绝绕过路径。"
        )
      },
      live:{
        informal:P(
          "Live runtime means you can switch language, refresh, and jump around—and the system still knows what’s true. If you go back, downstream steps can become invalid, and the system should say so cleanly. Next: design “back” as a deterministic invalidation event, not a vibe.",
          "上线运行时意味着：切语言、刷新、随便跳，系统仍知道什么是真的。你一回退，下游可能失效，系统要干净地说明。Next：把“返回”设计成确定性的失效事件，而不是感觉。"
        ),
        formal:P(
          "Live posture requires refresh-safe persistence, deterministic back-nav invalidation, and receipt-gated forward moves. Conflicts resolve by containment and rollback, not reinterpretation. Next: log invalidations with reason codes under the same epoch rules.",
          "上线姿态要求刷新安全持久化、确定性回退失效、收据闸门式前进。冲突通过隔离与回滚解决，而非事后换义。Next：在同纪元规则下为失效事件记录原因码。"
        )
      },
      roadmap:{
        informal:P(
          "Next, runtime becomes portable. It emits small “what happened” receipts you can carry across pages and products—so growth doesn’t dilute truth. Next: export minimal bundles (input, decision, result) and keep them replayable.",
          "下一步运行时可携带：输出小型“发生了什么”的收据，跨页面/跨产品带着走，增长也不稀释真相。Next：导出最小包（输入/决策/结果）并保持可回放。"
        ),
        formal:P(
          "Roadmap adds exportable receipt bundles and domain adapters while preserving the state contract. Coverage expands without changing invariants. Next: version any outcome-affecting change as a new epoch to preserve comparability.",
          "路线图加入可导出收据包与领域适配器，同时保持状态契约不变；覆盖面扩大但不变量不变。Next：任何影响结果的变更必须版本化并开启新纪元，以保持可比性。"
        )
      }
    },

    deterministic_gates:{
      concept:{
        informal:P(
          "A gate is a fair bouncer. It doesn’t care who you are—only what you brought. If the proof isn’t there, you don’t get in. That’s how you stop drift before it becomes drama. Next: write gates as simple pass/fail rules with visible reasons.",
          "闸门像公平门卫：不看你是谁，只看你带了什么。没证明就不放行。漂移在变成闹剧前就被止住。Next：把闸门写成简单通过/失败规则，并给出可见原因。"
        ),
        formal:P(
          "Gates are binary admissibility checks under declared scope. Given inputs, the outcome is deterministic and cannot be overridden by narrative. Next: standardize reason codes so independent observers can replay decisions from receipts.",
          "闸门是在声明范围内的二元可采信检查：给定输入，结果确定，不能被叙事覆盖。Next：标准化原因码，使独立观察者可用收据回放决策。"
        )
      },
      live:{
        informal:P(
          "Live gating means no timer tricks and no secret exceptions. Failures get contained and explained. Passes move forward with a receipt so you can replay it later. Next: never allow a silent pass.",
          "上线闸门没有计时花招、没有暗例外。失败会被隔离并解释；通过则带收据前进，之后还能复跑。Next：永远不允许静默通过。"
        ),
        formal:P(
          "Live gates forbid timers-as-gates, hidden shortcuts, and silent overrides. Decisions emit reason codes and are logged for replay. Next: treat any override as an epoch event, not a hidden patch.",
          "上线闸门禁止计时作闸门、暗捷径、静默覆盖。决策带原因码并记录，可回放。Next：任何覆盖都必须作为纪元事件公开，而不是隐藏补丁。"
        )
      },
      roadmap:{
        informal:P(
          "Next, gates become shareable. Two people can look at the same receipt and land on the same answer—no arguing. That’s scalable trust. Next: ship the replay bundle with every gate decision.",
          "下一步闸门可分享：两个人看同一份收据会得到同一个答案——不用吵。这就是可规模化信任。Next：让每个闸门决策携带可回放证明包。"
        ),
        formal:P(
          "Roadmap adds independent replay and cross-check harnesses so outcomes remain observer-invariant from identical receipts. Next: require adversarial tests for high-stakes gates.",
          "路线图加入独立回放与交叉校验，使同收据下结果对观察者不变。Next：高风险闸门必须通过对抗测试。"
        )
      }
    },

    receipt_progression:{
      concept:{
        informal:P(
          "Progress here is earned, not assumed. You don’t advance because time passed—you advance because you produced something real. Receipts turn building into proof, not vibes. Next: define what counts as a receipt before you define what counts as “next.”",
          "这里的进步是挣来的，不是默认的。不是时间过了就升级，而是因为你产出了真实结果。收据把构建变成证明，而不是感觉。Next：先定义什么算收据，再定义什么算下一步。"
        ),
        formal:P(
          "Progression is receipt-gated: advancement requires evidence that survives scope locks. Time does not grant progression; outputs do. Next: require receipts for each transition that changes admissibility or status.",
          "推进是收据闸门式：升级必须有在范围锁下仍成立的证据。时间不授予推进，输出才授予推进。Next：任何改变可采信或状态的转移都必须有收据。"
        )
      },
      live:{
        informal:P(
          "Live progression keeps you honest across navigation. If you go back, downstream steps can become invalid—and the system should tell you cleanly. Next: treat back-navigation as a real operation that can invalidate receipts.",
          "上线推进在导航中保持诚实：你一回退，下游可能失效，系统要干净地说明。Next：把回退当作真实操作，它会使收据失效。"
        ),
        formal:P(
          "Live progression preserves state across navigation and language toggles. Back-nav invalidates downstream receipts deterministically; forward steps require confirmation. Next: log invalidations with reason codes to preserve auditability.",
          "上线推进在导航与语言切换中保持状态；回退确定性地使下游收据失效；前进需确认。Next：失效事件要带原因码记录以便审计。"
        )
      },
      roadmap:{
        informal:P(
          "Next, receipts become portable: you can prove progress across products without exposing private details. Proof scales; privacy stays. Next: make receipts minimal and hashable so they travel safely.",
          "下一步收据可携带：跨产品证明进度而不暴露隐私细节。证明能扩展，隐私不牺牲。Next：收据要最小化且可哈希，才能安全流动。"
        ),
        formal:P(
          "Roadmap enables registrable, hashable receipt bundles for cross-product recognition without centralized trust. Next: publish only status/time/reason codes in public registries.",
          "路线图实现可登记、可哈希的收据包，支持跨产品认可且不依赖中心信任。Next：公共登记只发布状态/时间/原因码。"
        )
      }
    },

    audit_discipline:{
      concept:{
        informal:P(
          "Audit discipline keeps the story from changing under pressure. You don’t argue intent—you show what happened. Receipts decide. Next: make disputes boring by making receipts central.",
          "审计纪律让故事在压力下不变形：不争论意图，只展示发生了什么。收据裁决。Next：让争执变无聊：收据在中心。"
        ),
        formal:P(
          "Audit discipline requires observer-invariant evaluation: outputs are judged by receipts under declared scope, not intent. Next: specify measurement rules so independent observers converge.",
          "审计纪律要求观察者不变：在声明范围内用收据评判输出，而非意图。Next：声明测量规则，使独立观察者收敛。"
        )
      },
      live:{
        informal:P(
          "Live audits make fights cheap. If we disagree, we pull the receipt. If it’s missing, we log the gap and stop escalation. Next: refuse escalation every time receipts are missing.",
          "上线审计让争执变便宜：不一致就拿收据；缺收据就记缺口并停止升级。Next：只要缺收据，就拒绝升级。"
        ),
        formal:P(
          "Live audit mode produces replayable bundles. Disagreements resolve through scope constraints or missing receipts, not interpretation battles. Next: time-anchor logs and keep them immutable per epoch.",
          "上线审计产出可回放包；分歧通过范围约束或缺失收据解决，而不是解释之争。Next：日志必须时间锚定并按纪元不可更改。"
        )
      },
      roadmap:{
        informal:P(
          "Next, auditing gets faster without getting weaker. Builders can’t secretly tune outcomes, and auditors can’t quietly relax rules. Next: separate build authority from tuning authority.",
          "下一步审计更快但不更弱：开发者不能暗调结果，审计者不能暗放宽规则。Next：把构建权与调参权分离。"
        ),
        formal:P(
          "Roadmap adds audit automation with separation of tuning authority. Thresholds are versioned; changes create new epochs; results remain comparable. Next: publish portable audit artifacts for third-party review.",
          "路线图加入自动审计并分离调参权：阈值版本化，变更开新纪元，结果保持可比。Next：发布可携带的审计产物供第三方复核。"
        )
      }
    },

    change_control:{
      concept:{
        informal:P(
          "Change control is how you upgrade without rewriting history. If a change affects outcomes, you stamp a new epoch. Old results keep their meaning. Next: never “fix” a number by quietly moving the rule.",
          "变更控制让你升级但不改历史：只要影响结果就盖新纪元章。旧结果仍保留含义。Next：不要通过偷偷挪规则来“修正数字”。"
        ),
        formal:P(
          "Change control preserves comparability: outcome-affecting changes create new epochs; past results remain interpretable under original rules. Next: enforce explicit versioning for any threshold or definition change.",
          "变更控制保持可比性：影响结果的变更开启新纪元；旧结果按旧规则可解释。Next：任何阈值或定义变更都必须显式版本化。"
        )
      },
      live:{
        informal:P(
          "Live means no chaos pushes. Roll out in waves, keep rollback ready, and never hide a policy change inside a “hotfix.” Next: if you can’t explain the change, don’t ship it.",
          "上线意味着别把混乱推到生产：分波次发布，随时可回滚，别把政策变更塞进“热修”。Next：解释不清的变更，不要发。"
        ),
        formal:P(
          "Live control requires staged rollout, rollback readiness, and documented reasons. Silent tuning is disallowed. Next: log change events as receipts with effective timestamps.",
          "上线控制要求分阶段发布、可回滚准备、理由可追溯；禁止静默调参。Next：把变更事件记录为带生效时间的收据。"
        )
      },
      roadmap:{
        informal:P(
          "Next, updates become signed events you can point to. People trust systems that don’t quietly change under their feet. Next: publish an epoch-tied change log.",
          "下一步更新变成可指认的签名事件：人们信任不会悄悄换地板的系统。Next：发布与纪元绑定的变更日志。"
        ),
        formal:P(
          "Roadmap introduces signed releases and policy registries so changes become verifiable events while maintaining internal speed. Next: add regression tests for comparability across epochs.",
          "路线图引入签名发布与策略登记，使变更成为可验证事件，同时保持内部速度。Next：为跨纪元可比性增加回归测试。"
        )
      }
    },

    admissibility_doctrine:{
      concept:{
        informal:P(
          "Doctrine is the guardrail: don’t say more than you can prove. The moment software starts selling stories, it becomes dangerous. Next: separate concept, measured, and roadmap language everywhere.",
          "教义是护栏：别说超过你能证明的东西。软件一卖故事就危险。Next：到处区分概念/已测/路线图语言。"
        ),
        formal:P(
          "Doctrine defines what may be claimed and what must remain conditional. It prevents upgrades beyond receipts and locks language to measured scope. Next: enforce claim tier separation and require NOT MEASURED outputs when evidence is missing.",
          "教义规定可主张与必须条件化的边界：防止超收据升级，并把语言锁在可测范围。Next：强制主张分层，缺证据必须输出“未测量”。"
        )
      },
      live:{
        informal:P(
          "Live doctrine is labeling discipline: concept stays concept, live stays measured, roadmap stays gated. Missing evidence means the system says “not measured” and moves on. Next: make “not measured” a first-class output, not an embarrassment.",
          "上线教义就是标注纪律：概念就是概念；上线必须可测；路线图必须有闸门。缺证据就说“未测量”，然后继续。Next：把“未测量”当作正常输出，而不是羞耻。"
        ),
        formal:P(
          "Live enforcement keeps posture separated and blocks escalation without receipts. Refusals emit reason codes. Next: standardize refusal codes to prevent narrative workarounds.",
          "上线执行保持姿态分离，并在缺收据时阻断升级。拒绝必须输出原因码。Next：标准化拒绝码，防止叙事绕过。"
        )
      },
      roadmap:{
        informal:P(
          "Next, every page speaks the same honest language. No inflated claims. No surprises. Adoption stays calm. Next: standardize templates so honesty is automatic.",
          "下一步每一页都说同一种诚实语言：不膨胀、不惊喜，采纳才能安静稳定。Next：模板标准化，让诚实自动发生。"
        ),
        formal:P(
          "Roadmap standardizes doctrine templates across products so claim discipline holds everywhere, reducing drift and accelerating safe adoption. Next: add automated checks for claim tier violations.",
          "路线图把教义模板标准化到全产品：主张纪律处处一致，减少漂移，加速安全采纳。Next：增加自动检查，抓主张分层违规。"
        )
      }
    },

    navigation_surfaces:{
      concept:{
        informal:P(
          "Navigation is the steering wheel. It must be boringly reliable: tap once, get one outcome, always. Next: enforce “one tap = one route” and carry state every time.",
          "导航就是方向盘：必须无聊地可靠——点一次，只发生一件事，而且每次都一样。Next：强制“一点=一路由”，并且每次都携带状态。"
        ),
        formal:P(
          "Surfaces present options without altering invariants. UX may simplify, but must not change admissibility. Next: treat missing state propagation as a contract violation.",
          "界面呈现选项但不得改变不变量：体验可简化但不能改可采信。Next：状态不携带视为契约违规。"
        )
      },
      live:{
        informal:P(
          "Live surfaces mean no ghost layers, no overlap traps, and no double routes. If you can’t trust taps, you can’t trust anything. Next: remove overlays that can intercept touches on mobile.",
          "上线界面意味着没有幽灵层、没有重叠陷阱、没有双路由。点按不可信，其他都不可信。Next：移除所有可能拦截移动端点击的遮罩层。"
        ),
        formal:P(
          "Live surfaces enforce tap reliability: each input maps to exactly one deterministic outcome; overlays cannot intercept; state propagation is mandatory. Next: test on mobile first.",
          "上线界面强制点按可靠：每次输入只映射到一个确定结果；遮罩不得拦截；必须携带状态。Next：移动端先测。"
        )
      },
      roadmap:{
        informal:P(
          "Next, every product feels like the same machine. Learn one, use them all. Next: unify templates across Products, Laws, Gauges, and Explore.",
          "下一步每个产品都像同一台机器：学会一个就能用全部。Next：产品/法则/量规/探索统一模板。"
        ),
        formal:P(
          "Roadmap introduces reusable surface templates so interactions remain identical across products, reducing cognitive load and adoption friction. Next: add conformance tests per page type.",
          "路线图引入可复用界面模板，使交互跨产品一致，降低认知负担与采纳摩擦。Next：为每种页面类型加入一致性测试。"
        )
      }
    },

    product_packaging:{
      concept:{
        informal:P(
          "Packaging is the promise the page makes: what you can use, without smuggling doctrine into marketing. Proof lives in Laws. Next: keep “use” separate from “prove.”",
          "封装就是页面承诺：告诉你能用什么，但不把教义偷塞成营销。证明在法则里。Next：把“可用”和“已证”分开。"
        ),
        formal:P(
          "Packaging binds engines to deployable surfaces while keeping doctrine separate. Product pages describe capability; proof pages define admissible claims. Next: prohibit catch-all routing that collapses unrelated surfaces.",
          "封装把引擎绑定到可部署界面，同时保持教义分离：产品页描述能力，证明页定义可采信主张。Next：禁止“总汇路由”坍缩不相关执行面。"
        )
      },
      live:{
        informal:P(
          "Live packaging means no dead ends: every card opens, every open has a return, and every jump preserves state. Next: treat every OPEN button as a contract you test.",
          "上线封装意味着没有死路：卡片都能打开，打开都有返回，跳转都带状态。Next：把每个打开按钮当作要测试的契约。"
        ),
        formal:P(
          "Live packaging enforces stable routes, explicit returns, and mandatory state carry. No universal destinations; each surface routes to its hub. Next: add route tests for every OPEN action.",
          "上线封装强制稳定路由、显式返回、强制携带状态；禁止通用目的地；每个面路由到自己的枢纽。Next：为每个打开动作加路由测试。"
        )
      },
      roadmap:{
        informal:P(
          "Next, packaging scales cleanly: clear tiers, clear access, and safe ‘shells’ for pages not built yet—still routed correctly. Next: publish shells early, but keep claims bounded.",
          "下一步封装可干净规模化：分级清晰、访问清晰、未建也有安全“壳”且路由正确。Next：壳可以先发，但主张必须有界。"
        ),
        formal:P(
          "Roadmap adds tiering and registry status for access legibility while preserving neutrality and claim discipline. Next: require registry signals for high-stakes deployments.",
          "路线图加入分级与登记状态，让访问级别可读，同时保持中立与主张纪律。Next：高风险部署必须绑定登记信号。"
        )
      }
    },

    enterprise_deployment:{
      concept:{
        informal:P(
          "Enterprise is scale without heroics. You deploy in waves, keep zones independent, and always have rollback ready. Next: prove stability at small scale before widening exposure.",
          "企业就是“无英雄主义的规模化”：分波次部署、分区独立、随时回滚。Next：先在小规模证明稳定，再扩大暴露。"
        ),
        formal:P(
          "Enterprise deployment is staged rollout with segmentation and rollback readiness. Claims remain bounded to measured bands. Next: enforce correlated exposure limits as hard constraints.",
          "企业部署是分阶段发布+分区隔离+回滚准备。主张限制在可测区间。Next：把相关暴露上限当作硬约束。"
        )
      },
      live:{
        informal:P(
          "Live posture: if it wobbles, stop. If it clusters, split. If it drifts, roll back. Next: treat rollback as a first-class action, not a panic move.",
          "上线姿态：一晃就停；一聚就拆；一漂就回滚。Next：把回滚设计成一等动作，不是恐慌动作。"
        ),
        formal:P(
          "Live posture monitors correlated exposure and gate compliance. Decisions reference receipts; instability triggers containment and reversion. Next: require audit bundles for tier escalation.",
          "上线姿态监测相关暴露与闸门合规；决策依据收据；不稳触发隔离与回退。Next：分层升级必须有审计包。"
        )
      },
      roadmap:{
        informal:P(
          "Next, enterprise gets proof packages for auditors and partners. They verify posture without your whole stack. Next: make proofs portable and privacy-safe.",
          "下一步企业拥有可交给审计与合作方的证明包：无需整套系统也能核查。Next：证明要可携带且保护隐私。"
        ),
        formal:P(
          "Roadmap adds third-party verification exports, improving underwriting and adoption stability. Next: standardize external export schemas.",
          "路线图加入第三方核查导出，提升承保与采纳稳定性。Next：标准化外部导出格式。"
        )
      }
    },

    dotgrid_sweeps:{
      concept:{
        informal:P(
          "Sweeps keep comparisons fair. Same window, same labels, same method—so “today vs yesterday” means something. Next: don’t change windows mid-run; stamp a new epoch instead.",
          "扫掠让比较公平：同窗口、同标签、同方法，所以“今天 vs 昨天”才有意义。Next：不要中途改窗口；改了就开新纪元。"
        ),
        formal:P(
          "Sweeps enumerate states under fixed definitions and produce comparable evidence windows for classification under constraint. Next: enforce naming stability and window discipline as invariants.",
          "扫掠在固定定义下枚举状态并产出可比较证据窗口，用于约束下分类。Next：把命名稳定与窗口纪律当作不变量。"
        )
      },
      live:{
        informal:P(
          "Live sweeps make drift loud. If naming changes, results stop being comparable—and the system should treat that as failure, not a tweak. Next: treat naming changes as epoch events.",
          "上线扫掠让漂移变响亮：命名一变，结果就不可比——应视为失败而不是小调整。Next：命名变更必须新纪元。"
        ),
        formal:P(
          "Live sweeps enforce window discipline and stable naming. Outputs route to Gauges for display and Laws for interpretation bounds. Next: export drift deltas with time anchors.",
          "上线扫掠强制窗口纪律与稳定命名；输出去量规展示，去法则约束解释。Next：导出漂移差分必须带时间锚。"
        )
      },
      roadmap:{
        informal:P(
          "Next, sweeps reuse across domains: software, water, waste, energy. Learn one sweep method and you get stable comparisons everywhere. Next: ship adapters without changing the sweep contract.",
          "下一步扫掠跨领域复用：软件、水、废弃物、能源。学一种方法，到处复用。Next：发布适配器但不改扫掠契约。"
        ),
        formal:P(
          "Roadmap adds adapter packs so sweeps apply across domains while preserving stability contracts. Next: require conformance tests per adapter.",
          "路线图加入适配包，使扫掠可跨领域，同时保持稳定契约。Next：每个适配器必须有一致性测试。"
        )
      }
    },

    scoring_outputs:{
      concept:{
        informal:P(
          "Scoring is the dashboard version of truth: readable, reason-coded, and bounded. It never lets you average away a failure. Next: always attach “why” to the number.",
          "评分是“真相的仪表盘版本”：可读、带原因码、有边界。它不允许把失败平均掉。Next：数字必须带上“为什么”。"
        ),
        formal:P(
          "Scoring converts gate vectors and exposure into bounded metrics with reason codes. Scores are subordinate to admissibility. Next: prohibit threshold tuning without epoch rollover.",
          "评分把闸门向量与暴露转成带原因码的有界指标。分数服从可采信。Next：阈值调参必须新纪元。"
        )
      },
      live:{
        informal:P(
          "Live scoring means no moving goalposts. If thresholds change, stamp a new epoch. Next: treat silent tuning as a fail.",
          "上线评分不允许挪球门：阈值变更必须新纪元盖章。Next：静默调参视为失败。"
        ),
        formal:P(
          "Live scoring produces stable exports; silent tuning is disallowed. Threshold changes require epoch rollover. Next: emit reason codes for every threshold crossing.",
          "上线评分产出稳定导出；禁止静默调参。阈值变更需新纪元。Next：每次跨阈值都要输出原因码。"
        )
      },
      roadmap:{
        informal:P(
          "Next, you can share a score with proof attached—without dumping private telemetry. Next: publish privacy-safe summaries and portable receipts.",
          "下一步你能分享带证明的分数，而不倾倒隐私遥测。Next：发布隐私安全摘要与可携带收据。"
        ),
        formal:P(
          "Roadmap integrates portfolio/underwriting views while keeping evidence traceable via hashed receipts. Next: standardize export formats.",
          "路线图接入组合/承保视图，同时用哈希收据保持证据可追溯。Next：标准化导出格式。"
        )
      }
    },

    registry_lookups:{
      concept:{
        informal:P(
          "Registry lookup ends “trust me.” It gives status and reasons. Clear. Checkable. Next: separate status from persuasion everywhere.",
          "登记查询终结“信我”：给状态与原因。清楚、可核查。Next：到处分离状态与说服。"
        ),
        formal:P(
          "Registry lookups publish minimal necessary truth: status, time anchoring, and reason codes without exposing sensitive internals. Next: forbid silent revocation.",
          "登记查询发布最小必要真相：状态、时间锚、原因码，不暴露敏感内部。Next：禁止静默撤销。"
        )
      },
      live:{
        informal:P(
          "Live registry means nobody can quietly flip status. If it changes, it’s visible. Next: log every change as an event.",
          "上线登记意味着没人能悄悄翻转状态：变化可见。Next：每次变更都必须作为事件记录。"
        ),
        formal:P(
          "Live registry forbids silent revocation and enforces deterministic renewal. Transitions are logged and auditable. Next: require reason codes for every transition.",
          "上线登记禁止静默撤销并强制确定性续期；转移必须记录且可审计。Next：每次转移都必须有原因码。"
        )
      },
      roadmap:{
        informal:P(
          "Next, registry becomes real-world credibility: partners verify status without your word. Next: keep published truth minimal and stable.",
          "下一步登记系统成为现实可信度：合作方无需听你说，就能核查状态。Next：发布真相要最小化且稳定。"
        ),
        formal:P(
          "Roadmap adds third-party attestations and replay bundles so status becomes verifiable across organizations. Next: define attestation formats under scope locks.",
          "路线图加入第三方证明与回放包，使状态能跨组织核查。Next：在范围锁下定义证明格式。"
        )
      }
    }
  };

  // ===== render =====
  var band=document.getElementById("band");
  var list=document.getElementById("list");

  function bandLabel(){
    if(lang==="zh") return (side==="engine") ? "引擎域" : "平台域";
    return (side==="engine") ? "ENGINE DOMAINS" : "PLATFORM DOMAINS";
  }

  function closeAllRows(){
    list.querySelectorAll(".row").forEach(function(x){
      x.classList.remove("open");
      var c=x.querySelector(".chev"); if(c) c.textContent="▸";
    });
  }

  function render(){
    band.textContent=bandLabel();
    list.innerHTML="";

    var ids=(side==="engine")?ENGINE:PLATFORM;

    ids.forEach(function(id, idx){
      var meta=DOM[id];
      var row=document.createElement("div");
      row.className="row";
      row.style.setProperty("--c", meta.c);
      row.id="focus_"+id;

      var head=document.createElement("div");
      head.className="head";
      head.setAttribute("role","button");
      head.tabIndex=0;

      var leftRow=document.createElement("div");
      leftRow.className="leftRow";

      var marker=document.createElement("div");
      marker.className="marker";
      var bar=document.createElement("div"); bar.className="bar"; bar.style.background=meta.c;
      var diamond=document.createElement("div"); diamond.className="diamond"; diamond.style.background=meta.c;
      marker.appendChild(bar); marker.appendChild(diamond);

      var titleBlock=document.createElement("div");
      titleBlock.className="titleBlock";
      var title=document.createElement("div"); title.className="title"; title.textContent=pick(meta.t);
      var sub=document.createElement("div"); sub.className="sub"; sub.textContent=pick(meta.s);
      titleBlock.appendChild(title); titleBlock.appendChild(sub);

      leftRow.appendChild(marker);
      leftRow.appendChild(titleBlock);

      var chev=document.createElement("div"); chev.className="chev"; chev.textContent="▸";

      head.appendChild(leftRow);
      head.appendChild(chev);

      var body=document.createElement("div"); body.className="body";

      var p=document.createElement("p");
      p.className="pdesc";
      p.textContent = (lang==="zh")
        ? "打开下面三个气泡：概念（是什么/为什么）· 上线（怎么用）· 路线图（怎么扩张）。"
        : "Open the three bubbles: Concept (what/why) · Live (how you use it) · Roadmap (how it scales).";

      var subB=document.createElement("div"); subB.className="subBubbles";

      function closeSiblingBubbles(except){
        subB.querySelectorAll(".bubble").forEach(function(x){
          if(x!==except) x.classList.remove("open");
        });
      }

      function makeBubble(which){
        var b=document.createElement("div");
        b.className="bubble";
        b.setAttribute("role","button");
        b.tabIndex=0;

        var h=document.createElement("h4");
        h.textContent=bubbleLabel(which);

        var pp=document.createElement("p");
        pp.textContent = pick(TEXT[id][which][tone]);

        b.appendChild(h);
        b.appendChild(pp);

        function act(){
          var willOpen=!b.classList.contains("open");
          closeSiblingBubbles(b);
          b.classList.toggle("open", willOpen);
        }
        b.addEventListener("click", act);
        b.addEventListener("keydown", function(e){
          if(e.key==="Enter"||e.key===" "){ e.preventDefault(); act(); }
        });

        return b;
      }

      var b1=makeBubble("concept");
      var b2=makeBubble("live");
      var b3=makeBubble("roadmap");
      subB.appendChild(b1); subB.appendChild(b2); subB.appendChild(b3);

      var actions=document.createElement("div"); actions.className="actions";
      var aDoor=document.createElement("a");
      aDoor.className="btn";
      aDoor.textContent=openLabel()+": "+(lang==="zh"?"DOOR（结构）":"DOOR (STRUCTURE)");
      aDoor.href="/door/"+q();
      actions.appendChild(aDoor);

      body.appendChild(p);
      body.appendChild(subB);
      body.appendChild(actions);

      function openRow(){
        closeAllRows();
        row.classList.add("open");
        chev.textContent="▾";
        // default: open concept bubble
        closeSiblingBubbles(null);
        b1.classList.add("open");
      }

      function toggleRow(){
        var willOpen=!row.classList.contains("open");
        closeAllRows();
        if(willOpen){
          row.classList.add("open");
          chev.textContent="▾";
          closeSiblingBubbles(null);
          b1.classList.add("open");
        }
      }

      head.addEventListener("click", toggleRow);
      head.addEventListener("keydown", function(e){
        if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleRow(); }
      });

      row.appendChild(head);
      row.appendChild(body);
      list.appendChild(row);

      if(idx===0){
        openRow();
      }
    });

    applyFocus();
  }

  function applyFocus(){
    if(!focus) return;

    var engineSet={}; ENGINE.forEach(function(x){ engineSet[x]=true; });
    var platformSet={}; PLATFORM.forEach(function(x){ platformSet[x]=true; });

    if(platformSet[focus]){ side="platform"; }
    if(engineSet[focus]){ side="engine"; }

    paintPills();

    // re-render if lane changes
    band.textContent=bandLabel();

    setTimeout(function(){
      var el=document.getElementById("focus_"+focus);
      if(el){
        // open focused row
        closeAllRows();
        el.classList.add("open");
        var cv=el.querySelector(".chev"); if(cv) cv.textContent="▾";
        // open concept bubble by default
        var bubbles=el.querySelectorAll(".bubble");
        bubbles.forEach(function(b){ b.classList.remove("open"); });
        if(bubbles[0]) bubbles[0].classList.add("open");
        try{ el.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
      }
    }, 80);
  }

  // normalize lane from focus
  (function(){
    if(!focus) return;
    var platformSet={}; PLATFORM.forEach(function(x){ platformSet[x]=true; });
    if(platformSet[focus]) side="platform";
  })();

  paintPills();
  render();
})();
</script>

</body>
</html>
