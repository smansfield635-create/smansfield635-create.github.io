<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control · Geodiametrics</title>
  <link rel="stylesheet" href="/assets/ui.css"/>
</head>
<body class="bg-gradient">

<main class="page">

  <!-- Header -->
  <section class="panel hero">
    <h1>Control</h1>
    <p class="subtitle">
      Live, read-only state. Truth first. No actions forced.
    </p>
  </section>

  <!-- What this is -->
  <section class="panel">
    <h2>What this is</h2>
    <p class="muted">
      This page observes the system. It does not change it.
      Numbers move only when verified events occur.
    </p>
    <p class="muted">
      If something shows zero, it means “no receipt yet,” not “nothing happened.”
    </p>
  </section>

  <!-- Live status -->
  <section class="panel">
    <h2>Live status</h2>

    <div class="kv">
      <div><span class="k">Truth source</span><span class="v mono" id="truthUrl">—</span></div>
      <div><span class="k">Polling</span><span class="v mono" id="polling">10s</span></div>
      <div><span class="k">Last updated</span><span class="v mono" id="lastUpdated">—</span></div>
      <div><span class="k">Age (sec)</span><span class="v mono" id="ageSec">—</span></div>
    </div>

    <div class="badge-wrap">
      <span class="badge badge-yellow" id="healthBadge">HEALTH: —</span>
    </div>
  </section>

  <!-- Activity -->
  <section class="panel">
    <details open>
      <summary>Activity (what’s happening)</summary>

      <p class="muted small">
        These are conservative counts. They only increase when the website
        explicitly reports an event.
      </p>

      <div class="metric">
        <div class="metric-head">
          <span>Sessions</span><span class="mono" id="valSessions">0</span>
        </div>
        <div class="bar"><div class="fill" id="barSessions" data-level="zero"></div></div>
      </div>

      <div class="metric">
        <div class="metric-head">
          <span>Pageviews</span><span class="mono" id="valPageviews">0</span>
        </div>
        <div class="bar"><div class="fill" id="barPageviews" data-level="zero"></div></div>
      </div>

      <div class="metric">
        <div class="metric-head">
          <span>Clicks</span><span class="mono" id="valClicks">0</span>
        </div>
        <div class="bar"><div class="fill" id="barClicks" data-level="zero"></div></div>
      </div>

      <div class="metric">
        <div class="metric-head">
          <span>Writes</span><span class="mono" id="valWrites">0</span>
        </div>
        <div class="bar"><div class="fill" id="barWrites" data-level="zero"></div></div>
      </div>
    </details>
  </section>

  <!-- Sources -->
  <section class="panel">
    <details>
      <summary>Sources (to scale)</summary>

      <div class="metric">
        <div class="metric-head">
          <span>GitHub</span><span class="mono" id="srcGitHub">0</span>
        </div>
        <div class="bar"><div class="fill" id="barGitHub" data-level="zero"></div></div>
      </div>

      <div class="metric">
        <div class="metric-head">
          <span>OSF</span><span class="mono" id="srcOSF">0</span>
        </div>
        <div class="bar"><div class="fill" id="barOSF" data-level="zero"></div></div>
      </div>

      <div class="metric">
        <div class="metric-head">
          <span>Direct</span><span class="mono" id="srcDirect">0</span>
        </div>
        <div class="bar"><div class="fill" id="barDirect" data-level="zero"></div></div>
      </div>

      <div class="metric">
        <div class="metric-head">
          <span>Other</span><span class="mono" id="srcOther">0</span>
        </div>
        <div class="bar"><div class="fill" id="barOther" data-level="zero"></div></div>
      </div>

      <p class="muted small">
        Bars share one scale. Color intensity reflects relative magnitude.
      </p>
    </details>
  </section>

  <!-- Raw payload -->
  <section class="panel">
    <details>
      <summary>Raw payload (JSON)</summary>
      <pre class="pre mono" id="rawJson">—</pre>
    </details>
  </section>

  <!-- Navigation -->
  <section class="panel nav">
    <div class="nav-grid">
      <a class="btn" href="/home/">Home</a>
      <a class="btn" href="/">Landing</a>
      <a class="btn" href="/engine/">Engine</a>
      <a class="btn" href="/laws/">Laws</a>
      <a class="btn" href="/principles/">Principles</a>
      <a class="btn" href="/geodynamics/">Geodynamics</a>
      <a class="btn" href="/reference/">Reference</a>
      <a class="btn" href="/about/">About</a>
    </div>
  </section>

  <section class="panel footer">
    <div class="small muted">
      Build: 2026-02-01a · Canonical
    </div>
  </section>

</main>

<script>
(() => {
  const TRUTH = "https://geodiametrics-aggregator.smansfield635.workers.dev/metrics";
  const POLL_MS = 10000;

  const el = id => document.getElementById(id);
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  function setBar(barId, value, max){
    const bar = el(barId);
    const pct = max > 0 ? (value / max) * 100 : 0;
    bar.style.width = clamp(pct,0,100).toFixed(1) + "%";
    bar.dataset.level =
      value === 0 ? "zero" :
      pct < 33 ? "low" :
      pct < 66 ? "mid" : "high";
  }

  function setHealth(color){
    const b = el("healthBadge");
    b.textContent = "HEALTH: " + color;
    b.classList.remove("badge-green","badge-yellow","badge-red");
    b.classList.add(
      color === "GREEN" ? "badge-green" :
      color === "RED"   ? "badge-red"   : "badge-yellow"
    );
  }

  async function poll(){
    try{
      const res = await fetch(TRUTH, { cache:"no-store" });
      const data = await res.json();

      el("truthUrl").textContent = TRUTH;

      const m = data.metrics || {};
      const s = data.sources || {};

      const now = Date.now();
      const last = Number(m.lastUpdated || 0);
      const age = last ? Math.max(0, Math.floor((now-last)/1000)) : null;

      el("lastUpdated").textContent = last ? new Date(last).toLocaleString() : "—";
      el("ageSec").textContent = age !== null ? String(age) : "—";

      const sessions = Number(m.sessions||0);
      const pageviews = Number(m.pageviews||0);
      const clicks = Number(m.clicks||0);
      const writes = Number(m.writes||0);

      el("valSessions").textContent = sessions;
      el("valPageviews").textContent = pageviews;
      el("valClicks").textContent = clicks;
      el("valWrites").textContent = writes;

      const gh = Number(s.GitHub||0);
      const osf = Number(s.OSF||0);
      const direct = Number(s.Direct||0);
      const other = Number(s.Other||0);

      el("srcGitHub").textContent = gh;
      el("srcOSF").textContent = osf;
      el("srcDirect").textContent = direct;
      el("srcOther").textContent = other;

      const max = Math.max(1, sessions, pageviews, clicks, writes, gh, osf, direct, other);

      setBar("barSessions", sessions, max);
      setBar("barPageviews", pageviews, max);
      setBar("barClicks", clicks, max);
      setBar("barWrites", writes, max);

      setBar("barGitHub", gh, max);
      setBar("barOSF", osf, max);
      setBar("barDirect", direct, max);
      setBar("barOther", other, max);

      const status = String(data.status||"").toUpperCase();
      if (status === "OPERATIONAL" && (m.errors||0) === 0) setHealth("GREEN");
      else if (status === "DOWN") setHealth("RED");
      else setHealth("YELLOW");

      el("rawJson").textContent = JSON.stringify(data, null, 2);
    } catch {
      setHealth("RED");
      el("rawJson").textContent = "Unavailable";
    }
  }

  el("polling").textContent = (POLL_MS/1000) + "s";
  poll();
  setInterval(poll, POLL_MS);
})();
</script>

</body>
</html>
